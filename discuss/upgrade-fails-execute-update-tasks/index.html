<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  
<!-- Mirrored from community.aegirproject.org/discuss/upgrade-fails-execute-update-tasks by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 29 Jul 2015 15:01:47 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="canonical" href="index.html" />
<link rel="shortcut icon" href="../../sites/community.aegirproject.org/themes/up/favicon/index.ico" type="image/x-icon" />
    <link type="text/css" rel="stylesheet" media="all" href="../../profiles/openatrium/modules/contrib/codefilter/codefilter/index.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../../sites/community.aegirproject.org/files/css/css_b8ca3ff360daa12eff502993554e60d0/index.css" />
<link type="text/css" rel="stylesheet" media="screen" href="../../sites/community.aegirproject.org/files/css/css_c151a4313ed94e62ccee94ea27ad58ed/index.css" />
<link type="text/css" rel="stylesheet" media="print" href="../../sites/community.aegirproject.org/files/css/css_5fa73dc3677977c016a597acd186e4e7/index.css" />
<style type='text/css'>
.atrium-welcome-links a:hover,
.dropdown-blocks .block-toggle li a:hover,
.dropdown-blocks .block-toggle li a:focus,
.dropdown-blocks .block-toggle ul.links li a:hover,
.dropdown-blocks .block-toggle ul.links li a:focus,
.dropdown-blocks .block-toggle .item-list li a:hover,
.dropdown-blocks .block-toggle .item-list li a:focus,
.pager li.pager-current,
.more-link a:hover,
#global,
#navigation { background-color:#143352; }

body #space-tools .block-title { background-color:#0e2339; }

body #header .block-widget .block-content,
body #header .block .block-title { background-color:#112b45; }

body .page-region .block .block-title {
  background-color:#c2c8ce;
  border-color:#b4bbc1;
  border-bottom-color:#a7adb3;
  }

.drilldown .trail a {
  border-top-color:#f3f4f6;
  border-bottom-color:#d2d4d6;
  background-color:#e3e4e6;
  }

.decay-10 .comment-title { border-color:#eeeeee; }
.decay-9 .comment-title { border-color:#d8dbde; }
.decay-8 .comment-title { border-color:#c2c8ce; }
.decay-7 .comment-title { border-color:#acb5bf; }
.decay-6 .comment-title { border-color:#96a3af; }
.decay-5 .comment-title { border-color:#8190a0; }
.decay-4 .comment-title { border-color:#6b7d90; }
.decay-3 .comment-title { border-color:#556b80; }
.decay-2 .comment-title { border-color:#3f5871; }
.decay-1 .comment-title { border-color:#294561; }
.decay-0 .comment-title { border-color:#143352; }
</style>
    <script type="text/javascript" src="../../sites/community.aegirproject.org/files/js/js_dddbfcfef882b2074d904e22eb494d08/index.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/"});
//--><!]]>
</script>
    <!--[if lte IE 8]><style type='text/css' media='screen'>@import '/profiles/openatrium/themes/ginkgo/ie.css';</style><![endif]-->    <title>Upgrade Fails to Execute Update Tasks | community.aegirproject.org</title>
  </head>
  <body  class="not-front not-logged-in page-node node-type-discussion one-sidebar sidebar-right designkit tao rubik admin-static page">

  <a id='skipnav' href='#content'>Skip navigation</a>
  <div id='global'><div class='limiter clear-block'>
          <div id='header' class='dropdown-blocks toggle-blocks clear-block'>
          

<div  id="block-atrium-account" class="block block-atrium block-widget block-notitle">
  
  
      <div class='block-content clear-block '>
          </div>
  
  </div>


  

<div  id="block-boxes-search_issues" class="block block-boxes block-toggle">
      <div class='block-title'>
            <a href="index.html#block-boxes-search_issues" class="toggle element-invisible active">Toggle</a>LOOKING FOR HELP?    </div>
  
  
      <div class='block-content clear-block '>
      <div id='boxes-box-search_issues' class='boxes-box'><div class="boxes-box-content"><table class="prose">
<tr>
<td width="50%">
<span style="font-size:16px;width:100%">Type some keywords below and hit "enter":</span><br />
<input type="text" class="drupal-issue-redirect" style="width:100%;min-width:200px;background-color:#DDEEFF; font-size:30px;border-style:dotted;border-width:1px" />
<p>This will search the drupal.org issue queues across the various projects that make up the Aegir system. If there are no relevant results, please submit an issue there.</p></td>
<td style="padding:10px">Other support resources:
<ul>
<li><a href="irc://irc.freenode.net/aegir">#aegir on IRC</a></li>
<li><a href="../../faq/index.html">FAQ</a></li>
<li><a href="../../handbook/index.html">Aegir Handbook</a></li>
<li><a href="../../service-providers/index.html">Aegir service providers</a></li>
<li><a href="https://drupal.org/project/issues?text=&amp;projects=provision,+hosting,+hostslave,+eldir,+Hostmaster+(Aegir),Hosting+Platform+Pathauto&amp;status=Open&amp;priorities=All&amp;categories=All">All Aegir issues</a></li>
<li><a href="http://drupal.stackexchange.com/questions/tagged/aegir">Aegir tag on Drupal Stackexchange</a></li>
</ul>
</td>
</tr>
</table>
<script type="text/javascript">
$("input.drupal-issue-redirect").change(function() {
  searchURL= "http://drupal.org/project/issues?text="+$(this).val()+"&projects=provision,+hosting,+hostslave,+eldir,+Hostmaster+(Aegir),Hosting+Platform+Pathauto&status=Open&priorities=All&categories=All";
  window.location = searchURL;
});
</script></div></div>    </div>
  
  </div>


      </div>
        <div class='breadcrumb'><span class='link link-0'><a href="../../index.html">Home</a></span></div>    <a href="../../index.html" class="logo" style="background-position:100% 50%; background-image:url(../%27http_/community.aegirproject.org/sites/community.aegirproject.org/files/imagecache/designkit-image-logo/logo/index.html)"></a>  </div></div>

    <div id='navigation'><div class='limiter clear-block'>
    <ul id="features-menu" class="links primary-links"><li class="menu-617 first"><a href="../../dashboard/index.html" class=" icon-dashboard"><span class='icon'></span><span class='label'>Dashboard</span></a></li>
<li class="menu-618"><a href="../../handbook/index.html" class=" icon-handbook"><span class='icon'></span><span class='label'>Documentation</span></a></li>
<li class="menu-2427 active"><a href="../../discussion/index.html" class="active icon-discussion"><span class='icon'></span><span class='label'>Discussion</span></a></li>
<li class="menu-2426"><a href="../../calendar/index.html" class="spaces-menu-editable icon-calendar"><span class='icon'></span><span class='label'>Calendar</span></a></li>
<li class="menu-823"><a href="../../reader/index.html" class=" icon-reader"><span class='icon'></span><span class='label'>Feed reader</span></a></li>
<li class="menu-2429 last"><a href="../../members/index.html" class=" icon-members"><span class='icon'></span><span class='label'>Members</span></a></li>
</ul>          <div id='space-tools'><div class='dropdown-blocks toggle-blocks clear-block'>  

<div  id="block-atrium-search" class="block block-atrium block-toggle">
      <div class='block-title'>
            <a href="index.html#block-atrium-search" class="toggle element-invisible active">Toggle</a><span class='icon'></span> Search    </div>
  
  
      <div class='block-content clear-block '>
      <form action="http://community.aegirproject.org/discuss/upgrade-fails-execute-update-tasks"  accept-charset="UTF-8" method="post" id="atrium-search-form">
<div><div  class="form-item form-item-labeled" id="edit-search-wrapper">
      <label  for="edit-search">Search: <span class='form-required' title='This field is required.'>*</span></label>
    <input type="text" maxlength="128" name="search" id="edit-search" value="" class="form-text required fluid" />  </div>
<input type="submit" name="op" id="edit-submit" value="Search"  class="form-submit" />
<input type="hidden" name="form_build_id" id="form-ZSWhdqwNO34Fr2P-DTFBkBW_oOLBKY3p3RhB40ilM3M" value="form-ZSWhdqwNO34Fr2P-DTFBkBW_oOLBKY3p3RhB40ilM3M"  />
<input type="hidden" name="form_id" id="edit-atrium-search-form" value="atrium_search_form"  />

</div></form>
    </div>
  
  </div>


</div></div>
      </div></div>
  
  <div id='page-tools'><div class='limiter clear-block'>
    <h1  class="page-title page-title-hidden">Upgrade Fails to Execute Update Tasks</h1>        <a href="index.html#block-atrium-help" id="help-toggler" class="palette-toggle active">Help</a>          </div></div>

  
  
  <div id='page'><div class='limiter clear-block'>
    
<div id='content'><div class='page-region'>
      <div class='page-content content-wrapper clear-block'>

<div  id="node-13002" class="node node-discussion clear-block node-page">
      <div class='node-submitted clear-block'>
      <div class="picture">
  <a href="../../users/km/index.html" title="View user profile."><img src="../../sites/community.aegirproject.org/files/imagecache/user-s/profiles/openatrium/themes/ginkgo/images/user/index.png" alt="km&#039;s picture" title="View user profile." width="30" height="30" class="imagecache imagecache-user-s"/></a></div>
      <div class='byline'><a href="../../users/km/index.html" class="username" title="View user profile.">km</a></div><div class='date'>2:46pm Mar 17, 2015</div>    </div>
  
      <h2 class='node-title'>
            <a href="index.html">Upgrade Fails to Execute Update Tasks</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_597 first last"><a href="../../category/keywords/upgrade-21/index.html" rel="tag" title="">upgrade-2.1</a></li>
</ul></div><p>We recently attempted an upgrade from 1.6 to 1.12, and then to 2.1. The upgrade to 1.12 went fine, but we ran the upgrade script for 2.1, we started to see errors like these:</p>

<pre>
...
Do you wish to run all pending updates? (y/n): y
Executing hosting_alias_update_6203                                                                                      [success]
ALTER TABLE {hosting_site_alias} CHANGE `redirection` `redirection` VARCHAR(255) NOT NULL                                [success]
Executing hosting_alias_update_6204                                                                                      [success]
Unknown column 'db_name' in 'field list'                                                             [warning]
query: SELECT client, db_server, db_name, platform, profile, language as site_language, last_cron, cron_key, status AS
site_status, verified FROM hosting_site WHERE vid = 1065 database.mysqli.inc:134
...
Duplicate entry '127' for key 'PRIMARY'                                                              [warning]
query: UPDATE hosting_ip_addresses SET id=127 WHERE nid=707 AND ip_address='10.10.15.23'
database.mysqli.inc:134
...
UPDATE {hosting_ip_addresses} SET id=223 WHERE nid=836 AND ip_address='10.10.11.21'                 [error]
...
</pre>

<p>Even though the ALTER TABLE line above states it is a "success", examining the hosting_site_alias table, shows that the redirection field is still a TINYINT. Further, the error "<code>Unknown column &#039;db_name&#039; in &#039;field list&#039;</code>"  error appears way before the ALTER TABLE for <code>hosting_site</code> table -- so there is some statements executed out of sequence, perhaps?</p>

<p>Anyone come across an issue like this during upgrade? How might one go about addressing these issues? We've checked DB permissions, and they are all fine -- after all the upgrade to 1.12 went fine. Nothing unusual on the DB server logs.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../user/login/index-275.html?destination=node%2F13002%23comment-form">Login</a> or <a href="../../user/register/index-275.html?destination=node%2F13002%23comment-form">register</a> to post comments</span></li>
<li class="print last active"><a href="index-2.html?print" class="active">Print</a></li>
</ul></div>
  </div>


<div id="comments">
  <a id="comment-2385"></a>


<div  id="comment-2385" class="comment comment-published clear-block decay-10 decay-10">
      <div class='comment-submitted clear-block'>
      <div class="picture">
  <a href="../../users/helmo/index.html" title="View user profile."><img src="../../sites/community.aegirproject.org/files/imagecache/user-s/profiles/openatrium/themes/ginkgo/images/user/index.png" alt="helmo&#039;s picture" title="View user profile." width="30" height="30" class="imagecache imagecache-user-s"/></a></div>
      <div class='byline'><a href="../../users/helmo/index.html" class="username" title="View user profile.">helmo</a></div><div class='date'>8:43am Mar 18, 2015</div>    </div>
  
      <h2 class='comment-title'>
            <a href="index.html#comment-2385" class="active">#1</a>    </h2>
  
      <div class='comment-content clear-block prose'>
      <p>Well,
hosting_alias_update_6204() does call node_load which used the new db_name column.
So we have to make sure that hosting_site_update_6202() runs before that.</p>

<p>I was already looking at hook_update_dependencies() but that only in D7... :(</p>

<p>The easiest fix is to manually manually add the db_name column as a varchar 64 in the hosting_site table and comment out the lines in hosting_site_update_6202() to prevent an error there.</p>    </div>
  
      <div class='comment-links clear-block'><ul class="links"><li class="comment_forbidden first last"><span><a href="../../user/login/index-275.html?destination=node%2F13002%23comment-form">Login</a> or <a href="../../user/register/index-275.html?destination=node%2F13002%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>


<a id="comment-2387"></a>


<div  id="comment-2387" class="comment comment-published clear-block decay-0 decay-0">
      <div class='comment-submitted clear-block'>
      <div class="picture">
  <a href="../../users/km/index.html" title="View user profile."><img src="../../sites/community.aegirproject.org/files/imagecache/user-s/profiles/openatrium/themes/ginkgo/images/user/index.png" alt="km&#039;s picture" title="View user profile." width="30" height="30" class="imagecache imagecache-user-s"/></a></div>
      <div class='byline'><a href="../../users/km/index.html" class="username" title="View user profile.">km</a></div><div class='date'>3:45pm Mar 20, 2015</div>    </div>
  
      <h2 class='comment-title'>
            <a href="index.html#comment-2387" class="active">#2</a>    </h2>
  
      <div class='comment-content clear-block prose'>
      <p>In the seqence of events above, hosting_alias_update_6203 and hosting_alias_update_6204 run before hosting_site_update_6202.</p>

<p>It is a little disturbing that the scripts returns "success" for an update that did not occur, and runs an update out of order.</p>

<p>So you're telling me the upgrade script isn't working like it should? And that the updates need to run manually? Are there any options for debugging?</p>

<p>I've these changes, and various UPDATEs similar to what I posted above. Are there any other updates I need to run manually?</p>

<pre>
ALTER TABLE hosting_site_alias CHANGE `redirection` `redirection` VARCHAR(255) NOT NULL                                
ALTER TABLE hosting_context CHANGE `name` `name` VARCHAR(235) NOT NULL                                                 
ALTER TABLE hosting_package_instance ADD `platform` INT NOT NULL DEFAULT 0                                             
ALTER TABLE hosting_platform ADD `make_working_copy` INT unsigned NOT NULL DEFAULT 0                                   
ALTER TABLE hosting_platform DROP release_id                                                                           
ALTER TABLE hosting_ip_addresses DROP INDEX vid                                                                        
ALTER TABLE hosting_ip_addresses DROP vid                                                                              
ALTER TABLE hosting_ip_addresses ADD `id` INT unsigned auto_increment DEFAULT NULL, ADD PRIMARY KEY (id)               
ALTER TABLE hosting_ip_addresses CHANGE `id` `id` INT unsigned NOT NULL auto_increment                                 
ALTER TABLE hosting_ip_addresses ADD INDEX nid (nid)                                                                   

CREATE TABLE hosting_ssl_cert_ips
`cid` INT unsigned NOT NULL DEFAULT 0,
`ip_address` INT unsigned NOT NULL DEFAULT 0,
INDEX cid (cid),
INDEX ip_address (ip_address)
) /*!40100 DEFAULT CHARACTER SET utf8 */
Executing hosting_server_update_6202
INSERT INTO hosting_ssl_cert_ips (cid, ip_address)
  SELECT cert.cid,server_ip.id FROM hosting_ssl_site ssl_site
    INNER JOIN hosting_ssl_cert cert ON cert.cid = ssl_site.ssl_key
    INNER JOIN hosting_ip_addresses site_ip ON site_ip.nid = ssl_site.nid
    INNER JOIN hosting_site site ON site.nid = ssl_site.nid
    INNER JOIN hosting_ip_addresses server_ip ON server_ip.ip_address =
site_ip.ip_address
    INNER JOIN hosting_platform p ON site.platform = p.nid AND p.web_server
= server_ip.nid
    WHERE ssl_enabled &gt; %d AND site.status &gt; %d GROUP BY cid

ALTER TABLE hosting_site ADD `db_name` VARCHAR(64) NOT NULL DEFAULT '' 
</pre>    </div>
  
      <div class='comment-links clear-block'><ul class="links"><li class="comment_forbidden first last"><span><a href="../../user/login/index-275.html?destination=node%2F13002%23comment-form">Login</a> or <a href="../../user/register/index-275.html?destination=node%2F13002%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>


<a id="comment-2388"></a>


<div  id="comment-2388" class="comment comment-published clear-block decay-0 decay-0">
      <div class='comment-submitted clear-block'>
      <div class="picture">
  <a href="../../users/helmo/index.html" title="View user profile."><img src="../../sites/community.aegirproject.org/files/imagecache/user-s/profiles/openatrium/themes/ginkgo/images/user/index.png" alt="helmo&#039;s picture" title="View user profile." width="30" height="30" class="imagecache imagecache-user-s"/></a></div>
      <div class='byline'><a href="../../users/helmo/index.html" class="username" title="View user profile.">helmo</a></div><div class='date'>3:54pm Mar 20, 2015</div>    </div>
  
      <h2 class='comment-title'>
            <a href="index.html#comment-2388" class="active">#3</a>    </h2>
  
      <div class='comment-content clear-block prose'>
      <p>The 'problem' has been addressed in Drupal 7 by being able to specify in which order update hooks execute.</p>

<p>I don't think you need to run more updates manually, as e.g. hosting_alias_update_6203 does not call node_load.</p>    </div>
  
      <div class='comment-links clear-block'><ul class="links"><li class="comment_forbidden first last"><span><a href="../../user/login/index-275.html?destination=node%2F13002%23comment-form">Login</a> or <a href="../../user/register/index-275.html?destination=node%2F13002%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>


</div>
</div>
    </div></div>
<div id='right'><div class='page-region'>
    

<div  id="block-boxes-search_issues" class="block block-boxes">
      <div class='block-title'>
            LOOKING FOR HELP?    </div>
  
  
      <div class='block-content clear-block '>
      <div id='boxes-box-search_issues' class='boxes-box'><div class="boxes-box-content"><table class="prose">
<tr>
<td width="50%">
<span style="font-size:16px;width:100%">Type some keywords below and hit "enter":</span><br />
<input type="text" class="drupal-issue-redirect" style="width:100%;min-width:200px;background-color:#DDEEFF; font-size:30px;border-style:dotted;border-width:1px" />
<p>This will search the drupal.org issue queues across the various projects that make up the Aegir system. If there are no relevant results, please submit an issue there.</p></td>
<td style="padding:10px">Other support resources:
<ul>
<li><a href="irc://irc.freenode.net/aegir">#aegir on IRC</a></li>
<li><a href="../../faq/index.html">FAQ</a></li>
<li><a href="../../handbook/index.html">Aegir Handbook</a></li>
<li><a href="../../service-providers/index.html">Aegir service providers</a></li>
<li><a href="https://drupal.org/project/issues?text=&amp;projects=provision,+hosting,+hostslave,+eldir,+Hostmaster+(Aegir),Hosting+Platform+Pathauto&amp;status=Open&amp;priorities=All&amp;categories=All">All Aegir issues</a></li>
<li><a href="http://drupal.stackexchange.com/questions/tagged/aegir">Aegir tag on Drupal Stackexchange</a></li>
</ul>
</td>
</tr>
</table>
<script type="text/javascript">
$("input.drupal-issue-redirect").change(function() {
  searchURL= "http://drupal.org/project/issues?text="+$(this).val()+"&projects=provision,+hosting,+hostslave,+eldir,+Hostmaster+(Aegir),Hosting+Platform+Pathauto&status=Open&priorities=All&categories=All";
  window.location = searchURL;
});
</script></div></div>    </div>
  
  </div>


  

<div  id="block-views-discussion_comments-block_1" class="block block-views">
      <div class='block-title'>
            Recent comments    </div>
  
  
      <div class='block-content clear-block '>
      <div class="view view-discussion-comments view-id-discussion_comments view-display-id-block_1 view-dom-id-1">
    
  
  
      <div class="view-empty">
      <p>No recent comments found.</p>    </div>
  
  
  
  
  
  
</div>     </div>
  
  </div>


</div></div>

  </div></div>

    <div id="footer"><div class='limiter clear-block'>
        <ul class="links"><li class="atrium first last"><a href="http://www.openatrium.com/" target="_blank">OpenAtrium.com</a></li>
</ul>  </div></div>
  
  <div id='palette'>  

<div  id="block-atrium-help" class="block block-atrium">
      <div class='block-title'>
            <span class='close'></span>Need help?    </div>
  
  
      <div class='block-content clear-block '>
      

<div  id="help-text" class="path-admin-help clear-block toggleable">
  
    
  
  
  
      <div class='help-content clear-block prose'>
      <span class='icon'></span><h3>Discussion</h3><p>The discussion area lets your team communicate by posting updates and discussing issues. It is a great place for sharing progress, discussing challenges, and exploring ideas.</p>
    </div>
  
  </div>


    </div>
  
  </div>


</div>
  
  </body>

<!-- Mirrored from community.aegirproject.org/discuss/upgrade-fails-execute-update-tasks by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 29 Jul 2015 15:01:48 GMT -->
</html>
