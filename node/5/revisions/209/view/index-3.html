<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<!-- Mirrored from community.aegirproject.org/node/5/revisions/209/view?print&book_recurse by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 29 Jul 2015 17:40:14 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="prev" href="../../../../522/index.html" />
<link rel="up" href="../../../../../content/aegir-handbook/index.html" />
<link rel="next" href="../../../../31/index.html" />
<link rel="prev" href="../../../../522/index.html" />
<link rel="up" href="../../../../../content/aegir-handbook/index.html" />
<link rel="next" href="../../../../31/index.html" />
<link rel="prev" href="../../../../522/index.html" />
<link rel="up" href="../../../../../content/aegir-handbook/index.html" />
<link rel="next" href="../../../../31/index.html" />
<link rel="canonical" href="index.html" />
<link rel="prev" href="../../../../../developing/index.html" />
<link rel="up" href="../../../../../developing/index.html" />
<link rel="next" href="../../../../185/index.html" />
<link rel="prev" href="../../../../31/index.html" />
<link rel="up" href="../../../../31/index.html" />
<link rel="next" href="../../../../186/index.html" />
<link rel="prev" href="../../../../185/index.html" />
<link rel="up" href="../../../../31/index.html" />
<link rel="next" href="../../../../../content/branch-and-tagging-conventions/index.html" />
<link rel="prev" href="../../../../186/index.html" />
<link rel="up" href="../../../../31/index.html" />
<link rel="next" href="../../../../385/index.html" />
<link rel="prev" href="../../../../../content/branch-and-tagging-conventions/index.html" />
<link rel="up" href="../../../../31/index.html" />
<link rel="next" href="../../../../../developing/architecture/index.html" />
<link rel="prev" href="../../../../385/index.html" />
<link rel="up" href="../../../../../developing/index.html" />
<link rel="next" href="../../../../36/index.html" />
<link rel="prev" href="../../../../../developing/architecture/index.html" />
<link rel="up" href="../../../../../developing/architecture/index.html" />
<link rel="next" href="../../../../../architecture/aegir-architecture/index.html" />
<link rel="prev" href="../../../../36/index.html" />
<link rel="up" href="../../../../../developing/architecture/index.html" />
<link rel="next" href="../../../../77/index.html" />
<link rel="prev" href="../../../../../architecture/aegir-architecture/index.html" />
<link rel="up" href="../../../../../developing/architecture/index.html" />
<link rel="next" href="../../../../41/index.html" />
<link rel="prev" href="../../../../77/index.html" />
<link rel="up" href="../../../../../developing/architecture/index.html" />
<link rel="next" href="../../../../284/index.html" />
<link rel="prev" href="../../../../41/index.html" />
<link rel="up" href="../../../../../developing/architecture/index.html" />
<link rel="next" href="../../../../318/index.html" />
<link rel="prev" href="../../../../284/index.html" />
<link rel="up" href="../../../../../developing/architecture/index.html" />
<link rel="next" href="../../../../319/index.html" />
<link rel="prev" href="../../../../318/index.html" />
<link rel="up" href="../../../../318/index.html" />
<link rel="next" href="../../../../320/index.html" />
<link rel="prev" href="../../../../319/index.html" />
<link rel="up" href="../../../../318/index.html" />
<link rel="next" href="../../../../322/index.html" />
<link rel="prev" href="../../../../320/index.html" />
<link rel="up" href="../../../../318/index.html" />
<link rel="next" href="../../../../323/index.html" />
<link rel="prev" href="../../../../322/index.html" />
<link rel="up" href="../../../../318/index.html" />
<link rel="next" href="../../../../325/index.html" />
<link rel="prev" href="../../../../323/index.html" />
<link rel="up" href="../../../../318/index.html" />
<link rel="next" href="../../../../324/index.html" />
<link rel="prev" href="../../../../325/index.html" />
<link rel="up" href="../../../../../developing/architecture/index.html" />
<link rel="next" href="../../../../../developing/architecture/unix-group-limitations/index.html" />
<link rel="prev" href="../../../../324/index.html" />
<link rel="up" href="../../../../../developing/architecture/index.html" />
<link rel="next" href="../../../../494/index.html" />
<link rel="prev" href="../../../../../developing/architecture/unix-group-limitations/index.html" />
<link rel="up" href="../../../../../developing/architecture/index.html" />
<link rel="next" href="../../../../../contrib/index.html" />
<link rel="prev" href="../../../../494/index.html" />
<link rel="up" href="../../../../../developing/index.html" />
<link rel="next" href="../../../../../dev-cheat-sheet/index.html" />
<link rel="prev" href="../../../../../contrib/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../75/index.html" />
<link rel="prev" href="../../../../../dev-cheat-sheet/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../108/index.html" />
<link rel="prev" href="../../../../75/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../creating-product-features-using-uchosting-1x/index.html" />
<link rel="prev" href="../../../../108/index.html" />
<link rel="up" href="../../../../108/index.html" />
<link rel="next" href="../../../../../content/contrib/class-auto-loading/index.html" />
<link rel="prev" href="../../../../../creating-product-features-using-uchosting-1x/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../contrib/customizing-platform-templates/index.html" />
<link rel="prev" href="../../../../../content/contrib/class-auto-loading/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../content/contrib/passing-values-site-drushrcphp-file-during-migrations/index.html" />
<link rel="prev" href="../../../../../contrib/customizing-platform-templates/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../content/developing/integrating-aegir/index.html" />
<link rel="prev" href="../../../../../content/contrib/passing-values-site-drushrcphp-file-during-migrations/index.html" />
<link rel="up" href="../../../../../developing/index.html" />
<link rel="next" href="../../../../../content/content/developing/integrating-aegir/integrating-aegir-openssh/index.html" />
<link rel="prev" href="../../../../../content/developing/integrating-aegir/index.html" />
<link rel="up" href="../../../../../content/developing/integrating-aegir/index.html" />
<link rel="next" href="../../../../../content/content/developing/integrating-aegir/integrating-aegir-pureftp/index.html" />
<link rel="prev" href="../../../../../content/content/developing/integrating-aegir/integrating-aegir-openssh/index.html" />
<link rel="up" href="../../../../../content/developing/integrating-aegir/index.html" />
<link rel="next" href="../../../../../developing/continuous-integration/index.html" />
<link rel="prev" href="../../../../../content/content/developing/integrating-aegir/integrating-aegir-pureftp/index.html" />
<link rel="up" href="../../../../../developing/index.html" />
<link rel="next" href="../../../../../content/developing/despamming-guide/index.html" />
<link rel="prev" href="../../../../../developing/continuous-integration/index.html" />
<link rel="up" href="../../../../../developing/index.html" />
<link rel="next" href="../../../../../presentation/index.html" />
<link rel="shortcut icon" href="../../../../../sites/community.aegirproject.org/themes/up/favicon/index.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="print" href="../../../../../sites/community.aegirproject.org/files/css/css_5fa73dc3677977c016a597acd186e4e7/index.css" />
<link type="text/css" rel="stylesheet" media="all" href="../../../../../sites/community.aegirproject.org/files/css/css_5fa73dc3677977c016a597acd186e4e7/index.css" />

  <title>Revision of Developing for Aegir from Fri, 11/05/2010 - 19:36 | community.aegirproject.org</title>
</head>

<body  class="print rubik admin-static page">
  <div class='limiter clear-block'>
    <div id='content' class='clear-block'>
      <div class='print-header'>
      <h1 class='site-name'>community.aegirproject.org</h1>
  </div>
      

<div  id="node-5" class="node node-book clear-block node-page">
  
      <h2 class='node-title'>
            <a href="../../../../../developing/index.html">Developing for Aegir</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><div id='diff-inline-5'><div class='diff-inline-metadata clear-block'><div class='diff-inline-byline'>Updated by <a href="../../../../../user/1/index.html" class="username" title="View user profile.">admin</a> on 11/05/2010 - 19:36</div><div class='diff-inline-legend clear-block'><label>Legend</label><span class='diff-added'>Added</span><span class='diff-changed'>Changed</span><span class='diff-deleted'>Deleted</span></div></div><p>Developing for Aegir</p></div>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-11.html?destination=node%2F5%23comment-form">Login</a> or <a href="../../../../../user/register/index-11.html?destination=node%2F5%23comment-form">register</a> to post comments</span></li>
<li class="print active"><a href="index-2.html?print" class="active">Print</a></li>
<li class="print_recurse active"><a href="index-3.html?print&amp;book_recurse" class="active">Print entire section</a></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-11.html?destination=node%2F5%23comment-form">Login</a> or <a href="../../../../../user/register/index-11.html?destination=node%2F5%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>



<div  id="node-31" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../31/index.html">Git repositories locations and instructions</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>The source code of Aegir is located on Drupal.org, as with the issue queues and release nodes.</p>

<p>Aegir is also made up of several separate components designed to work together, that are grouped in two main git repositories: hostmaster and provision. This page details those locations.</p>

<p>Newcomers to git should probably consult our <a href="../../../../185/index.html">git crash course</a> while people already familiar with git can have a reminder on how to use it within aegir through the <a href="../../../../186/index.html">basic git workflow</a> page.</p>

<h2>Repositories locations</h2>

<p>There are the URLs you can use to pull the repositories:</p>

<pre>
git clone <a href="http://git.drupal.org/project/provision.git" title="http://git.drupal.org/project/provision.git">http://git.drupal.org/project/provision.git</a>
git clone <a href="http://git.drupal.org/project/hostmaster.git" title="http://git.drupal.org/project/hostmaster.git">http://git.drupal.org/project/hostmaster.git</a>
</pre>

<p>Developers with push access to the repositories should pull via SSH.</p>

<pre>
git clone ssh://[username]@git.drupal.org/project/provision.git
git clone ssh://[username]@git.drupal.org/project/hostmaster.git
</pre>

<p>There is a web interface for your perusal at:</p>

<ul>
<li><a href="http://drupalcode.org/project/provision.git" title="http://drupalcode.org/project/provision.git">http://drupalcode.org/project/provision.git</a></li>
<li><a href="http://drupalcode.org/project/hostmaster.git" title="http://drupalcode.org/project/hostmaster.git">http://drupalcode.org/project/hostmaster.git</a></li>
</ul>

<p>The git repositories were hosted for a while on <a href="http://koumbit.org/">Koumbit's</a> servers, but were migrated back to Drupal.org during the <a href="../../../../385/index.html">great git.drupal.org migration</a>. Do not use git.aegirproject.org as it doesn't have the most recent commits and may be shutdown at any time.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-419.html?destination=node%2F31%23comment-form">Login</a> or <a href="../../../../../user/register/index-419.html?destination=node%2F31%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../31/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-185" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../185/index.html">A crash course in Git</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <h2>Clone a repo</h2>

<p>Let's take hostmaster:</p>

<p><div class="codeblock"><code>git clone http://git.drupalcode.org/project/hostmaster.git</code></div></p>

<p>If successful, you will have a hostmaster directory at the last state of development ('HEAD' in CVS speak, usually 'master' branch in git speak, though in our case this is <a href="../../../../524/index.html">now 6.x-1.x</a>).</p>

<h2>Check the status of the local git repository:</h2>

<p><div class="codeblock"><code>git status</code></div></p>

<h2>See the commit messages:</h2>

<p><div class="codeblock"><code>git log</code></div></p>

<h2>Check all 'releases'</h2>

<p><div class="codeblock"><code>git tag</code></div></p>

<h2>Create a new branch for your local development:</h2>

<p><div class="codeblock"><code>git checkout -b &lt;new_branch_name&gt;</code></div></p>

<h2>Create a new branch for development, based on an existing remote branch or tag</h2>

<p><div class="codeblock"><code>git checkout -b &lt;new_branch_name&gt; origin/&lt;branch_name&gt;</code></div></p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-194.html?destination=node%2F185%23comment-form">Login</a> or <a href="../../../../../user/register/index-194.html?destination=node%2F185%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-194.html?destination=node%2F185%23comment-form">Login</a> or <a href="../../../../../user/register/index-194.html?destination=node%2F185%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-186" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../186/index.html">Basic git workflow: committing and pushing</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>So say you have some work you want to do on the hostmaster module. You first need to clone the repository:</p>

<p><div class="codeblock"><code>git clone http://git.drupal.org/project/hostmaster.git</code></div></p>

<p>That will create a <code>hostmaster</code> directory with the whole history of the project, and a checkout of the "master" branch (which is the equivalent of CVS's "HEAD" in git).</p>

<p>You make some modifications to the code to fix a bug, and then, you make a commit. That commit will only be local for now, that's the way git works:</p>

<p><div class="codeblock"><code>vi hostmaster.profile<br />git commit -m &quot;#12345 fix the install profile to do X&quot; hostmaster.profile</code></div></p>

<p>Note that contrarily to subversion or CVS, you need to explicitly mention which file(s) you want to commit. You can also use the -a flag to commit all changes.</p>

<p>If you have write access to the repository, you can now push your changes straight into git. However, the git:// url above is readonly, so you will want to use SSH to push your changes. For that, we will have had to add your SSH public key to our repositories. You may also want to add a special "remote" repository to push your changes. You will need to do this only once (per repository):</p>

<p><div class="codeblock"><code>git remote add drupalorg ssh://[username]@git.drupal.org/project/hostmaster.git</code></div></p>

<p>You can now push your changes to that repository.</p>

<p><div class="codeblock"><code>git push drupalorg</code></div></p>

<p>If you do <em>not</em> have write access to the repository, you can send the Aegir developers patches by submitting them for review in the <a href="http://drupal.org/project/issues?text=&amp;projects=hosting,+provision,+eldir,+Hostmaster+(Aegir)&amp;status=Open&amp;priorities=All&amp;categories=All">Issue queues</a> (see the <a href="http://drupal.org/node/1054616">patch contributor guide on drupal.org</a> for more details) or by uploading them to your <a href="http://drupal.org/node/1053378">personnal sandbox</a>.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-420.html?destination=node%2F186%23comment-form">Login</a> or <a href="../../../../../user/register/index-420.html?destination=node%2F186%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../186/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-187" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/branch-and-tagging-conventions/index.html">Branch and tagging conventions</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>Aegir development makes a heavy use of branches to keep development stable. We use feature branches to do large development work and have release branches to keep stable releases maintained while development happen on the development branches.</p>

<script type="text/javascript">toc_collapse=0;</script><div class="toc" id="toc">
<div class="toc-title">Table of Contents<span class="toc-toggle-message">&nbsp;</span></div>
<div class="toc-list">
<ol>
	<li class="toc-level-1"><a href="#Summary"><span class="toc-number">1. </span>Summary</a></li>
	<li class="toc-level-1"><a href="#Branch_naming_conventions"><span class="toc-number">2. </span>Branch naming conventions</a>
<ol>
	<li class="toc-level-2"><a href="#Main_development_branch"><span class="toc-number">2.1. </span>Main development branch</a></li>
	<li class="toc-level-2"><a href="#Stable_release_branches"><span class="toc-number">2.2. </span>Stable release branches</a></li>
	<li class="toc-level-2"><a href="#Feature_branches"><span class="toc-number">2.3. </span>Feature branches</a></li>
</ol>
</li>
	<li class="toc-level-1"><a href="#Tag_naming_convention"><span class="toc-number">3. </span>Tag naming convention</a></li>
	<li class="toc-level-1"><a href="#CVS_and_git_history"><span class="toc-number">4. </span>CVS and git history</a></li>
</ol>
</div>
</div>

<h1 id="Summary">1. Summary</h1>

<ul>
<li>The current <strong>development branch</strong> is: 7.x-3.x</li>
<li>The current <strong>stable branch</strong> is: 6.x-2.x</li>
</ul>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h1 id="Branch_naming_conventions">2. Branch naming conventions</h1>

<p>All branches are either development branches, stable branches or feature branches. Development and stable branches have the same naming convention:  <code>6.x-2.x</code> or <code>7.x-3.x</code>. The only different between the two is that a stable branch is the branch where stable releases are published from.</p>

<p><em>Note</em>: since the <a href="../../../../385/index.html">great git.drupal.org migration</a>, we are back on Drupal.org and have been forced to change some of our naming convention, especially to include the core release number in the tag (so <code>6.x-2.x</code>), which is a source of confusion for our <code>provision</code> module which supports any Drupal core version.  See <a href="http://drupal.org/node/322626#comment-4116688">this issue on drupal.org</a> for followup.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Main_development_branch">2.1. Main development branch</h2>

<p>The main development branch is created after a fully stable release is published. For example, the <code>6.x-2.x</code> branch has been created when the 1.0 release was published. It is  a development branch until it is considered feature-complete and goes through the alpha/beta/rc release cycle, at which point it will be declared a stable branch and a new development branch will be created (<code>7.x-3.x</code> at that point).</p>

<p>The development branch is <strong>not stable</strong> and should <strong>not be used in production environments</strong>.</p>

<p><em>Note that we have <a href="../../../../524/index.html">dropped the master branch</a> as it is not well supported on Drupal.org for releases.</em></p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Stable_release_branches">2.2. Stable release branches</h2>

<p>Stable releases are performed from stable release branches. A branch is declared stable only after it went through the complete alpha/beta/rc release cycle, as detailed above..</p>

<p>Once the branch is declared stable, new releases are quickly done as "hotfixes", without intervening alpha/beta/rc releases. So for example, <code>6.x-1.0</code> will come after <code>6.x-1.0-alpha1</code>, <code>6.x-1.0-beta1</code>, <code>6.x-1.0-rc1</code> <em>at least</em>, and then be followed directly by <code>6.x-1.1</code>.</p>

<p>Releases on the same stable branch are API-compatible with each other (so <code>1.1</code> is compatible with <code>1.0</code>). The upgrade path is supported between major stable releases (so you can upgrade from <code>1.0</code> to <code>1.1</code> or <code>2.0</code>).</p>

<p><strong>Special case</strong>: during the 0.x release cycle, releases were not API-compatible with each other, ie. 0.4 was <em>not</em> compatible with 0.3, and you could barely upgrade from 0.3 to 0.4.</p>

<p>Only one stable branch is maintained at a time.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Feature_branches">2.3. Feature branches</h2>

<p>More complex development goes into development or "feature" branches, to avoid making <code>master</code> too unstable. Feature branches must be prefixed with "dev-" and use the issue number (if available or relevant) and a short name. So for example, there could be work on a <code>dev-12345-mybug</code> branch or <code>dev-dns</code> branch for a larger feature (DNS, in that case) which doesn't fit in a single issue.</p>

<p>Feature branches should be based of a known stable baseline as much as possible. For example, you should branch off the last alpha release if you want to make merging with other dev branches and master easier. See <a href="http://developers.slashdot.org/story/10/11/30/1649231/Linus-On-Branching-Practices">this article</a> for a thorough discussion on this practice</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h1 id="Tag_naming_convention">3. Tag naming convention</h1>

<p>Every release is tagged with a <code>6.x-x.y</code> tag (e.g. <code>6.x-0.4</code>, <code>6.x-0.4-alpha15</code> or <code>6.x-1.0</code>). Those tags are usually laid on the stable branches, except for alpha/beta/rc releases which are laid on the development branch.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h1 id="CVS_and_git_history">4. CVS and git history</h1>

<p>The CVS tags and branches are still accessible in git and will be kept there for posterity. They respect the traditional Drupal.org naming convention.</p>

<p>They have also been converted to the new git.drupal.org conventions during the <a href="../../../../385/index.html">great git.drupal.org migration</a>.</p>

<p>Since that migration (february 2011), history has been rewritten to clean up the authors in the history.</p><div class="toc-back-to-top"><a href="#toc">Back to top</a></div><script type="text/javascript">toc_scroll_back_to_top = 1;</script>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-195.html?destination=node%2F187%23comment-form">Login</a> or <a href="../../../../../user/register/index-195.html?destination=node%2F187%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-195.html?destination=node%2F187%23comment-form">Login</a> or <a href="../../../../../user/register/index-195.html?destination=node%2F187%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-385" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../385/index.html">The great git.drupal.org migration</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>After <a href="../../../../369/index.html">thorough discussions</a> where we weighted the pros and cons of profiting from the <a href="http://drupal.org/project/great_git_migration">Great Git Migration</a>, I think it's pretty clear that we have a great opportunity to migrate our source repositories back to Drupal.org. We will get:</p>

<ul>
<li>more visibility - people will find us through drupal.org easily</li>
<li>more consistency - versions in the issue queue matching the real releases</li>
<li>even more consistency - people will find the source better from drupal.org</li>
<li>and then more consistency - usage stats will work again!</li>
</ul>

<p>We will be able to:</p>

<ul>
<li>host our module and theme within the install profile - the major reason why we migrated away back then</li>
<li>use whatever naming convention we want for tags and branches - although only some will be used for releases for now, see <a href="http://drupal.org/node/322626#comment-4116688">this issue</a> for follow-up</li>
<li>keep our history - the <a href="http://groups.drupal.org/drupal-org-git-migration-team">git team</a> was nice enough to clone directly from our repositories (although see below, we're taking the opportunity of the migration to clean up our history)</li>
</ul>

<h1>What it means for you</h1>

<p>This does have an impact on your existing repositories. Since we migrated to git.drupal.org, the repositories have changed location. The other thing is that the commit IDs have changed, and you will need to clone new checkouts before you can work with them effectively.</p>

<p>So in short:</p>

<ul>
<li>repos will move to git.drupal.org</li>
<li>you need to clone again</li>
<li>make sure your identity is set correctly</li>
</ul>

<h1>URL changes</h1>

<p>So the repositories have moved. Everyone has to fetch the source code from <a href="http://git.drupal.org/">git.drupal.org</a> now. At some point in the future, <a href="http://koumbit.org/">Koumbit</a> will close <a href="../git.aegirproject/index.html">git.aegirproject.org</a>. Concretely, Koumbit will keep the mirror running readonly for a while just to be on the safe side, but you shouldn't expect git.aegirproject.org to work and should switch URLs, as detailed below.</p>

<p>This documentation is taken from the <a href="http://drupal.org/node/1054594">Drupal.org git workflows documentation</a>.</p>

<h2>Readonly repositories URL change</h2>

<p>The readonly access will change from:</p>

<p><div class="codeblock"><code>git://git.aegirproject.org/provision.git<br />git://git.aegirproject.org/hostmaster.git</code></div></p>

<p>to:</p>

<p><div class="codeblock"><code>http://git.drupal.org/project/provision.git<br />http://git.drupal.org/project/hostmaster.git</code></div></p>

<p>See also the <a href="http://drupal.org/node/1054616">git patch maintainer guide</a>.</p>

<h2>Core committers repositories URL change</h2>

<p>The read/write access will change from:</p>

<p><div class="codeblock"><code>ssh://gitosis@git.aegirproject.org/provision.git<br />ssh://gitosis@git.aegirproject.org/hostmaster.git</code></div></p>

<p>to:</p>

<p><div class="codeblock"><code>ssh://[username]@git.drupal.org/project/provision.git<br />ssh://[username]@git.drupal.org/project/hostmaster.git</code></div></p>

<p>... notice how you will need to set your Drupal.org username in the URL. Drupal.org has good documentation on <a href="http://drupal.org/node/1027094">how  authentication works on git.drupal.org</a>. See also <a href="http://drupal.org/node/1059322">the project maintainer git guide</a>.</p>

<h2>Sandboxes</h2>

<p>The migration to Drupal.org also introduces sandboxes, something we didn't have before, and which allows you to host your own branches of our modules (even if you're not a core committer) or contrib/test modules, directly on Drupal.org. See the <a href="http://drupal.org/node/1053378">sandbox collaboration guide</a> for more information on that.</p>

<h2>What if I pull/push from/to the wrong one?</h2>

<p>It could happen before/during/after the migration that you pull or push from or to the wrong repository. git can rebase with the new repository, but unfortunately, the old commits will be mingled with the new ones.</p>

<p>To be able to push to the new repositories, you will need to follow instructions below to cleanup your repositories.</p>

<h1>Rewriting history</h1>

<p>I have taken the liberty of rewriting our collective history. There were a lot of commits with inconsistent authors: some had invalid emails, some had no real names, some had multiple different email addresses for the same person. I narrowed the list down, through extensive detective work, to a complete list of 14 distinct authors.</p>

<p>I have rewritten all commit authors that didn't seem right to follow a consistent pattern:</p>

<p><div class="codeblock"><code>Firstname Lastname &lt;email&gt;</code></div></p>

<p>The firstname/lastname is the combination you have used in certain commits. It's not the most popular way (ie. most commits had the nickname instead of first/last), but it seems the most logical one.</p>

<p>The email was your most often used email or the one you have registered as such at drupal.org, if you didn't have an email address specified (in case you committed your code back in the days of CVS). (There are 6 commits from someone with a box at ovh.net that I could track, and that I can only guess are Miguel's, but I'm not sure so I have let those one fly. :)</p>

<p>You <strong>should</strong> make sure you have your <a href="http://drupal.org/node/1022156">identity set straight in your git configuration</a>, especially your email address, if you want your contributions to be properly credited in the future on Drupal.org. In short, this means:</p>

<p><div class="codeblock"><code>git config --global user.name &quot;User Name&quot;<br />git config --global user.email user@example.com</code></div></p>

<p>Again, see <a href="http://drupal.org/node/1022156">the manual</a> for more information, especially how this maps to your Drupal.org account.</p>

<h1>A fresh clone is necessary!!!!</h1>

<p>Note that, because we rewrote history, you will <strong>need</strong> to clone your repository from new remote. So yes, contrarily to what was documented here before, you will need to clone from scratch.</p>

<p>We understand this may be annoying if you work on a bunch of branches or have local branches you want to keep. Unfortunately, our original tests didn't cover all use cases and were misleading in thinking we could just rebase existing repositories.</p>

<h1>Other documentation</h1>

<p>People unfamiliar with git or specifically git on Drupal.org should read the <a href="http://drupal.org/documentation/git">growing git handbook</a> on Drupal.org.</p>

<p>People that <em>are</em> familiar with git should <em>contribute</em> to that manual. :)</p>

<h1>Under the hood</h1>

<p>The history rewrite was performed through git-fast-export and git-fast-import magic, with a fairly simple perl script of my own. I have cloned the current repo, filtered it and published a new version for git.drupal.org to pull. You can see the results here:</p>

<p><div class="codeblock"><code>http://git.aegirproject.org/?p=export/provision.git<br />http://git.aegirproject.org/?p=export/hostmaster.git</code></div></p>

<p>The exact calling sequence is this:</p>

<pre>
mkdir export orig
cd export
git init --bare hostmaster.git
cd ../orig
git clone --bare git://git.aegirproject.org/hostmaster
cd hostmaster.git
# look at the authors in the original repo
git fast-export --all |  grep -a '^author [^&lt;]* &lt;[^&gt;]*&gt; [0-9][0-9]* [+-][0-9][0-9][0-9][0-9]$' | sed 's/[0-9][0-9]* [+-][0-9][0-9][0-9][0-9]$//' | sort | uniq -c
git fast-export --all | perl /home/anarcat/bin/rewrite_authors.pl | ( cd ../../export/hostmaster.git ; git fast-import )
cd ../../export/hostmaster.git
# look at the authors in the new repo
git fast-export --all |  grep -a '^author [^&lt;]* &lt;[^&gt;]*&gt; [0-9][0-9]* [+-][0-9][0-9][0-9][0-9]$' | sed 's/[0-9][0-9]* [+-][0-9][0-9][0-9][0-9]$//' | sort | uniq -c
# rinse, repeat until the mapping is right
# push repositories online
git remote add origin ssh://gitosis@git.aegirproject.org/export/hostmaster.git
git push --all
git push --tags
# repeat with provision
</pre>

<p>This is the script source, without all the mappings:</p>

<pre>
#! /usr/bin/perl -w

%authors = ( 
    'anarcat ' =&gt; 'Antoine Beaupré ',
   # ... 
);

sub remap {
    my $a = shift;
    if ($authors{$a}) {
        return $authors{$a};
    } else {
        return $a;
    }
}

while (&lt;&gt;) {
    s#^author ([^&lt;]+ &lt;[^&gt;]+&gt;) ([0-9]+ [+-][0-9][0-9][0-9][0-9])$#'author ' . remap($1) . ' ' . $2#e;
    print;
}
</pre>

<h2>Migration checklist</h2>

<ol>
<li>serve exported repositories to migration team <strong>done!</strong></li>
<li>update the repositories with change authors <strong>done!</strong></li>
<li><a href="http://drupal.org/project/great_git_migration">the great git migration</a> <strong>done!</strong> git.aegirproject.org is now readonly, commits are pushed to git.drupal.org and releases are performed on drupal.org</li>
<li>update documentation in <a href="../../../../../handbook/index.html">handbook</a> <em>in progress!</em>

<ul>
<li><a href="../../../../31/index.html">repositories locations</a> <strong>done</strong></li>
<li><a href="../../../../185/index.html">crash course</a> <strong>done</strong></li>
<li><a href="../../../../186/index.html">basic workflow</a> <strong>done</strong></li>
<li><a href="../../../../32/index.html">release process</a> <strong>needs review</strong> - updated for release nodes stuff, will check workflow during the next release</li>
<li><a href="../../../../187/index.html">advanced workflow: branch naming conventions</a> <strong>in progress</strong> - see <a href="http://drupal.org/node/1074876">0.4-rc2 release coordination</a></li>
<li><a href="../../../../377/index.html">migration of the install docs into the handbook work</a> <strong>in progress</strong></li>
</ul></li>
<li>update the <a href="http://www.aegirproject.org/">home page links</a> <strong>done</strong> - I have changed the link in the body from git.aegirproject.org to drupal.org provision/hostmaster project pages, and pointed the "Get the source" link in the bottom to the install manual instead</li>
<li>update makefiles and files in docs/* in provision to fetch from git.drupal.org <strong>done!</strong></li>
<li>make at least one other release <strong>done</strong> - <a href="http://drupal.org/node/1074876">0.4-rc2 release coordination</a></li>
<li>turn off git.aegirproject.org <strong>done</strong></li>
</ol>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-196.html?destination=node%2F385%23comment-form">Login</a> or <a href="../../../../../user/register/index-196.html?destination=node%2F385%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-196.html?destination=node%2F385%23comment-form">Login</a> or <a href="../../../../../user/register/index-196.html?destination=node%2F385%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-78" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../developing/architecture/index.html">Architecture Guide</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>This section deals with providing coherence and understanding of various aspects of Aegir - what it is, and what it is not.</p>

<p>It tries to explain some of the concepts with which Aegir is developed for and how all the bits hook together.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-197.html?destination=node%2F78%23comment-form">Login</a> or <a href="../../../../../user/register/index-197.html?destination=node%2F78%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-197.html?destination=node%2F78%23comment-form">Login</a> or <a href="../../../../../user/register/index-197.html?destination=node%2F78%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-36" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../36/index.html">Aegir design and terminology</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_3 first"><a href="../../../../../taxonomy/term/3/index.html" rel="tag" title="This level is for users, who are using hosted Aegir version, without access to the server root, with features limited to those allowed by their host, and often with Aegir UI changed/simplified.">Hosted</a></li>
<li class="taxonomy_term_2 last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>@TODO - this document is out of date and needs updating.</p>

<p>This page documents all the different terms used when referring to components of the Hostmaster system, and how the different entities relate to each other.</p>

<h4>Front End</h4>

<p>The user interface used to administrate your sites. The front end is provided by the Hostmaster install profile, and the Hosting contributed module. It defines a complete Drupal based data model for managing the various aspects of your installation.</p>

<h4>Entities</h4>

<p>These entities are used primarily in the front end to manage the configuration and data. Upon calling the back end, the system breaks
down the properties of these entities to be passed as options for the command line, so the back end only has a flat data structure to
work with. During this process, all relationships are automatically retrieved, making it a one step process for the developer.</p>

<dl>
<dt><a name='glossary-client'></a>Client</dt><dd><strong>The person or group that runs the site.</strong> 
                This information is usually required for billing and access purposes, to assure
                that only certain people are able to view the information for sites they run. 
                If you do not intend on having more than one client access the system, 
                you will not need to create any additional clients for your purposes.</dd>

<dt><a name='glossary-site'></a>Site</dt><dd><strong>An instance of a hosted site.</strong>
                It contains information relating to the site, most notably the domain name, database server 
                and platform it is being published on. A site may also have several aliases for additional
                domains the site needs to be accessible on.</dd>

<dt><a name='glossary-task'></a>Task</dt><dd><strong>The mechanism whereby Hostmaster keeps track of all changes that occur to the system.</strong>
                Each task acts as a command for the back end, and contains a full log of all changes that have occurred.
                If a task should fail, the administrator will be notified with an explanation of exactly what went wrong,
                and how to fix it.</dd>

<dt><a name='glossary-platform'></a>Platform</dt><dd><strong>The file system location on a specific web server on which to publish sites.</strong>
                Multiple platforms can co-exist on the same web server, and need to do so for
                upgrades to be managed, as this is accomplished by moving the site to a platform
                hosting an updated release.
                Platforms are most commonly built for specific releases of Drupal.</dd>

<dt><a name='glossary-server'></a>Server</dt><dd><strong>The server that provides various services.</strong>

<dt><a name='glossary-service'></a>Service</dt><dd><strong>The service that runs on the server.</strong> This might be HTTP or a Database server.
                Each web server hosts one or more platforms, which act as publishing points for the hosted sites.
                If you are not intending to use Hostmaster in a distributed fashion, you will not need to create
                additional web servers for your purposes.

                Most web servers and database servers are on the same machine, but for performance reasons 
                external database servers might be required. It is not uncommon for one database server
                to be shared amongst all site instances.
                If you are not intending to use an external database server, or multiple database servers, you
                will not need to create any additional database servers for your purposes.</dd>

<dt><a name='glossary-service_type'></a>Service type</dt><dd><strong>The type of service that runs on the server.</strong> In the example of 'HTTP' as a service, a service *type* is Apache or Nginx, for example. MySQL is a *type* of service 'Database'.</dd>

<dt><a name='glossary-package'></a>Package</dt><dd><strong>An installable component for a site.</strong>
  Hostmaster keeps tracks of all the modules, themes and install profiles installed across your entire network.
  These packages most commonly link to their project on drupal.org, but might not in the case of custom modules.
  Users are not able to create nodes of this type, as they are generated automatically during verify and sync tasks.
</dd>

<dt><a name='glossary-package_release'></a>Package Release</dt><dd><strong>The release of a specific package.</strong>
  Each package on your network has at least one installed release, and each platform (including Drupal itself) may
  have several releases installed across your network.
</dd>

<dt><a name='glossary-db_server'></a>Package Instance</dt><dd><strong>Where a package release has been installed.</strong>
  A package release may be installed in multiple places on a platform, and sites may have access to multiple versions of packages.
  This entity also tracks which modules are enabled, and what version of the schema (if any) they have installed.
</dd>

</dd></dl>

<p><img src="http://groups.drupal.org/files/HostmasterERD3.png" /></p>

<h4>Task types</h4>

<p>These are "hosting commands" that the server can accomplish. These are mapped to back end commands by the task queue processor.</p>

<dl>

<dt>Verify platform</dt>
<dd>Verify that a platform is correctly installed. Automatically created when new platforms are added, to ensure that they are capable of having new sites installed on them. Operates on: <strong>platforms</strong></dd>

<dt>Import sites</dt>
<dd>Import existing sites onto a platform.  Operates on: <strong>platforms</strong></dd>

<dt>Install site</dt>
<dd>Install a new site. This is automatically generated when a site node is created.  Operates on: <strong>sites</strong></dd>

<dt>Sync site</dt>
<dd>Synchronize changes to the site record with the back end. Automatically generated on editing of the site node.  Operates on: <strong>sites</strong></dd>

<dt>Backup site</dt>
<dd>Generate a backup of an existing site. This backup contains everything needed to run the site.  Operates on: <strong>sites</strong></dd>

<dt>Restore backup</dt>
<dd>Restore a site to a previous backed up version. Operates on: <strong>sites</strong></dd>

<dt>Disable site</dt>
<dd>Disable a running site. This is commonly used in the case of non-payment from clients. Operates on: <strong>sites</strong></dd>

<dt>Enable site</dt>
<dd>Enable a disabled site. The opposite of Disable. Operates on: <strong>sites</strong></dd>

</dl>

<p><strong>This is an incomplete list, and will be updated as more tasks are added</strong></p>

<h4>Queues</h4>

<p>The front end uses and maintains several queues, which are then processed through the <code>drush.php hosting dispatch</code> command.
More queues can be added by optional contributed modules, and are often used to provide regularly scheduled back end commands, 
such as backing up sites.</p>

<dl>
<dt>Task Queue</dt>
<dd>The primary and most important queue. Whenever a change is made to the data set, the front end creates a "Task" node. These task relate to such things as installing new sites, regenerating the configuration files of sites, verifying that a platform has been correctly configured and importing existing sites on a newly added platform.</dd>

<dt>Cron Queue</dt>
<dd>This queue is used to manage the regular execution of the cron process required by most sites. It is configurable with a frequency you want all the sites to be cronned within. This is commonly 1 hour, but might be higher or lower. Higher frequency will cause higher system load. This command will iterate through all enabled sites, and batch the cron calls, based on how many sites are available, and how frequently it is running.</dd>

<dt>Backup Queue</dt>
<dd>This queue operates in the same way as the cron queue, in that it iterates through all installed sites, based on a configurable frequency. This executes the same functionality as requesting a site backup through the user interface. You are able to revert back 
to a previous backup of your sites.</dd>

<dt>Statistics Queue</dt>
<dd>This queue operates on the same mechanism as the cron queue, and alows you to retrieve statistics of your installed sites. This will retrieve such metrics as number of registered and active users, and number of posts / comments, which will then be viewable on the front end.</dd>
</dl>

<h4>Back End</h4>

<p>The back end is a command line interface provided by the Provisioning Framework, of all the tasks it is capable of performing.</p>

<p>It is designed to operate separately from the front end, so that you can have multiple back ends on one or more servers.</p>

<p>The back end handles the server level configuration of the system, such as creating new databases and virtual host records and
restarting the apache process for new installations to take effect.</p>

<p>When the queues are processed by the front end, these are turned into calls to the back end, for whichever server they happen
to be on. The back end communicates to the front end through a very simple mechanism, whereby it returns a serialized string containing state information and log messages / error return codes.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-421.html?destination=node%2F36%23comment-form">Login</a> or <a href="../../../../../user/register/index-421.html?destination=node%2F36%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../36/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-76" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../architecture/aegir-architecture/index.html">Aegir Architecture</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>This wiki page documents the Aegir architecture in schematic form. It is intented to complement a <a href="../../../../77/index.html">related page on the typical file system structure</a> on an Aegir installation.</p>

<p><a href="../../../../../sites/community.aegirproject.org/files/aegir-architecture-multiserver-2010-09-29/index.png"><img src="../../../../../sites/community.aegirproject.org/files/aegir-architecture-multiserver-2010-09-29-640/index.png" /></a></p>

<p>Click on image for a larger version.</p><div class="itu-attachments"><table class="itu-attachment-list withoutstats sticky-enabled" id="attachments">
 <thead><tr><th class="preview">Preview</th><th class="file">Attachment</th><th class="size">Size</th> </tr></thead>
<tbody>
 <tr class="odd"><td class="mime mime-png"><div  class="form-item" id="">
    <div class="itu-attachment-thumb"><a href="../../../../../sites/community.aegirproject.org/files/aegir-architecture-multiserver-2010-09-29/index.png" title="aegir-architecture-multiserver-2010-09-29.png"><img src="../../../../../sites/community.aegirproject.org/files/imagecache/AttachmentThumbnail/aegir-architecture-multiserver-2010-09-29/index.png" alt="aegir-architecture-multiserver-2010-09-29.png" title="aegir-architecture-multiserver-2010-09-29.png" width="60" height="60" class="imagecache imagecache-AttachmentThumbnail"/></a></div>  </div>
</td><td class="file"><a href="../../../../../sites/community.aegirproject.org/files/aegir-architecture-multiserver-2010-09-29/index.png">aegir-architecture-multiserver-2010-09-29.png</a></td><td class="size">246.43 KB</td> </tr>
 <tr class="even"><td class="mime mime-pdf"></td><td class="file"><a href="../../../../../sites/community.aegirproject.org/files/aegir-architecture-2010-09-29/index.pdf">aegir-architecture-2010-09-29.pdf</a></td><td class="size">174.58 KB</td> </tr>
</tbody>
</table>
</div>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-198.html?destination=node%2F76%23comment-form">Login</a> or <a href="../../../../../user/register/index-198.html?destination=node%2F76%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-198.html?destination=node%2F76%23comment-form">Login</a> or <a href="../../../../../user/register/index-198.html?destination=node%2F76%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-77" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../77/index.html">Aegir file system structure</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>This page documents the typical file system structure on an Aegir installation. It is intended to complement a related wiki page on <a href="../../../../76/index.html">Aegir Architecture</a>. The following paths are based on an Aegir 0.4-x installation and assume that all directories are within the /var/aegir folder.</p>

<h3>Scripts and Configuration Files</h3>

<table>
<tr><th>Path</th><th>Notes</th></tr>
<tr><td>/backups</td><td>site-specific tar balls containing a database dump and folders under path/to/platform/sites/example.com</td></tr>
<tr><td>/config</td><td></td></tr>
<tr><td>/config/server_master</td><td></td></tr>
<tr><td>/config/server_master/apache</td><td></td></tr>
<tr><td>/config/server_master/apache/conf.d</td><td>non-aegir or non-drupal virtual hosts files</td></tr>
<tr><td>/config/server_master/apache/platform.d</td><td>contains .htaccess information for each aegir platform</td></tr>
<tr><td>/config/server_master/apache/vhost.d</td><td>apache virtual host files for aegir platforms</td></tr>
<tr><td>/config/server_master/apache/vhost.d/aegir.example.com</td><td>virtual host file for aegir web site - specifies path to platform directory and site database settings (so that database credentials are not exposed directly in site settings.php file) </td></tr>
<tr><td>/config/server_master/apache/vhost.d/site-1.com</td><td>virtual host file for deployed web site</td></tr>
<tr><td>/config/server_master/apache/vhost.d/site-2.com</td><td></td></tr>
<tr><td>/config/server_master/apache/vhost.d/site-3.com</td><td></td></tr>
<tr><td>/<a href="http://drupal.org/project/drush" title="link to drush project on drupal.org">drush</a></td><td>drush folder</td></tr>
<tr><td>/drush/drush.php </td><td>drush script</td></tr>
<tr><td>/.drush</td><td>drush extensions and server, platform and site aliases</td></tr>
<tr><td>/.drush/<a href="http://drupal.org/project/drush_make" title="link to drush_make project on drupal.org">drush_make</a></td><td>drush_make project folder - used for building web sites from .make files</td></tr>
<tr><td>/.drush/<a href="http://drupal.org/project/provision" title="link to provision project on drupal.org">provision<a /></a></a></td><td>provision folder</td></tr>
<tr><td>/.drush/server_master.alias.drushrc.php</td><td>settings for the master server where the main aegir database, hosting platform and aegir site reside</td></tr>
<tr><td>/.drush/platform_hostmaster.alias.drushrc.php</td><td>settings for the hostmaster platform on which the aegir site is based</td></tr>
<tr><td>/.drush/hostmaster.alias.drushrc.php</td><td>settings for the aegir site</td></tr>
<tr><td>/.drush/platform_platform1.alias.drushrc.php</td><td>settings for platform1 on which site-1.com is based</td></tr>
<tr><td>/.drush/site-1.com.alias.drushrc.php</td><td>settings for site-1.com</td></tr>
</table>

<table>
<h3>Hostmaster Platform and Aegir (front-end) Site</h3>
<tr><th>Path</th><th>Notes</th></tr>
<tr><td>/hostmaster-0.x</td><td>hostmaster platform</td></tr>
<tr><td>/hostmaster-0.x/profiles</td><td></td></tr>
<tr><td>/hostmaster-0.x/profiles/default</td><td></td></tr>
<tr><td>/hostmaster-0.x/profiles/<a href="http://drupal.org/project/hostmaster" title="link to hostmaster distribution on drupal.org">hostmaster</a></td><td>hostmaster profile</td></tr>
<tr><td>/hostmaster-0.x/profiles/hostmaster/modules</td><td></td></tr>
<tr><td>/hostmaster-0.x/profiles/hostmaster/modules/admin_menu</td><td></td></tr>
<tr><td>/hostmaster-0.x/profiles/hostmaster/modules/<a href="http://drupal.org/project/hosting" title="link to hostmaster project on drupal.org">hosting</a></td><td>hosting module</td></tr>
<tr><td>/hostmaster-0.x/profiles/hostmaster/modules/install_profile_api</td><td>install_profile_api – facilitates provisioning of sites based on a non-default profile</td></tr>
<tr><td>/hostmaster-0.x/profiles/hostmaster/modules/jquery_ui</td><td></td></tr>
<tr><td>/hostmaster-0.x/profiles/hostmaster/modules/modalframe</td><td></td></tr>
<tr><td>/hostmaster-0.x/profiles/hostmaster/themes</td><td></td></tr>
<tr><td>/hostmaster-0.x/profiles/hostmaster/themes/<a href="http://drupal.org/project/hostmaster" title="link to eldir theme on drupal.org">eldir</a></td><td>eldir theme – provides Aegir front end look and feel</td></tr>
<tr><td>/hostmaster-0.x/profiles/hostmaster/hostmaster.profile</td><td>profile file – used in site provisioning to configure a drupal database</td></tr>
<tr><td>/hostmaster-0.x/profiles/hostmaster/hostmaster.make</td><td>make file – used to include modules, themes, libraries etc. from various sources</td></tr>
<tr><td>/hostmaster-0.x/modules</td><td></td></tr>
<tr><td>/hostmaster-0.x/themes</td><td></td></tr>
<tr><td>/hostmaster-0.x/sites</td><td></td></tr>
<tr><td>/hostmaster-0.x/sites/aegir.example.com</td><td>aegir web site folders</td></tr>
</table>

<h3>Deployed Platforms</h3>

<p>Note: the directory /platforms is optional but can be useful to separate deployed platforms from directories for scripts, config files and hostmaster platform.</p>

<table>
<tr><th>Path</th><th>Notes</th></tr>
<tr><td>/platforms</td><td></td></tr>
<tr><td>/platforms/platform-1</td><td></td></tr>
<tr><td>/platforms/platform-1/profiles</td><td></td></tr>
<tr><td>/platforms/platform-1/profiles/default</td><td></td></tr>
<tr><td>/platforms/platform-1/profiles/custom-profile</td><td></td></tr>
<tr><td>/platforms/platform-1/profiles/custom-profile/modules</td><td></td></tr>
<tr><td>/platforms/platform-1/profiles/custom-profile/themes</td><td></td></tr>
<tr><td>/platforms/platform-1/profiles/custom-profile/custom.profile</td><td>profile file – used in site provisioning to configure a drupal database</td></tr>
<tr><td>/platforms/platform-1/profiles/custom-profile/custom.make</td><td>make file – used to include modules, themes, libraries etc. from various sources</td></tr>
<tr><td>/platforms/platform-1/modules</td><td></td></tr>
<tr><td>/platforms/platform-1/themes</td><td></td></tr>
<tr><td>/platforms/platform-1/sites</td><td></td></tr>
<tr><td>/platforms/platform-1/sites/site-1.com</td><td></td></tr>
<tr><td>/platforms/platform-1/sites/site-1.com/modules</td><td></td></tr>
<tr><td>/platforms/platform-1/sites/site-1.com/themes</td><td></td></tr>
<tr><td>/platforms/platform-1/sites/site-1.com/files</td><td></td></tr>
<tr><td>/platforms/platform-1/sites/site-1.com/settings.php</td><td>site-specific drupal configuration file</td></tr>
<tr><td>/platforms/platform-1/sites/site-1.com/drushrc.php </td><td>site-specific aegir-specific configuration file</td></tr>
<tr><td>/platforms/platform-1/sites/site-2.com</td><td></td></tr>
<tr><td>/platforms/platform-1/sites/site-3.com</td><td></td></tr>
<tr><td>/platforms/platform-1/sites/site-n.com</td><td></td></tr>
<tr><td>/platforms/platform-2</td><td></td></tr>
<tr><td>/platforms/platform-3</td><td></td></tr>
<tr><td>/platforms/platform-n</td><td></td></tr>
</table>

<p><br /></p>

<h3>Platform permissions</h3>

<table>
<tr>
<th>Path</th>
<th>Directory<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></th>
<th>File<code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></th>
<th>Notes</th>
</tr>

<tr>
<td><code>./*</code></td>
<td>
<code>aegir:aegir</code><br />
<code>drwxr-xr-x</code></td>
<td>
<code>aegir:aegir</code><br />
<code>-rw-r--r--</code>
</td>
<td>The webserver has no business writing or moving files in the Drupal codebase.</td>
</tr>

<tr>
<td colspan="4"><em>Inside ./sites/example.com:</em></td>
</tr>

<tr>
<td><code>drushrc.php</code></td>
<td></td>
<td>
<code>aegir:aegir</code><br />
<code>-r--------</code>
</td>
<td>Web server shouldn't be able to read drushrc.php, it's not a component of the Drupal site.</td>
</tr>

<tr>
<td><code>settings.php</code></td>
<td></td>
<td>
<code>aegir:www-data</code><br />
<code>-r--r-----</code>
</td>
<td>Web server can read this file, but otherwise tight control over this file which can contain sensitive information.</td>
</tr>

<tr>
<td>
<code>libraries</code><br />
<code>modules</code>
<code>themes</code>
</td>
<td>
<code>aegir:aegir</code><br />
<code>drwxrwsr-x</code>
</td>
<td>
<code>aegir:aegir</code><br />
<code>-rw-r--r--</code>
</td>
<td>
Because of the sticky bit (s) on the parent directory, each child directory will inherit attributes of the parent. The attribute that is consistently inherited is the group. This means that a developer in the "aegir" group can add files which will retain the "aegir" group ownership of the parent directory.
</td>
</tr>

<tr>
<td>
<code>files</code><br />
<code>private</code>
</td>
<td>
<code>aegir:www-data</code><br />
<code>drwxrws---</code>
</td>
<td></td>
<td>Aegir sets these directories with a sticky bit (s) so that under certain conditions new folders and files will inherit parent permissions. There are only a few cases where this happens though.</td>
</tr>

<tr>
<td>
<code>files/*</code><br />
<code>private/*</code>
</td>
<td>
<code>www-data:www-data</code><br />
<code>drwxr-sr-x</code>
</td>
<td>
<code>www-data:www-data</code><br />
<code>-rw-r--r--</code>
</td>
<td>
The permissions shown here are how files and directories created by www-data will look. When verifying a platform, Aegir won't "correct" these files and directories to match the parents.

If you have trouble with permissions/ownership on these directories, you can safely run the following commands (in this case on the files directory):
<div class="codeblock"><code># chown -R aegir:www-data /path/to/site/files/*<br /># chmod -R 775 /path/to/site/files/*</code></div>
</td>
</tr>

</table>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-297.html?destination=node%2F77%23comment-form">Login</a> or <a href="../../../../../user/register/index-297.html?destination=node%2F77%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../77/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-41" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../41/index.html">Provision - the Aegir backend.</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>Each of the major entities managed by Aegir (namely servers, platforms and sites) are represented by nodes in the front end, which in turn generate Drush 'named contexts' in the backend. Named contexts are similar to what Drush 3.0 refers to as 'site aliases', but are more structured and cover more than just sites.</p>

<p>Whenever you create or edit a node on the front end, Aegir will create or update the named context on the backend, and any tasks run on the entity will be run on that named context, ie:</p>

<pre><code>drush @server_master provision-verify
</code></pre>

<p>All of the actual work related to managing your system is done by the backend, and the front end primarily serves as a way
to manage these aliases. You can very easily use the backend on it's own if you so choose.</p>

<h3>Creating or updating named contexts.</h3>

<p>Contexts are created and updated through the provision-save command. The format of the command is :</p>

<pre><code>drush provision-save @contextname --context_type=type --property=value --other_property=value
</code></pre>

<p>Every time this command is called, it will update the named context and only modify the properties that have been specified. It is important to note that the provision-save command <strong>never</strong> has a site alias or context name before the  command, but requires you to specify which context you are modifying as the first argument.</p>

<h4>Deleting named contexts.</h4>

<p>To delete an existing named context, you simply need to pass the 'delete' option to the provision-save command, ie:</p>

<pre><code>drush provision-save @contextname --delete
</code></pre>

<h3>Using named contexts</h3>

<p>Named contexts are used in 3 ways in provision: as aliases, arguments or options.</p>

<p><strong>Aliases :</strong> Aliases appear to the left of the drush command, and are making use of the Drush 'site alias' functionality.</p>

<pre><code># Verify the site represented by @example.com
drush @example.com provision-verify 
</code></pre>

<p><strong>Options :</strong> Certain options to provision-save require you to pass the alias of another named context of a specific type,
and uses this information to build relationships between objects.</p>

<pre><code> # generate a new site context in the directory represented by @platform_test
 drush provision-save @example.com --context_type=site --uri=example.com --platform=@platform_example
</code></pre>

<p><strong>Arguments :</strong> A select few provision commands require you to pass the alias of another specific type of named context as an argument.</p>

<pre><code># Migrate the site to the platform represented by @platform_newversion
drush @example.com provision-migrate @platform_newversion
</code></pre>

<h2>Context types</h2>

<p>There are (currently) 3 different entities represented as named contexts in the aegir backend. You determine which type of entity you are working with by specifying the context_type option to the provision-save command. You dont need to specify it every time, but it is best to always explicitly specify it, just in case.</p>

<p>Because the namespace of all contexts is shared, they each have different naming conventions to avoid collisions.
There are certain named contexts of each type which are always present in the system.</p>

<p>Each of the context types have different semantics and properties, and certain provision commands will only operate on certain types of entities.</p>

<h3>Server contexts</h3>

<p><strong>Naming guideline :</strong> Server with a hostname of server.example.com becomes @server_serverexamplecom.</p>

<p><strong>Special contexts :</strong> @server_master always refers to the local server where aegir is installed.</p>

<p><strong>Required properties :</strong></p>

<ul>
<li><strong>remote_host :</strong> This should always be set to the FQDN of the server being managed.</li>
</ul>

<p><strong>Services :</strong> Servers are the only entities which have services associated to them. Services are things such as http, db or dns.</p>

<p>Each service may select one service_type, which chooses which implementation to load for this service. Examples
of these are the 'mysql' implementation of the 'db' service, or the 'apache' and 'apache_ssl' implementations of the http
service.</p>

<p>All services that are found by Aegir are enabled, but unless you specifically select one of the implementations,
the 'null' service type is loaded. Each service type has additional required properties and values that can be passed
to it, but describing them all is outside of the scope of this document.</p>

<p><strong>Important commands :</strong></p>

<ul>
<li><strong>provision-verify :</strong> Verify that the configuration is correct and fix them if they aren't. </li>
</ul>

<p><strong>Example :</strong></p>

<pre><code># Enable a new remote server hosting sites with apache on port 8080
drush provision-save @server_webexamplecom --context_type=server \
  --remote_host=web.example.com \
  --http_service_type='apache' \
  --http_port=8080

# Verify that the settings are correct
drush @server_webexamplecom provision-verify --debug
</code></pre>

<h3>Platform contexts</h3>

<p>Platforms are how aegir refers to a specific copy of Drupal checked out on a file system. Platforms are hosted on web servers and sites are hosted on platforms.</p>

<p><strong>Naming guideline :</strong> A platform in /var/aegir/codebase-6.1 becomes @platform_codebase61 , but this is not strictly enforced. We only use that naming convention when we do not have a node representing the platform available. If a node is available, we use the title of the node to generate the context name.</p>

<p>Basically, you can name your platform anything but it should still be prefixed with 'platform_'.</p>

<p><strong>Special contexts :</strong> There are no special contexts per se, but the hostmaster-install and hostmaster-migrate commands generate aliases for the hostmaster platform in the form of '@platform_hostmaster$version'. If the front end is present,
one or more of these contexts are usually available too.</p>

<p><strong>Required properties :</strong></p>

<ul>
<li><strong>root :</strong> The absolute path to a Drupal directory, generally in the form /var/aegir/platformdir.</li>
</ul>

<p><strong>Optional properties :</strong></p>

<ul>
<li><strong>web_server :</strong> The name of a server context that provides the http service. The default is to @server_master</li>
<li><strong>makefile :</strong> The absolute path or url to a <a href="http://drupal.org/project/drush_make">drush make</a> makefile. If the root directory does not exist and the makefile property does, provision will call drush_make to attempt to create the directory.</li>
</ul>

<p><strong>Important commands :</strong></p>

<ul>
<li><strong>provision-verify :</strong> This will ensure that all the files are the correct permissions, and are all present on the correct remote servers. Also rebuild package database. Run this command whenever the contents of the platform changes.</li>
</ul>

<p><strong>Example :</strong></p>

<pre><code># New open atrium platform in /var/aegir/atrium-head that will be built from a remotely hosted
# makefile and published on an external web server.
drush provision-save @platform_atriumhead --context_type=platform \
        --root=/var/aegir/atrium-head \
        --web_server=@server_webexamplecom \
        --makefile='http://omega8.cc/dev/atrium_stub.make.txt'

# Verify settings and generate the directory with drush make, pushing to the remote server after.
drush provision-verify @platform_atriumhead
</code></pre>

<h3>Site contexts</h3>

<p><strong>Naming guidelines :</strong> A site with the url 'site1.example.com' becomes @site1.example.com. The context name is always the url.</p>

<p><strong>Special contexts :</strong> @hostmaster always refers to the site running the hostmaster front end. This helps with debugging and makes it more easily scriptable.</p>

<p><strong>Required properties :</strong></p>

<ul>
<li><strong>uri :</strong> The FQDN of the site. should match the context name.</li>
<li><strong>platform :</strong> The name of a platform context that the site will be hosted on.</li>
</ul>

<p><strong>Optional properties :</strong></p>

<ul>
<li><strong>db_server :</strong> The name of a server context which provides the db server. defaults to @server_master.</li>
<li><strong>client_email :</strong> The email address to send the login information for the admin user.</li>
<li><strong>profile :</strong> The installation profile the site is running. dependent on the platform supporting it.</li>
<li><strong>language :</strong> The ISO language code of the site. dependent on the platform and profile supporting it.</li>
</ul>

<p><strong>Important commands :</strong></p>

<p>Almost all of the provision commands are related to sites, so this is just the very core of them. Check drush help for more.</p>

<ul>
<li><strong>provision-install :</strong> Install the site represented by the context. Just creating the context doesn't install the site yet.</li>
<li><strong>provision-verify :</strong> Verify the site is running correctly, and ensure the files are all published to the correct servers.</li>
<li><strong>provision-delete :</strong> Delete the site and all it's information. The context will still be there.</li>
</ul>

<p><strong>Example :</strong></p>

<pre><code># Set up a new site to be installed on the open atrium platform (hosted on a remote server),
# using an external database server , with the openatrium profile and localize it into spanish.
drush provision-save @atrium.example.com --context_type=site \
        --uri=atrium.example.com \
        --platform=@platform_atriumhead \
        --db_server=@server_dbexamplecom \
        --client_email=client@example.com \
        --profile=openatrium \
        --language=es

# Install the new site to the specifications requested above.
drush @atrium.example.com provision-install --debug

# Verify the site to make sure everything is ok.
drush @atrium.example.com provision-verify --debug
</code></pre>

<h4>Importing contexts into the front end</h4>

<p>Hostmaster provides a drush command which will attempt to generate or updates front end nodes that match your defined contexts. To import a context into the front end, just run :</p>

<pre><code>drush @hostmaster hosting-import @contextname
</code></pre>

<p>This will import that context, and every context it depends on into the front end. This is useful for integration with other systems such as the <a href="http://github.com/Vertice/puppet-aegir">puppet-aegir module</a> for <a href="http://puppetlabs.com/">Puppet</a>, which can add newly configured servers directly to the front end.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-359.html?destination=node%2F41%23comment-form">Login</a> or <a href="../../../../../user/register/index-359.html?destination=node%2F41%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../41/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-284" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../284/index.html">Messaging systems evaluation</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>So we've been talking seemingly forever about possible queuing system instead of our crappy "PHP/Vixie Cron based" one, but we have yet to document pro/cons of possible alternatives. Here are the goods (or the beginning of em).</p>

<p>Note that this document was written before (in <a href="http://groups.drupal.org/node/36428">november 2009</a>) the current multiserver implementation was designed and completed.</p>

<h2>Current design</h2>

<p>Tasks are basically serialized in a MySQL database and polled at regular interval by a cron job, running <code>drush hosting dispatch</code>, which bootstraps Drupal, fetches the object, and fires up provision commands.</p>

<p>The possibility here is to have another dispatcher that would always run, and maybe not even talk to the mysql database, to fire up the provision commands.</p>

<p>Another requirement is that the queuing system may be network-aware. We want multi-server support and that is a critical issue for the next release (0.4 at the time of writing). One thing to consider is how we pass files around...</p>

<h2>Roll our own</h2>

<p>Pro:</p>

<ul>
<li>full control over the API, functionality and whatnot (ie. function of manpower invested)</li>
</ul>

<p>Con:</p>

<ul>
<li>rolling our own is <em>hard</em>! let's go shopping!</li>
</ul>

<h2>Meta: AMQP vs JMS</h2>

<p>So yeah, there's a standard in development for all this stuff: <a href="http://www.amqp.org/" title="http://www.AMQP.org/">http://www.AMQP.org/</a> . There is also a Drupal module being developed to work with it: <a href="http://drupal.org/project/amqp" title="http://drupal.org/project/amqp">http://drupal.org/project/amqp</a></p>

<p>JMS on the other hand is the "Java Messenging Service", that creates a language- (as opposed to network-) based API.</p>

<p>Maybe we should just not care about which messaging system you use in the backend and allow our frontend to talk to any backend, with the stupid cronjob mysql poller as a default...</p>

<h2>Gearman</h2>

<p>Pros (mostly out of the <a href="http://gearman.org/">home page</a>):</p>

<ul>
<li>supports PHP in frontend and backend</li>
<li>Multi-language - There are interfaces for a number of languages, and this list is growing. You also have the option to write heterogeneous applications with clients submitting work in one language and workers performing that work in another.</li>
<li>Flexible - You are not tied to any specific design pattern. You can quickly put together distributed applications using any model you choose, one of those options being Map/Reduce.</li>
<li>Fast - Gearman has a simple protocol and interface with a new optimized server in C to minimize your application overhead.</li>
<li>Embeddable - Since Gearman is fast and lightweight, it is great for applications of all sizes. It is also easy to introduce into existing applications with minimal overhead.</li>
<li>No single point of failure - Gearman can not only help scale systems, but can do it in a fault tolerant way.</li>
<li>Production ready - ran on digg, yahoo, livejournal, ...</li>
<li>Gearman uses an efficient binary protocol and no XML. There's an a line-based text protocol for admin so you can use telnet and hook into Nagios plugins.</li>
<li><a href="http://gearman.org/index.php?id=manual:job_server#persistent_queues">Persistent queues are available using mysql, memcached or sqlite</a></li>
<li>There's pretty good <a href="http://us3.php.net/gearman">PHP support</a> and it's easy to get up and running quickly.</li>
</ul>

<p>Cons:</p>

<ul>
<li>"somewhat higher latency, signal-and-pull architecture"</li>
<li>The system makes no guarantees. If there's a failure the client is told about the failure and the client is responsible for retries.</li>
<li>gearman-specific binary/network protocol</li>
<li>Notice how sixapart.com maintains both gearman and the shwartz, below</li>
</ul>

<p>OHLOH:</p>

<ul>
<li>Mostly written in Perl</li>
<li>Increasing year-over-year development activity</li>
<li>Established codebase</li>
<li>Few source code comments</li>
</ul>

<h2>Resque</h2>

<p>Pro:</p>

<ul>
<li><a href="http://code.google.com/p/redis/">redis-based</a> (therefore somehow language agnostic deep in there, but certainly network-centric)</li>
<li>github's (aka: it's got to work at least somewhere in production)</li>
</ul>

<p>Con:</p>

<ul>
<li>ruby-centric</li>
<li>I haven't actually <em>looked</em> at the thing or tested it</li>
</ul>

<h2>Active MQ</h2>

<p>Apache <a href="http://activemq.apache.org/">ActiveMQ</a>:</p>

<p>Pros:</p>

<ul>
<li>Supports a variety of Cross Language Clients and Protocols from Java, C, C++, C#, Ruby, Perl, Python, PHP  </li>
<li>Supports many advanced features such as Message Groups, Virtual Destinations, Wildcards and Composite  Destinations</li>
<li>Supports pluggable transport protocols such as in-VM, TCP, SSL, NIO, UDP, multicast, JGroups and JXTA transports</li>
<li>REST API to provide technology agnostic and language neutral web based API to messaging</li>
<li>Persistent</li>
</ul>

<p>Cons:</p>

<ul>
<li>uses too many acronyms on the frontpage (really.)</li>
<li>uses a lot of Java jargon</li>
<li>production-ready?</li>
</ul>

<p>OHLOH:</p>

<ul>
<li>Mostly written in Java</li>
<li>Large, active development team</li>
</ul>

<h2>RabbitMQ</h2>

<p><a href="http://www.rabbitmq.com/">RabbitMQ</a></p>

<p>Pros:</p>

<ul>
<li>"high reliability, availability and scalability along with good throughput and latency performance that is predictable and consistent"</li>
<li>"based on the emerging AMQP standard"</li>
<li><a href="http://packages.debian.org/rabbitmq-server">in debian</a></li>
<li>Drupal module - <a href="http://drupal.org/projects/amqp">AMQP</a></li>
<li>apparently very fast, according to dellintosh </li>
</ul>

<p>Cons:</p>

<ul>
<li><a href="http://www.ohloh.net/p/rabbitmq/analyses/latest">erlang</a>? do <em>you</em> know <a href="http://ftp.sunet.se/pub/lang/erlang/">erlang</a>? (Arguably not really necessary, since all publishers and consumers can be written in other languages that have AMQP support)</li>
</ul>

<p><a href="http://www.ohloh.net/p/rabbitmq">OHLOH</a></p>

<ul>
<li>Mostly written in Erlang</li>
<li>Large, active development team</li>
<li>Well-commented source code</li>
</ul>

<h2>Open Messenging Queue</h2>

<p><a href="https://mq.dev.java.net/overview.html" title="https://mq.dev.java.net/overview.html">https://mq.dev.java.net/overview.html</a></p>

<p>Pros:</p>

<ul>
<li>SOAP/HTTP interface</li>
<li>Scalable</li>
</ul>

<p>Con:</p>

<ul>
<li>Java/C specific</li>
</ul>

<h2>The Schwartz</h2>

<p><a href="http://search.cpan.org/~bradfitz/TheSchwartz-1.07/lib/TheSchwartz.pm">The Schwartz</a></p>

<p>Pros:</p>

<ul>
<li>Perl (come on, perl is everywhere... isn't it?)</li>
<li>"reliable job queue"</li>
<li>has retry</li>
<li>"lightweight"</li>
</ul>

<p>Cons:</p>

<ul>
<li>Perl (aka write only)</li>
<li>"library, so some assembly required"</li>
<li>"light on documentation"</li>
<li>Notice how sixapart.com maintains both the shwartz and gearman, above</li>
</ul>

<h2>Open AMQ</h2>

<p><a href="http://www.openamq.org/">Open AMQ</a></p>

<p>Pros:</p>

<ul>
<li>Multi-language (but not PHP)</li>
<li>"learn in a day or so" then "another day or two for wireAPI", development will take "some weeks"...</li>
<li>"remote admin tools, one-line failover, instant federation, protection against slow clients, detailed logging"</li>
<li><a href="http://www.amqp.org/">AMQP standard</a> </li>
<li>"Linux, AIX, Solaris, Mac OS/X, other UNIX"</li>
</ul>

<p>Cons:</p>

<ul>
<li>"for C/C++ and JMS"</li>
</ul>

<p><a href="http://www.ohloh.net/p/rabbitmq">OHLOH</a></p>

<ul>
<li>Mostly written in C</li>
<li>Well-commented source code</li>
<li>Short source control history</li>
<li>Only a single active developer</li>
<li>Apache Software License may conflict with GPL</li>
<li>Apache License 2.0 may conflict with GPL</li>
</ul>

<h2 id="beanstalkd">Beanstalkd</h2>

<p><a href="http://kr.github.com/beanstalkd/" title="http://kr.github.com/beanstalkd/">http://kr.github.com/beanstalkd/</a></p>

<p>Drupal Module for Drupal 6 and 7 is at <a href="http://drupal.org/project/beanstalkd" title="http://drupal.org/project/beanstalkd">http://drupal.org/project/beanstalkd</a></p>

<p>Pros:
 * used in production ("causes" application in facebook)</p>

<p>Cons:</p>

<ul>
<li>C</li>
</ul>

<p><a href="http://www.ohloh.net/p/beanstalkd" title="http://www.ohloh.net/p/beanstalkd">http://www.ohloh.net/p/beanstalkd</a></p>

<ul>
<li>Mostly written in C</li>
<li>Large, active development team</li>
<li>Few source code comments</li>
</ul>

<h2>SimpleMQ</h2>

<p><a href="http://code.google.com/p/simple-mq/" title="http://code.google.com/p/simple-mq/">http://code.google.com/p/simple-mq/</a></p>

<p>Pros:</p>

<ul>
<li>persistent or in-memory</li>
</ul>

<p>Cons:</p>

<ul>
<li>java-only.</li>
</ul>

<h2>Zero MQ</h2>

<p><a href="http://www.zeromq.org/" title="http://www.zeromq.org/">http://www.zeromq.org/</a></p>

<p>Pros:</p>

<ul>
<li>fast</li>
<li>lightweight messaging implementation.</li>
<li>supports different messaging models.</li>
<li>already very fast. We're getting 13.4 microseconds end-to-end latencies and up to 4,100,000 messages a second today.</li>
<li>very thin. Requires just a couple of pages in resident memory. </li>
<li>provides C, C++, Java, Python, .NET/Mono, Ruby, Fortran, COBOL, Tcl, Lua and Delphi language APIs.</li>
<li>supports different wire-level protocols: TCP, PGM, AMQP, SCTP.</li>
<li>runs on AIX, FreeBSD, HP-UX, Linux, Mac OS X, OpenBSD, OpenVMS, QNX Neutrino, Solaris and Windows.</li>
<li>supports i386, x86-64, Sparc, Itanium, Alpha and ARM microarchitectures.</li>
<li>fully distributed: no central servers to crash, millions of WAN and LAN nodes.</li>
</ul>

<p>Cons:</p>

<ul>
<li>no PHP whatsoever</li>
<li>production?</li>
</ul>

<p>OHLOH:</p>

<ul>
<li>Mostly written in C++</li>
</ul>

<h2>Jenkins</h2>

<p>There's a <a href="http://fourkitchens.com/blog/2010/05/09/drop-cron-use-hudson-instead">good vibe</a> around using Jenins (formerly known as Hudson) in place of cron for those kind of things. In our scenario, Aegir would queue up jobs to Jenkins, which would take care of dispatching them to remote servers.</p>

<p>Pros:</p>

<ul>
<li>supports tons of different notification modes</li>
<li>scales well</li>
<li>supports remote servers</li>
</ul>

<p>Cons:</p>

<ul>
<li>application-specific (unclear?) protocol to queue up tasks</li>
<li>Java (so a bit heavy)</li>
</ul>

<p>OHLOH:
 * has had 63,860 commits made by 708 contributors 
 * representing 893,049 lines of code
 * is mostly written in Java 
 * with an average number of source code comments
 * has a well established, mature codebase 
 * maintained by a very large development team 
 * with decreasing year-over-year commits</p>

<h2>Others to evaluate?</h2>

<ul><li><a href="http://aws.amazon.com/sqs/">Amazon's SQS</a>. The latencies for this service tend to be high and variable so it may not be appropriate for all tasks.</li>
<li><a href="http://search.cpan.org/~jmay/Spread-Queue-0.4/">Spread Queue</a> ([[http://search.cpan.org/~jmay/Spread-Queue-0.4/Queue.pod|alpha software]]</li>
<li><a href="http://rubyforge.org/projects/starling/">Starling</a></li> (apparently, <a href="http://www.rubyinside.com/rabbitmq-a-fast-reliable-queuing-option-for-rubyists-1681.html">twitter ditched starling</a> for <a href="http://www.scala-lang.org/">scala</a>)
<li><a href="http://houstoncommand.com//">Houston</a> From Zivtech, not much documentation yet</li>
</ul>

<p>Others mentionned <a href="http://highscalability.com/blog/2009/11/6/product-resque-githubs-distrubuted-job-queue.html">here</a>: ActiveMessaging, BackgroundJob, DelayedJob, and Kestrel.</p>

<h2>Requirements</h2>

<p>All the above must have:</p>

<ul>
<li>Open Source - It's free as in beer and speech</li>
</ul>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-360.html?destination=node%2F284%23comment-form">Login</a> or <a href="../../../../../user/register/index-360.html?destination=node%2F284%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../284/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-318" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../318/index.html">Provision contexts</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p><em>This section is currently being written, so its probably going to be full of errors, and possibly not that useful. Feel free to edit.</em></p>

<p>I'm probably going to pop a nice table of contents here, for now look to the right...</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-199.html?destination=node%2F318%23comment-form">Login</a> or <a href="../../../../../user/register/index-199.html?destination=node%2F318%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-199.html?destination=node%2F318%23comment-form">Login</a> or <a href="../../../../../user/register/index-199.html?destination=node%2F318%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-319" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../319/index.html">Purpose</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>Contexts are simply a way for Aegir to store certain pieces of information that it thinks may be useful later. They are named so that they can be referred to easily.</p>

<p>Every server, platform and site in Aegir has an associated context. Each one of these contexts stores information about the associated entity. So, for example, a site context stores the base URI of the site. Later, the code responsible for informing the web server of the site's existence can look at this context and determine the requested URI.</p>

<p>In theory contexts allow most of the back-end commands in Aegir to operate just on the name of the context. This is an important concept: the alternative would be to try to guess everything that the command being invoked might want to know and pass it in as a series of command line arguments.</p>

<p>For example, the command that Aegir uses to clone a site just needs to be given the context of the site to clone and the platform to clone it to. From there the code can work out where the destination platform actually is, what servers it needs to talk to, and with what credentials.</p>

<h4>Drush contexts</h4>

<p>Note that Drush also has the concept of a context, but this is not to be confused with Aegir contexts which are different. Aegir contexts are closer to, and stored as, Drush 'aliases'.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-200.html?destination=node%2F319%23comment-form">Login</a> or <a href="../../../../../user/register/index-200.html?destination=node%2F319%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-200.html?destination=node%2F319%23comment-form">Login</a> or <a href="../../../../../user/register/index-200.html?destination=node%2F319%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-320" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../320/index.html">Implementation</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>Contexts are always named to start with a '@' symbol, except for in the filename of the file in which they are stored.</p>

<p>Contexts in Aegir are stored as a simple array of data in a file within the backend of Aegir. However this array of data is accessed and modified with a set of objects and accessors. Here is an example of what a context file looks like:</p>

<p><div class="codeblock"><code>&lt;?php<br />$aliases[&#039;hostmaster&#039;] = array (<br />&nbsp; &#039;context_type&#039; =&gt; &#039;site&#039;,<br />&nbsp; &#039;platform&#039; =&gt; &#039;@platform_hostmaster&#039;,<br />&nbsp; &#039;server&#039; =&gt; &#039;@server_master&#039;,<br />&nbsp; &#039;db_server&#039; =&gt; &#039;@server_localhost&#039;,<br />&nbsp; &#039;uri&#039; =&gt; &#039;aegir.example.com&#039;,<br />&nbsp; &#039;root&#039; =&gt; &#039;/var/aegir/hostmaster-0.4-beta2&#039;,<br />&nbsp; &#039;site_path&#039; =&gt; &#039;/var/aegir/hostmaster-0.4-beta2/sites/aegir.example.com&#039;,<br />&nbsp; &#039;site_enabled&#039; =&gt; true,<br />&nbsp; &#039;language&#039; =&gt; &#039;en&#039;,<br />&nbsp; &#039;client_email&#039; =&gt; &#039;aegir@example.com&#039;,<br />&nbsp; &#039;aliases&#039; =&gt;<br />&nbsp; array (<br />&nbsp; ),<br />&nbsp; &#039;redirection&#039; =&gt; false,<br />&nbsp; &#039;profile&#039; =&gt; &#039;hostmaster&#039;,<br />);</code></div></p>

<p>These files are stored in the <code>/var/aegir/.drush</code> directory on the master Aegir server.</p>

<p>In the above example we can see the properties of the context, like the 'uri' of the site, and the 'profile' that the site is running.</p>

<p>There are also a number of more interesting properties in the example, note the 'db_server' property, which has a value that is another context. We shall see later that these properties are special, and allow developers to easily access functions of the 'db_server' without needing to care which db server they are talking to.</p>

<p>Contexts are used within drush commands as objects, which subclass <code>provision_context</code>. This allows much more flexibility and cleverness, though can make them very confusing to use sometimes! As a developer you will only need to worry about the context objects, as Aegir handles storing them in the files for you. But it is important to note that each context must be representable in a flat text file (or be prepared to do some serious leg-work) by that I mean you probably don't want to be storing massive amounts of relational data in them, use a database for that!</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-201.html?destination=node%2F320%23comment-form">Login</a> or <a href="../../../../../user/register/index-201.html?destination=node%2F320%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-201.html?destination=node%2F320%23comment-form">Login</a> or <a href="../../../../../user/register/index-201.html?destination=node%2F320%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-322" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../322/index.html">Using contexts in your code</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>Getting the current context is really easy, just call the '<code>d</code>' accessor:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />$current_context </span><span style="color: #007700">= </span><span style="color: #0000BB">d</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
What the current context is will depend on the drush command that is running and the context that was passed into that drush command. For example if you ran a site verify task, then the caller would name a site context, and thus initially calls to <code>d()</code> would return the site context. The values of the context are accessible as simple properties of this object.</p>

<p>So, suppose a verify task is started for the main Aegir frontend, which has a context that is always called '@hostmaster', the drush command invocation would look like this:</p>

<p><div class="codeblock"><code>drush @hostmaster provision-verify </code></div></p>

<p>Then the drush command for <code>provision-verify</code> could do this:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">drush_provision_verify</span><span style="color: #007700">() {<br />&nbsp; </span><span style="color: #0000BB">$context </span><span style="color: #007700">= </span><span style="color: #0000BB">d</span><span style="color: #007700">();<br />&nbsp; </span><span style="color: #0000BB">drush_print</span><span style="color: #007700">(</span><span style="color: #DD0000">'Passed context of type: ' </span><span style="color: #007700">. </span><span style="color: #0000BB">d</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">type</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
Which would print the type of the context passed to the verify command, in this case 'site'.</p>

<p>The <code>d</code> accessor is not to be feared! It is used all over the place in Aegir and if you're not sure what context you're going to get then you can always print <code>d()-&gt;name</code> and you'll get the name of the context that you're dealing with.</p>

<h3>Loading a named context</h3>

<p>You can pass an optional argument to the <code>d</code> accessor of the name of the context that you want. So, if you feel compelled to access a property about the main Aegir frontend site anywhere you can do this:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />$hostmaster_context </span><span style="color: #007700">= </span><span style="color: #0000BB">d</span><span style="color: #007700">(</span><span style="color: #DD0000">'@hostmaster'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>though most of the time you'll be dealing with the current context, and contexts that it references.</p>

<h3>'Subcontexts'</h3>

<p>Here's an example context:</p>

<p><div class="codeblock"><code>&lt;?php<br />$aliases[&#039;hostmaster&#039;] = array (<br />&nbsp; &#039;context_type&#039; =&gt; &#039;site&#039;,<br />&nbsp; &#039;platform&#039; =&gt; &#039;@platform_hostmaster&#039;,<br />&nbsp; &#039;server&#039; =&gt; &#039;@server_master&#039;,<br />&nbsp; &#039;db_server&#039; =&gt; &#039;@server_localhost&#039;,<br />&nbsp; &#039;uri&#039; =&gt; &#039;aegir.example.com&#039;,<br />&nbsp; &#039;root&#039; =&gt; &#039;/var/aegir/hostmaster-0.4-beta2&#039;,<br />&nbsp; &#039;site_path&#039; =&gt; &#039;/var/aegir/hostmaster-0.4-beta2/sites/aegir.example.com&#039;,<br />&nbsp; &#039;site_enabled&#039; =&gt; true,<br />&nbsp; &#039;language&#039; =&gt; &#039;en&#039;,<br />&nbsp; &#039;client_email&#039; =&gt; &#039;aegir@example.com&#039;,<br />&nbsp; &#039;aliases&#039; =&gt;<br />&nbsp; array (<br />&nbsp; ),<br />&nbsp; &#039;redirection&#039; =&gt; false,<br />&nbsp; &#039;profile&#039; =&gt; &#039;hostmaster&#039;,<br />);</code></div></p>

<p>Notice that some of the properties are the name of contexts, such as 'db_server' which has a value of '@server_localhost'.</p>

<p>Suppose now that I have some code that wants to get a property of the db_server associated with the @hostmaster context, I can simply do this:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />$db_server_context </span><span style="color: #007700">= </span><span style="color: #0000BB">d</span><span style="color: #007700">(</span><span style="color: #DD0000">'@hostmaster'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">db_server</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">// $db_server_context is now a fully populated context object, not the string '@server_localhost'<br /></span><span style="color: #0000BB">drush_print</span><span style="color: #007700">(</span><span style="color: #DD0000">'DB server on port: . $db_server_context-&gt;db_port);<br />?&gt;</span></span></code></div></p>

<p>The <code>provisionContext</code> object will return full context objects for properties that store the names of other contexts. The how and why of determining which to return as strings and which to return as a context object will be covered later. It is entirely possible to have the name of a context stored as a property in a context, that when accessed returns the string, rather than the context named in the string.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-202.html?destination=node%2F322%23comment-form">Login</a> or <a href="../../../../../user/register/index-202.html?destination=node%2F322%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-202.html?destination=node%2F322%23comment-form">Login</a> or <a href="../../../../../user/register/index-202.html?destination=node%2F322%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-323" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../323/index.html">Properties and services</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>Services are the way in which new properties are added to contexts, in fact if you wish to indicate you want to store additional properties in a context, this must be done by a service. There is no other way to store data in a context. One might assume that you can just ask provision to save an additional value on a context, but this will not work, and you'll probably get very frustrated indeed!</p>

<p>For example, the <code>provisionService_pdo</code> service adds a 'master_db' property to the server context, it does this in a method thus:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">init_server</span><span style="color: #007700">() {<br />&nbsp; </span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">init_server</span><span style="color: #007700">();<br />&nbsp; </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">server</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setProperty</span><span style="color: #007700">(</span><span style="color: #DD0000">'master_db'</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>This means that the 'master_db' property can now be set in a provison-save drush command, and will be persisted when the context is saved.</p>

<p>A service may also define properties on the context as actually representing another context, so that you may access that subcontext directly. You can see an example of using this subcontext in the 'Implementation' section of this Provision Contexts guide, but the an example of how you let provision know that a property name is not just a string, but a named context is with a method on the service:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />&nbsp; </span><span style="color: #FF8000">/**<br />&nbsp;&nbsp; * Register the http handler for platforms, based on the web_server option.<br />&nbsp;&nbsp; */<br />&nbsp; </span><span style="color: #007700">static function </span><span style="color: #0000BB">subscribe_platform</span><span style="color: #007700">(</span><span style="color: #0000BB">$context</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$context</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setProperty</span><span style="color: #007700">(</span><span style="color: #DD0000">'web_server'</span><span style="color: #007700">, </span><span style="color: #DD0000">'@server_master'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$context</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">is_oid</span><span style="color: #007700">(</span><span style="color: #DD0000">'web_server'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$context</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">service_subscribe</span><span style="color: #007700">(</span><span style="color: #DD0000">'http'</span><span style="color: #007700">, </span><span style="color: #0000BB">$context</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">web_server</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name</span><span style="color: #007700">);<br />&nbsp; }<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
Here the <code>provisionService_http</code> is being asked to 'subscribe' to a platform, it sets a property on the context, as above, but additionally uses the <code>is_oid()</code> method to indicate that the property is a named context. It then uses that immediately when it gets the name of the web_server context: <code>$context-&gt;web_server-&gt;name</code>. We'll worry about what 'subscribing' to a platform means later,.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-203.html?destination=node%2F323%23comment-form">Login</a> or <a href="../../../../../user/register/index-203.html?destination=node%2F323%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-203.html?destination=node%2F323%23comment-form">Login</a> or <a href="../../../../../user/register/index-203.html?destination=node%2F323%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-325" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../325/index.html">Using services from contexts</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>This is stub page that will describe the way that you can use the <code>service()</code> method on a context.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-204.html?destination=node%2F325%23comment-form">Login</a> or <a href="../../../../../user/register/index-204.html?destination=node%2F325%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-204.html?destination=node%2F325%23comment-form">Login</a> or <a href="../../../../../user/register/index-204.html?destination=node%2F325%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-324" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../324/index.html">Provision services</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>We should add some documentation about Provision services, what they are and how they work and interact with contexts.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-205.html?destination=node%2F324%23comment-form">Login</a> or <a href="../../../../../user/register/index-205.html?destination=node%2F324%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-205.html?destination=node%2F324%23comment-form">Login</a> or <a href="../../../../../user/register/index-205.html?destination=node%2F324%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-557" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../developing/architecture/unix-group-limitations/index.html">UNIX group limitations</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>While working on the security enhancements, I stumbled upon a few fundamental UNIX limitations with groups.  These limitations similarly apply to GNU/Linux.</p>

<script type="text/javascript">toc_collapse=0;</script><div class="toc" id="toc1">
<div class="toc-title">Table of Contents<span class="toc-toggle-message">&nbsp;</span></div>
<div class="toc-list">
<ol>
	<li class="toc-level-1"><a href="#Group_name_length_limits"><span class="toc-number">1. </span>Group name length limits</a></li>
	<li class="toc-level-1"><a href="#Group_membership_limits"><span class="toc-number">2. </span>Group membership limits</a></li>
</ol>
</div>
</div>

<h2 id="Group_name_length_limits">1. Group name length limits</h2>

<p>A group name (e.g. <code>dialout</code>) has a length limit, usually hardcoded in the operating system. This limit varies across different UNIX systems and implementations.</p>

<ul>
<li>NIS: 8 characters (<a href="http://unix.derkeiler.com/Newsgroups/comp.unix.solaris/2007-02/msg00818.html">source</a>)</li>
<li>HPUX: 8 characters, 16 starting from HPUX 10 (<a href="http://h30097.www3.hp.com/docs/base_doc/DOCUMENTATION/V51B_HTML/MAN/MAN8/0353____.HTM">source</a>, <a href="http://lists.alioth.debian.org/pipermail/pkg-shadow-devel/2009-March/007031.html">source</a>)</li>
<li>AIX: 8 characters, 255 for AIX 5.3 and above (<a href="http://publib.boulder.ibm.com/infocenter/pseries/v5r3/index.jsp?topic=/com.ibm.aix.security/doc/security/user_group_name_length.htm">source</a>)</li>
<li>Debian: 16 characters (<a href="http://lists.alioth.debian.org/pipermail/pkg-shadow-devel/2009-March/007031.html">source</a>, <a href="http://svn.debian.org/wsvn/pkg-shadow/upstream/trunk/configure.in">defined in shadow at compile-time</a>)</li>
<li>Redhat: 16 characters, 32 starting from 2005 (<a href="https://rhn.redhat.com/errata/RHBA-2005-164.html">source</a>, <a href="http://www.unixresources.net/linux/lf/5/archive/00/00/16/35/163570.html">source</a>, <a href="http://www.linuxquestions.org/questions/red-hat-31/max-group-length-in-red-hat-enterprise-linux-5-1-a-662171/">source</a>)</li>
<li>Solaris: 8 characters? (<a href="http://arc.opensolaris.org/caselog/PSARC/2007/064/issues">source</a>)</li>
<li>Active Directory: 11 or 64 characters (<a href="http://msdn.microsoft.com/en-us/library/ee824527(v=cs.10).aspx">source unclear</a>)</li>
</ul>

<p>In general, we can probably assume that 16 characters is a safe limit, and that's what's being used in <a href="../api.aegirproject.org/hosting_client_sanitize/index.html">hosting_client_sanitize</a>.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Group_membership_limits">2. Group membership limits</h2>

<p>A UNIX user has a primary group, defined in the <code>passwd</code> database, but can also be a member of many other groups, defined in the <code>groups</code> database. UNIX has a hardcoded limit of 16 groups a user can be a member of (<a href="http://www.insectnation.org/articles/2007/05/08/linux-nfs-16-group-limit">source</a>). This means that if we translate Aegir clients into UNIX groups and you have access to multiple Aegir clients, you'll be able to access only 16 of those clients at a time. Rather annoying.</p>

<p>The problem is related with NFS, or rather <code>AUTH_SYS</code> (<a href="http://www.sage.org/lists/sage-members-archive/2004/msg00389.html">source</a>), which has an in-kernel data structure where the groups a user has access to is hardcoded as an array of 16 identifiers (<code>gids</code> to be more precise, see <a href="http://blogs.sun.com/peteh/date/20050614">this post for details</a>). Even though Linux now supports <a href="http://lxr.linux.no/linux-bk+v2.6.10/include/linux/limits.h#L6">65536 groups</a>, it is still not possible to operate on more than 16 from userland, <em>through NFS</em> - on a regular ext3 filesystem, it works without problems (tested in Debian Squeeze).</p>

<p>Solutions for this are not obvious. The <a href="http://blogs.sun.com/peteh/date/20050614">blog post on sun.com</a> proposes a technical enhancement to OpenSolaris. It's unclear whether that fix was implemented. <a href="http://www.sage.org/lists/sage-members-archive/2004/msg00389.html">This SAGE post</a> explains that using <code>GSS_API</code> (used in NFSv4) should (should!) resolve the issue.</p>

<p>This <a href="http://nfsworld.blogspot.com/2005/03/whats-deal-on-16-group-id-limitation.html">more thorough analysis of the problem</a> is more direct, to shamelessly quote it:</p>

<ul>
<li>Use NFSv4</li>
<li>Use RPCSEC_GSS authentication</li>
<li>Use ACLs</li>
</ul>

<p>As mentionned above, this only applies to NFS mounts. NFSv4 should (should!) be simple enough and available on Linux. It is also unclear exactly how to use <code>RPCSEC_GSS</code> (is that Kerberos?). As for ACLs, we are fully supporting this now with the <a href="http://drupal.org/project/provisionacl">provision ACL extension</a>, so that shouldn't be an issue.</p><div class="toc-back-to-top"><a href="#toc">Back to top</a></div><script type="text/javascript">toc_scroll_back_to_top = 1;</script>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-206.html?destination=node%2F557%23comment-form">Login</a> or <a href="../../../../../user/register/index-206.html?destination=node%2F557%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-206.html?destination=node%2F557%23comment-form">Login</a> or <a href="../../../../../user/register/index-206.html?destination=node%2F557%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-494" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../494/index.html">Running drush on Aegir sites as a regular user</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p><strong>N.B.</strong> The ACL-based approach, described below, has been implemented as an extension to Provision in <a href="http://drupal.org/project/provisionacl" title="http://drupal.org/project/provisionacl">http://drupal.org/project/provisionacl</a>.</p>

<h2>What's the problem here?</h2>

<p>As things stand, you cannot run tasks as a regular UNIX user on your Aegir Drupal sites:</p>

<p><div class="codeblock"><code>anarcat@marcos:~$ drush @hostmaster cc all<br />A Drupal installation directory could not be found&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [error]<br />The drush command &#039;@hostmaster cc all&#039; could not be found.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [error]</code></div></p>

<p>The reason the site is not found is because the alias cannot be loaded. If we change our home directory to find the alaises, we then get permission problems:</p>

<p><div class="codeblock"><code>anarcat@marcos:~$ env HOME=/var/aegir drush @hostmaster cc all<br />include(/var/aegir/.drush/platform_hostmaster.alias.drushrc.php): failed to open stream:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />Permission denied sitealias.inc:433<br />include(): Failed opening &#039;/var/aegir/.drush/platform_hostmaster.alias.drushrc.php&#039; for&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />inclusion (include_path=&#039;.:/usr/share/php:/usr/share/pear&#039;) sitealias.inc:433<br />include(/var/aegir/.drush/hostmaster.alias.drushrc.php): failed to open stream: Permission&nbsp;&nbsp;&nbsp; [warning]<br />denied sitealias.inc:433<br />include(): Failed opening &#039;/var/aegir/.drush/hostmaster.alias.drushrc.php&#039; for inclusion&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />(include_path=&#039;.:/usr/share/php:/usr/share/pear&#039;) sitealias.inc:433<br />A Drupal installation directory could not be found&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [error]<br />The drush command &#039;@hostmaster cc all&#039; could not be found.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [error]</code></div></p>

<p>... so that doesn't seem to be a good approach, although one could just fix the permissions on the alias files for the site  (which don't contain the DB password, oddly enough) and platforms (which have been safe since the "server" seperation):</p>

<p><div class="codeblock"><code>cd /var/aegir/.drush<br />chmod a+r <code>ls *alias* | grep -v &amp;#039;server&amp;#039;</code></code></div></p>

<p>Then we end up with another problem:</p>

<p><div class="codeblock"><code>Cannot open drushrc &quot;/var/aegir/hostmaster-HEAD/sites/aegir.anarcat.ath.cx/drushrc.php&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />ignoring.<br />Cannot open drushrc &quot;/var/aegir/hostmaster-HEAD/drushrc.php&quot;, ignoring.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />Cannot open drushrc &quot;/var/aegir/hostmaster-HEAD/sites/aegir.anarcat.ath.cx/drushrc.php&quot;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />ignoring.<br />include_once(/var/aegir/hostmaster-HEAD/sites/aegir.anarcat.ath.cx/settings.php): failed to&nbsp;&nbsp; [warning]<br />open stream: Permission denied bootstrap.inc:400<br />include_once(): Failed opening &#039;./sites/aegir.anarcat.ath.cx/settings.php&#039; for inclusion&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />(include_path=&#039;.:/usr/share/php:/usr/share/pear&#039;) bootstrap.inc:400<br />Cannot modify header information - headers already sent by (output started at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />/usr/share/drush/includes/drush.inc:820) install.inc:618<br />Cannot modify header information - headers already sent by (output started at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />/usr/share/drush/includes/drush.inc:820) install.inc:619<br />Drush command could not be completed.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [error]</code></div></p>

<p>... and this is really the core of the issue here: we need to allow more than one user to access those files, and aegir must be able to fix those permissions when the site is created/verified.</p>

<p>So to sum up:</p>

<ul>
<li>a regular user doesn't have permissions to access the drushrc.php and settings.php files</li>
<li>the aliases are not accessible unless you change your home directory (note that -i doesn't work either, for some reason)</li>
</ul>

<h2>Hackish solution: add user to more groups</h2>

<p><a href="http://perlucida.com/blog/software/four-tips-for-developing-drupal-under-aegir#comment-52">Miguel indicates here that files should be writable by the Aegir group</a>, and, if we start with this idea, we can actually get pretty far. The drushrc.php file is owned by the Aegir group, so adding yourself to that group and fixing up the file to be group-readable actually goes a long way. You also need to add the user to the www-data group since drush expects to be able to open the settings.php file also:</p>

<p><div class="codeblock"><code>adduser anarcat aegir<br />adduser anarcat www-data<br />chmod g+r drushrc.php</code></div></p>

<p>With the above changes, we can actually run drush commands!</p>

<p><div class="codeblock"><code>anarcat@marcos:~$ env HOME=/var/aegir drush @hostmaster cc all<br />Cannot open drushrc &quot;/var/aegir/hostmaster-HEAD/drushrc.php&quot;, ignoring.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />WD php: include(/var/aegir/.drush/server_localhost.alias.drushrc.php): failed to open stream: [error]<br />Permission denied in /usr/share/drush/includes/sitealias.inc on line 433.<br />WD php: include(): Failed opening &#039;/var/aegir/.drush/server_localhost.alias.drushrc.php&#039; for&nbsp; [error]<br />inclusion (include_path=&#039;.:/usr/share/php:/usr/share/pear&#039;) in<br />/usr/share/drush/includes/sitealias.inc on line 433.<br />WD php: include(/var/aegir/.drush/server_master.alias.drushrc.php): failed to open stream:&nbsp;&nbsp;&nbsp; [error]<br />Permission denied in /usr/share/drush/includes/sitealias.inc on line 433.<br />WD php: include(): Failed opening &#039;/var/aegir/.drush/server_master.alias.drushrc.php&#039; for&nbsp;&nbsp;&nbsp;&nbsp; [error]<br />inclusion (include_path=&#039;.:/usr/share/php:/usr/share/pear&#039;) in<br />/usr/share/drush/includes/sitealias.inc on line 433.<br />include(/var/aegir/.drush/server_localhost.alias.drushrc.php): failed to open stream:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />Permission denied in /usr/share/drush/includes/sitealias.inc on line 433.<br />include(): Failed opening &#039;/var/aegir/.drush/server_localhost.alias.drushrc.php&#039; for inclusion[warning]<br />(include_path=&#039;.:/usr/share/php:/usr/share/pear&#039;) in /usr/share/drush/includes/sitealias.inc<br />on line 433.<br />include(/var/aegir/.drush/server_master.alias.drushrc.php): failed to open stream: Permission [warning]<br />denied in /usr/share/drush/includes/sitealias.inc on line 433.<br />include(): Failed opening &#039;/var/aegir/.drush/server_master.alias.drushrc.php&#039; for inclusion&nbsp;&nbsp; [warning]<br />(include_path=&#039;.:/usr/share/php:/usr/share/pear&#039;) in /usr/share/drush/includes/sitealias.inc<br />on line 433.<br />&#039;all&#039; cache was cleared&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [success]</code></div></p>

<p>We get a bunch of warnings, because provision can't load the server aliases (for a good reason - they contain DB passwords), but the command runs fine! In fact, if we want, we can avoid the luxury of using the aliases and just run the drush command in the site directory:</p>

<p><div class="codeblock"><code>anarcat@marcos:aegir.anarcat.ath.cx$ drush cc all<br />Cannot open drushrc &quot;/var/aegir/hostmaster-HEAD/drushrc.php&quot;, ignoring.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [warning]<br />&#039;all&#039; cache was cleared&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [success]</code></div></p>

<p>That warning can be removed by simply fixing the permissions on the drushrc.php file to be group-readable.</p>

<p>However, the problem with that approach is that the user has access to <em>all</em> sites, from there on. No regard to what client the user has access to. Obviously, this can work for a dedicated server (and it would need patches to provision so that drushrc.php files and optionnally aliases are group-readable) but it will not work for shared hosting, which is my prime objective here.</p>

<p><strong>Patches necessary</strong>:</p>

<ul>
<li>group-readable drushrc.php (changes in provision)</li>
<li>add users to the aegir and www-data groups manually</li>
<li>optional: group-readable site aliases (so that users can access the aliases)</li>
</ul>

<p><strong>Issues</strong>:</p>

<ul>
<li>all or nothing: the user has access to all sites or none as we have a single group</li>
</ul>

<h2>Traditionnal UNIX permission-based approach</h2>

<p>In order for this to work really correctly, we would need the following permissions setup. Instead of having the typical following:</p>

<p><div class="codeblock"><code>-r--r-----&nbsp; 1 aegir aegir&nbsp;&nbsp;&nbsp; 55456 16 mar 13:35 drushrc.php<br />drwxrws--- 10 aegir www-data&nbsp; 4096 16 mar 13:34 files<br />drwxrwsr-x&nbsp; 2 aegir aegir&nbsp;&nbsp;&nbsp;&nbsp; 4096 16 mar 13:34 modules<br />-r--r-----&nbsp; 1 aegir www-data&nbsp; 3276 16 mar 13:35 settings.php</code></div></p>

<p>(I am skipping libraries, themes and private directories for simplicity - libraries and themes are the same as modules and private is the same as files.)</p>

<p>... We would need to have the following:</p>

<p><div class="codeblock"><code>-r--r-----&nbsp; 1 aegir&nbsp;&nbsp;&nbsp; client&nbsp;&nbsp; 55456 16 mar 13:35 drushrc.php<br />drwxrws--- 10 www-data client&nbsp;&nbsp;&nbsp; 4096 16 mar 13:34 files<br />drwxrwsr-x&nbsp; 2 aegir&nbsp;&nbsp;&nbsp; client&nbsp;&nbsp;&nbsp; 4096 16 mar 13:34 modules<br />-r--r-----&nbsp; 1 www-data client&nbsp;&nbsp;&nbsp; 3276 16 mar 13:35 settings.php</code></div></p>

<p>That is, all files and directories are readable by the "client" group (which allow inter-client isolation) and some would be readable or writable by the webserver (which allows for uploads and the webserver to read the settings.php and so on).</p>

<p>In this scenario, the webserver has access to all sites all the time: it can read/write uploaded files of other modules, but, because of database cloaking, it can't access other sites' databases. If we want to fix this we would have to go with ACLs.</p>

<p>Note that this setup doesn't require the webserver running any special patch or daemon to run the PHP process as a normal user: it still runs as the www-data user.</p>

<p><strong>Patches necessary</strong>:</p>

<ul>
<li>patches mentionned above (group-readable drushrc and aliases)</li>
<li>creating the client group and adding users to it</li>
<li>adding the aegir user to the client group</li>
<li>patching provision so it changes the group of some files to the client group</li>
<li>patching provision so it changes the owner of some files to the www-data user (this actually requires root: <strong>ouch</strong>!)</li>
</ul>

<p><strong>Issues</strong>:</p>

<ul>
<li>requires aegir to run as root</li>
<li>aegir need to be a member of <em>every</em> group</li>
</ul>

<h2>The ACL approach</h2>

<p>This is based on <a href="http://groups.drupal.org/node/43910#comment-117454">this excellent comment</a> from <a href="https://drupal.org/user/420589">malclocke</a>.</p>

<p>This is one of the simplest and elegant approach, as it:</p>

<ul>
<li>doesn't require root access</li>
<li>fits well with the n to n client access list model of aegir</li>
<li>works without having to change the existing permissions (so would fit well in a contrib module)</li>
</ul>

<p>To configure ACLs, you need to add the option to your mountpoint in fstab and remount the mountpoint (or reboot):</p>

<p><div class="codeblock"><code>apt-get install acl<br />mount -o remount,acl /var # and edit /etc/fstab to add the acl option to the mountpoint</code></div></p>

<p>The rest is fairly simple: we just need to add access to the required groups to the drushrc and settings.php files:</p>

<p><div class="codeblock"><code>setfacl -m g:client:r-- settings.php drushrc.php</code></div></p>

<p>... where "client" is the client group.</p>

<p>Optionnally, we can also give access to the alias files the same way, but we end up with the same warning on the server level files.</p>

<p><em>Note</em>: <a href="http://www.vanemery.com/Linux/ACL/linux-acl.html">this is a good introduction to ACLs, in Redhat</a></p>

<p><strong>Patches necessary</strong>:</p>

<ul>
<li>make platform-level drushrc readable by all (or add an ACL for each client with access to the platform..)</li>
<li>patch provision to add relevant ACLs on verify and install, to drushrc.php and settings.php:</li>
<li>system-level configuration of mountpoints and extra package</li>
<li>creating the client group and adding users to it</li>
</ul>

<p><strong>Issues</strong>:</p>

<ul>
<li>requires system-level modifications</li>
<li>NFS has not supported ACLs very well traditionnally (see <a href="http://wiki.linux-nfs.org/wiki/index.php/ACLs">the NFSv4 implementation notes</a> and <a href="http://acl.bestbits.at/problems.html">the issues page for ACLs</a> for more information) - but according to my tests (vanilla Debian squeeze), it just works</li>
</ul>

<h2>Other similar research</h2>

<p>This is actually a well-discussed topic in the community, although nobody came up with a clean and complete solution for this.</p>

<ul>
<li><a href="http://perlucida.com/blog/software/four-tips-for-developing-drupal-under-aegir#comment-2">Brilliant comment from mig5</a> explaining group-ownership of key files</li>
<li><a href="http://groups.drupal.org/node/87414">A similar solution proposed here</a> actually shows which chunks of code need to be modified in 0.4-alpha6</li>
<li><a href="http://groups.drupal.org/node/43910">Aegir permissions best practices thread</a> - mentions everything from the "aegir group" to ACLs</li>
<li><a href="http://groups.drupal.org/node/12066">My original research into this problem</a></li>
</ul>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-207.html?destination=node%2F494%23comment-form">Login</a> or <a href="../../../../../user/register/index-207.html?destination=node%2F494%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-207.html?destination=node%2F494%23comment-form">Login</a> or <a href="../../../../../user/register/index-207.html?destination=node%2F494%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-33" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../contrib/index.html">Extending Aegir</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_27 first last"><a href="../../../../../category/level/developer/index.html" rel="tag" title="This level is generally for users interested in further developing the Aegir system itself, or extending it with contributed modules.">Developer</a></li>
</ul></div><p>Aegir is designed to be easily extendable by developers. As it is made with Drupal and Drush, it is made of the hooks and command you know and love. If you are a user or admin looking to deploy contrib modules, you should look into the <a href="../../../../../contrib-modules/index.html">contrib modules list and user documentation</a> instead.</p>

<h2>What can I extend exactly?</h2>

<p>These extensions may come in the form of</p>

<ul>
<li>Adding new tasks to be performed against sites</li>
<li>Adding new services or implementations of service types (postgres for the DB service, for example)</li>
<li><a href="../../../../75/index.html">Overriding or hooking into existing forms such as the site form, to send extra data to the backend</a></li>
<li>Using APIs to inject bits of configuration into configuration files such as settings.php and vhosts.</li>
</ul>

<p>This area is be devoted to teaching you how to extend and develop for Aegir to encourage contributions to the Aegir project or to help you modify Aegir to suit your unique use case.</p>

<h2>Aegir API documentation</h2>

<p>The inline documentation is a good start to understand the various hooks and internals that allow you to extend and customize Aegir to your liking. The documentation is rendered on <a href="http://api.aegirproject.org/">api.aegirproject.org</a> daily.</p>

<p>See also the <a href="../../../../../dev-cheat-sheet/index.html">developer cheat sheet</a>.</p>

<blockquote>
  <p><em>Please submit any suggestions or bug reports to the <a href="http://drupal.org/project/issues?text=&amp;projects=hosting,+provision,+eldir,+Hostmaster+%28Aegir%29&amp;status=Open&amp;priorities=All&amp;categories=All">Aegir Project issue queue of your choice</a>, under the "documentation" component.</em></p>
</blockquote>

<h2>Example modules</h2>

<p>The <a href="../../../../../contrib-modules/index.html">contrib modules</a> page documents all known Aegir extensions in existence. There are also specific developer documentation pages below.</p>

<h2>Contrib developer documentation and roadmaps</h2>

<p>Contrib developers are free to use this space to document the internals of their modules or their roadmaps. There is already this documentation:</p>

<ul>
<li><a href="../../../../108/index.html">E-Commerce Integration Roadmap</a> (uc_hosting)</li>
</ul>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-208.html?destination=node%2F33%23comment-form">Login</a> or <a href="../../../../../user/register/index-208.html?destination=node%2F33%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-208.html?destination=node%2F33%23comment-form">Login</a> or <a href="../../../../../user/register/index-208.html?destination=node%2F33%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-537" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../dev-cheat-sheet/index.html">Aegir developer cheat sheet</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <script type="text/javascript">toc_collapse=0;</script><div class="toc" id="toc2">
<div class="toc-title">Table of Contents<span class="toc-toggle-message">&nbsp;</span></div>
<div class="toc-list">
<ol>
	<li class="toc-level-1"><a href="#Locations_and_paths"><span class="toc-number">1. </span>Locations and paths</a></li>
	<li class="toc-level-1"><a href="#File_permissions_and_ownership"><span class="toc-number">2. </span>File permissions and ownership</a></li>
	<li class="toc-level-1"><a href="#Enablingdisabling_drushprovision_extensions_from_hostmaster"><span class="toc-number">3. </span>Enabling/disabling drush/provision extensions from hostmaster</a></li>
	<li class="toc-level-1"><a href="#References"><span class="toc-number">4. </span>References</a></li>
</ol>
</div>
</div>

<h3 id="Locations_and_paths">1. Locations and paths</h3>

<ul>
<li>Site URI: d()-&gt;uri; // ex: $base_url = 'http://' . d()-&gt;uri;</li>
<li>Drupal root: d()-&gt;site // returns: /var/aegir/platform/drupal-6.20/</li>
<li>Site path: d()-&gt;site_path // returns: /var/aegir/platform/drupal-6.20/sites/example.org/</li>
</ul>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="File_permissions_and_ownership">2. File permissions and ownership</h3>

<pre>
 $ctools_path = d()-&gt;site_path . '/files/ctools';

 provision_file()-&gt;chmod($ctools_path, 0770, TRUE)
   -&gt;succeed('Changed permissions of <code>@path</code> to @perm')
   -&gt;fail('Could not change permissions <code>@path</code> to @perm')
   -&gt;status();

 provision_file()-&gt;chgrp($ctools_path, d('@server_master')-&gt;web_group, TRUE)
   -&gt;succeed('Change group ownership of settings.php to @path')
   -&gt;fail('Could not change group ownership of settings.php to @path')
   -&gt;status();
</pre>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Enablingdisabling_drushprovision_extensions_from_hostmaster">3. Enabling/disabling drush/provision extensions from hostmaster</h3>

<p>Every drush extension can implement a hook_drush_load(), and check if a module is enabled in the hostmaster site. See <a href='http://drupalcode.org/project/provision.git/blob/refs/heads/6.x-2.x:/provision.api.php'>provision.api.php for an example</a>.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="References">4. References</h3>

<p><a href="http://api.aegirproject.org/" title="http://api.aegirproject.org/">http://api.aegirproject.org/</a></p><div class="toc-back-to-top"><a href="#toc">Back to top</a></div><script type="text/javascript">toc_scroll_back_to_top = 1;</script>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-209.html?destination=node%2F537%23comment-form">Login</a> or <a href="../../../../../user/register/index-209.html?destination=node%2F537%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-209.html?destination=node%2F537%23comment-form">Login</a> or <a href="../../../../../user/register/index-209.html?destination=node%2F537%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-75" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../75/index.html">Extending Aegir and communicating with install profiles</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>This article has been republished from mig5's website. <a href="http://www.migueljacq.com/content/developing-aegir-extending-aegir-and-communicating-install-profiles">Original URL</a></p>
<p>Aegir is a pretty powerful tool that allows you to very quickly provision new Drupal sites out of the box and manage them throughout their lifespan through a variety of tasks.</p>
<p>Its ability to understand different install profiles and thus 'distributions' shoots the awesome factor through the roof once you can deploy instances of OpenAtrium, Pressflow, ManagingNews or your own custom distro in just a couple of clicks.</p>
<p>Inevitably, though, your requirements will grow more complex. Aegir is about automation, and install profiles that prompt users for information through a series of tasks, and fail without that information, aren't much help. You might resort to a bunch of hacks to get that data into your client's site. You might try and insert some custom stuff into the site's vhost only to whimper in dismay when Aegir does a routine Verify sanity check and obliterates your changes.</p>
<p>If you get to this point, the simplicity of Aegir will be a distant memory and you'll be shaking your fist at us developers for forgetting about your corner case. Curses!</p>
<p>Rest assured, despite the constantly shifting development in Aegir and its early alpha stages, we try to maintain an ability to hook into Aegir and extend it as easily as possible, and it will only continue to get easier, especially once our API stabilises and is published.</p>
<p>Today I'm going to show you:</p>
<ul>
<li>how to add a custom Hosting submodule to Aegir</li>
<li>how to alter the site form to add custom fields of data</li>
<li>how to send that data to the backend</li>
<li>how to apply that data to site vhosts and inside your custom install profile and site database</li>
</ul>
<p>There are a few files here, because we're creating a custom module and install profile, and a few other things. For the impatient, I've attached a tarball to this article called 'cheesy.tar.gz' that contains all the relevant components and a README.txt instructing where to put it all.</p>
<p>Those of you who follow me on Twitter know I like to perpetuate the semi-French stereotype and rant and rave about cheese. I spent some time trying to think of a non-cheesy example to use in this tutorial, before realising what a silly idea that was. You can never have enough cheese :)</p>
<h3>Part one - Adding a cheesy module</h3>
<p>We'll add a custom module to the Hosting frontend called 'Cheese'.</p>
<p>Hosting is the 'frontend' bit of the Aegir system that allows you to plug data in via a web interface and have that information, if necessary, communicated to the backend Drush/Provision system by way of 'tasks'.</p>
<p>Our new module is simple: we're going to invoke a hook_form_alter() to add a textfield to the site form. The module will add a table to the Aegir database that stores this value, linked to the site nid. Keeping it out of the hosting_site table means we can disable and uninstall this module later and clean up properly.</p>
<p>There's nothing new or unusual about a Hosting submodule than any other Drupal module.  Make the directory <code>/var/aegir/hostmaster-0.x/profiles/hostmaster/modules/hosting/cheese</code></p>
<p><strong>Info file</strong></p>
<p>Here's our hosting_cheese.info</p>
<div class="codeblock"><code>name = Cheese<br />description = Cheesemongers need to define cheese in their Drupal sites.<br />package = Hosting<br />dependencies[] = hosting_site
<p>core = 6.x</p></code></div>
<p>You can see we depend on hosting_site, because hosting_site is the module that provides the site form for installing sites!</p>
<p><strong>Install file</strong></p>
<p>Now let's add an .install file that defines our database table schema and how to install/uninstall it. Standard Drupal stuff.</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Implementation of hook_schema().<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_schema</span><span style="color: #007700">() {<br />&nbsp; </span><span style="color: #0000BB">$schema</span><span style="color: #007700">[</span><span style="color: #DD0000">'hosting_cheese'</span><span style="color: #007700">] = array(<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'fields' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'vid' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'int'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'not null' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'default' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">0</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'nid' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'int'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'unsigned' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'not null' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'default' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">0</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'cheese' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'varchar'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'length' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">128</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'not null' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br />&nbsp;&nbsp;&nbsp; ),<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'indexes' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'vid' </span><span style="color: #007700">=&gt; array(</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'cheese' </span><span style="color: #007700">=&gt; array(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp; ),<br />&nbsp; );
<p>&nbsp; return </p></span><span style="color: #0000BB">$schema</span><span style="color: #007700">;<br />}
<p>function </p></span><span style="color: #0000BB">hosting_cheese_install</span><span style="color: #007700">() {<br />&nbsp; </span><span style="color: #FF8000">// Create tables.<br />&nbsp; </span><span style="color: #0000BB">drupal_install_schema</span><span style="color: #007700">(</span><span style="color: #DD0000">'hosting_cheese'</span><span style="color: #007700">);<br />}
<p>function </p></span><span style="color: #0000BB">hosting_cheese_uninstall</span><span style="color: #007700">() {<br />&nbsp; </span><span style="color: #FF8000">// Remove tables.<br />&nbsp; </span><span style="color: #0000BB">drupal_uninstall_schema</span><span style="color: #007700">(</span><span style="color: #DD0000">'hosting_cheese'</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p><strong>The module</strong></p>
<p>Here's our simple hosting_cheese.module file.</p>
<p>It's pretty straightforward: our first function is a <code>hook_form_alter()</code> of <code>hosting_site_form()</code>. We are adding a single textfield to the form called 'Cheese'. Because it's my favourite, the default value is going to be 'camembert' if it hasn't already been set on the node (if we're updating a site rather than creating a new one).</p>
<p>The next few functions are invocations of common database hooks such as insert, update and delete. They will insert the 'cheese' value from our form into the <code>hosting_cheese</code> table.</p>
<p>I call <code>hook_nodeapi()</code> to do $stuff on those actions. There's validation to check that a cheese was entered. We invoke <code>hook_load()</code>, which allows various modules and features to return their bits and pieces from various parts of the database as 'additions' to the core node attributes. With this we can call <code>$node-&gt;cheese</code> when we might need to.</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Implementation of hook_form_alter()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$form</span><span style="color: #007700">, </span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br />&nbsp; if (</span><span style="color: #0000BB">$form_id </span><span style="color: #007700">== </span><span style="color: #DD0000">'site_node_form'</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">] = array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'textfield'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#title' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'Cheese'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#description' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'What sort of cheese?'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#default_value' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'#node'</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">cheese </span><span style="color: #007700">? </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'#node'</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">cheese </span><span style="color: #007700">: </span><span style="color: #DD0000">'camembert'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#required' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#weight' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">0</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp; );<br />&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">$form</span><span style="color: #007700">;<br />&nbsp; }<br />}
<p></p></span><span style="color: #FF8000">/** <br /> * Implementation of hook_insert()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">) {<br />&nbsp; if (</span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cheese</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT INTO {hosting_cheese} (vid, nid, cheese) VALUES (%d, %d, '%s')"</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">vid</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">nid</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cheese</span><span style="color: #007700">);<br />&nbsp; }<br />}
<p></p></span><span style="color: #FF8000">/**<br /> * Implementation of hook_update()<br /> */
<p></p></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_update</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"UPDATE {hosting_cheese} SET cheese = '%s' WHERE nid = %d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cheese</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">nid</span><span style="color: #007700">);<br />}
<p></p></span><span style="color: #FF8000">/**<br /> * Implementation of hook_delete()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_delete</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DELETE FROM {hosting_cheese} WHERE nid=%d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">nid</span><span style="color: #007700">);<br />}
<p></p></span><span style="color: #FF8000">/**<br /> * Implementation of hook_delete_revision()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_delete_revision</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DELETE FROM {hosting_cheese} WHERE vid=%d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">vid</span><span style="color: #007700">);<br />}
<p></p></span><span style="color: #FF8000">/** <br /> * Implementation of hook_nodeapi()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_nodeapi</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$node</span><span style="color: #007700">, </span><span style="color: #0000BB">$op</span><span style="color: #007700">, </span><span style="color: #0000BB">$a3 </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">, </span><span style="color: #0000BB">$a4 </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">) {<br />&nbsp; if (</span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">type </span><span style="color: #007700">== </span><span style="color: #DD0000">'site'</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; switch (</span><span style="color: #0000BB">$op</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'insert'</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">hosting_cheese_insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'update'</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">hosting_cheese_update</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'delete' </span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">hosting_cheese_delete</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'delete revision'</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">hosting_cheese_delete_revision</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'validate' </span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!</span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cheese</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">form_set_error</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">, </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'You must enter a cheese!'</span><span style="color: #007700">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'load'</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$additions</span><span style="color: #007700">[</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">] = </span><span style="color: #0000BB">db_result</span><span style="color: #007700">(</span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT cheese FROM {hosting_cheese} WHERE vid=%d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">vid</span><span style="color: #007700">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">$additions</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>At this point, you can go to <code>/admin/build/modules</code> and enable the Cheese feature. The database table will get installed, and you can now go to <code>Create Content &gt; Site</code> and see our cheese field is present in the site form!</p>
<div align="center"><img src="../../../../../sites/community.aegirproject.org/files/cheese_form/index.png" /></div>
<h3>Part two - sending the cheese to the backend</h3>
<p>Yes, it's very exciting that we have cheese in Aegir now. But don't provision a site yet! The fun hasn't even started.</p>
<p>In the same directory as the hosting_cheese module, create a new file called <code>hosting_cheese.drush.inc</code>. This is a Drush file that is going to be responsible for catching when an Install or Verify task is being executed against a site, and to send the cheese value along for the ride to the backend.</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Implementation of drush_hook_pre_hosting_task()<br /> * Send the site's cheese attribute to the backend for processing.<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">drush_hosting_cheese_pre_hosting_task</span><span style="color: #007700">() {<br />&nbsp; </span><span style="color: #0000BB">$task </span><span style="color: #007700">=&amp; </span><span style="color: #0000BB">drush_get_context</span><span style="color: #007700">(</span><span style="color: #DD0000">'HOSTING_TASK'</span><span style="color: #007700">);<br />&nbsp; if (</span><span style="color: #0000BB">$task</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ref</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">type </span><span style="color: #007700">== </span><span style="color: #DD0000">'site' </span><span style="color: #007700">&amp;&amp; (</span><span style="color: #0000BB">$task</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">task_type </span><span style="color: #007700">== </span><span style="color: #DD0000">'install' </span><span style="color: #007700">|| </span><span style="color: #0000BB">$task</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">task_type </span><span style="color: #007700">== </span><span style="color: #DD0000">'verify'</span><span style="color: #007700">)) {<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$task</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">options</span><span style="color: #007700">[</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">] = </span><span style="color: #0000BB">$task</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ref</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cheese</span><span style="color: #007700">;<br />&nbsp; }<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>In this code, <code>$task-&gt;ref</code> represents the node object (the site).</p>
<p>Because of our additions in our implementation of hook_node_load(), the cheese value is fetched and available for us to use.</p>
<h3>Part three - an install profile (just for fun)</h3>
<p>I'm demonstrating all this to show you how to get data from the frontend (in the site form) to the backend. We've achieved that, but you probably want to actually *do* stuff with the data. </p>
<p>I'll demonstrate two things you can do with this data. They are just examples - Aegir isn't limited to this at all. </p>
<p><strong>cheesy_sites.profile</strong><br />
First let's create a simple install profile called 'Cheesy sites'.</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Return an array of the modules to be enabled when this profile is installed.<br /> *<br /> * @return<br /> *&nbsp; An array of modules to be enabled.<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">cheesy_sites_profile_modules</span><span style="color: #007700">() {<br />&nbsp; return array(<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">/* core */ </span><span style="color: #DD0000">'block'</span><span style="color: #007700">, </span><span style="color: #DD0000">'color'</span><span style="color: #007700">, </span><span style="color: #DD0000">'filter'</span><span style="color: #007700">, </span><span style="color: #DD0000">'help'</span><span style="color: #007700">, </span><span style="color: #DD0000">'menu'</span><span style="color: #007700">, </span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'system'</span><span style="color: #007700">, </span><span style="color: #DD0000">'user'</span><span style="color: #007700">, </span><span style="color: #DD0000">'path'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">/* other contrib */ </span><span style="color: #DD0000">'install_profile_api'</span><span style="color: #007700">, </span><span style="color: #DD0000">'token'</span><span style="color: #007700">, </span><span style="color: #DD0000">'pathauto'</span><span style="color: #007700">, </span><span style="color: #DD0000">'views'</span><span style="color: #007700">,<br />&nbsp; );<br />}
<p></p></span><span style="color: #FF8000">/**<br /> * Return a description of the profile for the initial installation screen.<br /> *<br /> * @return<br /> *&nbsp;&nbsp; An array with keys 'name' and 'description' describing this profile.<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">cheesy_sites_profile_details</span><span style="color: #007700">() {<br />&nbsp; return array(<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'name' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Cheesy site'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'description' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Select this profile to install a really cheesy site.'<br />&nbsp; </span><span style="color: #007700">);<br />}
<p>function </p></span><span style="color: #0000BB">cheesy_sites_profile_tasks</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$task</span><span style="color: #007700">, </span><span style="color: #0000BB">$url</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #FF8000">// Install dependencies<br />&nbsp; </span><span style="color: #0000BB">install_include</span><span style="color: #007700">(</span><span style="color: #0000BB">cheesy_sites_profile_modules</span><span style="color: #007700">());<br />&nbsp; </span><span style="color: #FF8000">// Fetch and set the cheese attribute from Drush, sent originally <br />&nbsp; // from the site form in the Aegir frontend.<br />&nbsp; </span><span style="color: #0000BB">variable_set</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese' </span><span style="color: #007700">, </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">, </span><span style="color: #DD0000">'camembert'</span><span style="color: #007700">));<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>This is not meant as an exercise in learning how to write install profiles so I'll gloss over some of the details here. Basic version: we define our modules that the profile depends on (core + some contrib), we install those modules, and finally we do a basic <code>variable_set</code> to store a 'cheese' variable in the site's database, fetching the value from the Drush/Provision backend (sent by the frontend per above), defaulting to 'camembert' if there was none.</p>
<p>Obviously in a normal install profile, this file would be bigger, as you'd be doing a bunch of other stuff such as setting up node types, setting up menus, blocks, users etc.</p>
<p><strong>cheesy_sites.make</strong><br />
I provide a Drush makefile here to fetch the contrib for you. This is totally out of the scope of the tutorial, but it's just fun to use Drush Make and I encourage you to get used to it :)</p>
<div class="codeblock"><code>core = 6.x<br />api = 2
<p>; Contrib modules<br />projects[token][version] = &quot;1.15&quot;<br />projects[pathauto][version] = &quot;1.5&quot;<br />projects[views][version] = &quot;2.11&quot; <br />projects[install_profile_api][version] = &quot;2.1&quot;</p></code></div>
<p>Download Drupal into /var/aegir/drupal-6.19 and copy the cheesy_sites directory into the profiles directory of drupal-6.19, or use a Drush stub makefile to do it all.</p>
<p>If you downloaded core manually, you'll want to <code>cd drupal-6.19; drush make profiles/cheesy_sites/cheesy_sites.make --no-core</code>. The contrib will be downloaded to /var/aegir/drupal-6.19/sites/all/modules</p>
<p><strong>Add the platform</strong></p>
<p>Add a new Platform in Aegir with the Publish Path being that which we just created: /var/aegir/drupal-6.19. A Verify task will be spawned, and Aegir will pick up all the modules and also the 'cheesy_sites' profile, which you can check by viewing the 'Installation profiles' section of the 'Packages' menu tab on the platform node, after the Verify task has completed.</p>
<div align="center"><img src="../../../../../sites/community.aegirproject.org/files/cheesy_sites_profile/index.png" /></div>
<p>You could also add this profile and its dependencies to an existing platform and just re-Verify the platform, and the new profile will be synced up and added to this platform's package registry.</p>
<h3>Part four - make the backend knowledgeable about cheese</h3>
<p>Now we've set up the frontend to get the cheese, set up a drush file to send the cheese to the backend, and we have an install profile that expects to find cheese and set a variable about it in a database when installing a site.</p>
<p>We've left out one crucial stage, and that is to actually prepare the backend to tell it that cheese is coming!</p>
<p><strong>cheese.drush.inc</strong></p>
<p>Telling the backend about the incoming cheese is very similar to what we did earlier about capturing the cheese info on specific tasks and do $stuff with it. </p>
<p>To tell Drush and Provision (Aegir's Drush extension) about the cheese, create a file in ~aegir/.drush called <code>cheese.drush.inc</code>.</p>
<p>We'll invoke a Drush hook that sets the value for the backend on installing a site.</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Implementation of hook_pre_provision_install()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">drush_cheese_pre_provision_install</span><span style="color: #007700">(</span><span style="color: #0000BB">$url </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">drush_set_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">, </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">, </span><span style="color: #DD0000">'camembert'</span><span style="color: #007700">), </span><span style="color: #DD0000">'site'</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>This saves the value into the site context, where it's usable by the install profile. This occurs in the pre hook, prior to when Aegir starts executing the tasks outlined by the install profile.</p>
<h3>Part five - using Aegir hooks to inject settings into the site vhost</h3>
<p>In Part four, we'll have accomplished what is needed to set the cheese value for the backend, which in turn means you can now create a site in the Aegir frontend, choose the 'Cheesy site' profile, and expect the install profile to pick that cheese setting up and store it in the new site's database as a variable.</p>
<p>But! While I'm here, let me show you another Aegir hook that allows you to safely inject extra configuration sent from the frontend into the site's Apache vhost config file, persistently, without it being overwritten next time the site is Verified.</p>
<p>We'll invoke an Aegir hook called <code>provision_apache_vhost_config()</code> to insert a SetEnv into the vhost file, just for the hell of it.</p>
<p>Another example where you might want to do this is, say, to set a htpasswd password in the site form, and use the hook to inject mod_auth htpasswd protection for the site (perhaps a demonstration for another time!).</p>
<p>Add this to your cheese.drush.inc:</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*<br /> * Implementation of hook_provision_apache_vhost_config()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">cheese_provision_apache_vhost_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">) {<br />&nbsp; return </span><span style="color: #DD0000">"&nbsp; SetEnv cheese&nbsp; " </span><span style="color: #007700">. </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">, </span><span style="color: #DD0000">'camembert'</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>The return value is inserted into the vhost. You can return multiple lines by wrapping them in an array, or even more elegantly, simply return a path to a template .tpl.php file and do your customisations in the template!</p>
<h3>Part six - check the results!</h3>
<p>If you've done everything up to Part four and five prior to installing a site using the 'Cheesy site' install profile, do so now! </p>
<p>I'm going to create a site called 'cheesy.mig5-forge.net' and set my cheese type to be 'cheddar'.</p>
<div align="center"><img src="../../../../../sites/community.aegirproject.org/files/cheese_site/index.png" /></div>
<p>Now let's check to see those settings in their end result:</p>
<p><strong>The variable in the new site's database</strong></p>
<p>Run this command: <code>drush @yoursite.com vget cheese</code></p>
<p>You should see something like this:</p>
<div align="center"><img src="../../../../../sites/community.aegirproject.org/files/cheese_variable/index.png" /></div>
<p>Great! Now let's look at the Apache vhost file for this site, and we should see a 'SetEnv' parameter injected into the vhost.</p>
<div align="center"><img src="../../../../../sites/community.aegirproject.org/files/cheesy_vhost/index.png" /></div>
<h3>Conclusion</h3>
<p>I know these have been silly examples, but I hope you've taken some important lessons out of all this:</p>
<ul>
<li>How to extend the frontend of Aegir and hook into things like the site form and site node</li>
<li>How to capture data on task 'events' like install and send it to the backend</li>
<li>How to recognise that data in the backend and use it in install profiles or invoke our hooks to inject the data into configuration files</li>
<li>How much I really like cheese</li>
</ul>
<h2>Cheesy tarball</h2>
<p>As mentioned at the start of this article, you can download all these components I've been talking about here: <a href="http://www.migueljacq.com/files/cheesy.tar.gz">cheesy.tar.gz</a>. Remember to read the README.txt</p>
<h2>Further reading</h2>
<p>A great article by hadsie on g.d.o on <a href="http://groups.drupal.org/node/97039">sending data to an install profile via the Signup form</a> covers similar information on capturing data sent to the backend in an install profile.</p>
<p>Steven Jones has published a HTTP mod_auth feature extension for injecting htpasswd password protection on sites over at <a href="https://github.com/computerminds/aegir_http_basic" title="https://github.com/computerminds/aegir_http_basic">https://github.com/computerminds/aegir_http_basic</a></p>
    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-422.html?destination=node%2F75%23comment-form">Login</a> or <a href="../../../../../user/register/index-422.html?destination=node%2F75%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../75/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-108" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../108/index.html">E-Commerce Integration Roadmap</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>Related links:</p>

<ul>
<li>For installation and configuration instructions, see the <a href="../../../../516/index.html">Administrator Manual</a>.</li>
<li>There was some valuable discussion on <a href="http://groups.drupal.org/node/94959">use cases</a> on groups.drupal.org.</li>
</ul>

<p><strong><em>Don't put feature requests in here. Submit them to the <a href="http://drupal.org/project/issues/uc_hosting">uc_hosting</a> or <a href="http://drupal.org/project/issues/hostmaster">hostmaster</a> issue queues instead.</em></strong></p>

<script type="text/javascript">toc_collapse=0;</script><div class="toc" id="toc3">
<div class="toc-title">Table of Contents<span class="toc-toggle-message">&nbsp;</span></div>
<div class="toc-list">
<ol>
	<li class="toc-level-1"><a href="#Drupal_6_uc_hosting_1.0"><span class="toc-number">1. </span>Drupal 6 / uc_hosting 1.0</a>
<ol>
	<li class="toc-level-2"><a href="#Goals"><span class="toc-number">1.1. </span>Goals</a>
<ol>
	<li class="toc-level-3"><a href="#Single_site_products"><span class="toc-number">1.1.1. </span>Single site products</a></li>
	<li class="toc-level-3"><a href="#Multi_site_packages"><span class="toc-number">1.1.2. </span>Multi site packages</a></li>
	<li class="toc-level-3"><a href="#Recurring_payments"><span class="toc-number">1.1.3. </span>Recurring payments</a></li>
</ol>
</li>
	<li class="toc-level-2"><a href="#Nice-to-haves"><span class="toc-number">1.2. </span>Nice-to-haves</a>
<ol>
	<li class="toc-level-3"><a href="#Purchasing_wizard"><span class="toc-number">1.2.1. </span>Purchasing wizard</a></li>
	<li class="toc-level-3"><a href="#Make_it_unnecessary_to_log_single-site_purchasers_into_the_aegir_site"><span class="toc-number">1.2.2. </span>Make it unnecessary to log single-site purchasers into the aegir site</a></li>
	<li class="toc-level-3"><a href="#Deferred_payments"><span class="toc-number">1.2.3. </span>Deferred payments</a></li>
</ol>
</li>
</ol>
</li>
	<li class="toc-level-1"><a href="#Drupal_7_uc_hosting_2.0"><span class="toc-number">2. </span>Drupal 7 / uc_hosting 2.0</a>
<ol>
	<li class="toc-level-2"><a href="#Goals-1"><span class="toc-number">2.1. </span>Goals</a>
<ol>
	<li class="toc-level-3"><a href="#Remote_storefronts"><span class="toc-number">2.1.1. </span>Remote storefronts</a></li>
</ol>
</li>
	<li class="toc-level-2"><a href="#Nice-to-haves-2"><span class="toc-number">2.2. </span>Nice-to-haves</a>
<ol>
	<li class="toc-level-3"><a href="#Desjardins_recurring_payments"><span class="toc-number">2.2.1. </span>Desjardins recurring payments</a></li>
	<li class="toc-level-3"><a href="#Importable_demo_products"><span class="toc-number">2.2.2. </span>Importable demo products</a></li>
	<li class="toc-level-3"><a href="#Simple_procedure_to_deny_user_1_to_certain_clients"><span class="toc-number">2.2.3. </span>Simple procedure to deny user 1 to certain clients</a></li>
</ol>
</li>
</ol>
</li>
	<li class="toc-level-1"><a href="#Wishlist:"><span class="toc-number">3. </span>Wishlist:</a></li>
	<li class="toc-level-1"><a href="#Unanswered_Questions"><span class="toc-number">4. </span>Unanswered Questions</a></li>
</ol>
</div>
</div>

<h1 id="Drupal_6_uc_hosting_1.0">1. Drupal 6 / uc_hosting 1.0</h1>

<p><strong>Aiming for compatibility with:</strong></p>

<ul>
<li>Hostmaster 1.0</li>
<li>Ubercart 2.4</li>
</ul>

<p><strong>Structure:</strong></p>

<ul>
<li><strong>uc_hosting</strong>: This implements shared functions and classes, including the function to create a client based on an ubercart order and product.</li>
<li><strong>uc_hosting_products</strong>: This is where we put the ubercart function calls, attribute generation, etc... This module is intended to be used alone for the "my ubercart is on my aegir site" scenario.</li>
</ul>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Goals">1.1. Goals</h2>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Single_site_products">1.1.1. Single site products</h3>

<p>In.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Multi_site_packages">1.1.2. Multi site packages</h3>

<p>In.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Recurring_payments">1.1.3. Recurring payments</h3>

<p>We need to test the module using uc_recurring.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Nice-to-haves">1.2. Nice-to-haves</h2>

<p>Given where we are at now, this stuff will most likely not make it in until an eventual 1.1 release. The exception being Hadsie's work on "try before you buy".</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Purchasing_wizard">1.2.1. Purchasing wizard</h3>

<p>Stills needs to be developed. The create my site now option is a start and is already in.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Make_it_unnecessary_to_log_single-site_purchasers_into_the_aegir_site">1.2.2. Make it unnecessary to log single-site purchasers into the aegir site</h3>

<p>Needs some testing but should be doable. Maybe just needs a little documentation. I believe Hadsie's work is related to this.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Deferred_payments">1.2.3. Deferred payments</h3>

<p>Ergonlogic is working on this.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h1 id="Drupal_7_uc_hosting_2.0">2. Drupal 7 / uc_hosting 2.0</h1>

<p>We are still unsure about whether to support commerce, ubercart, or both with this module. We will most likely wait until development on the D7 port of aegir starts before beginning this work so we will see then what the landscape looks like.</p>

<p><strong>Aiming for compatibility with:</strong></p>

<ul>
<li>Hostmaster 2.x</li>
<li>Ubercart 3.x, or Commerce 1.x (maybe both?)</li>
</ul>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Goals-1">2.1. Goals</h2>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Remote_storefronts">2.1.1. Remote storefronts</h3>

<p>Hopefully, this will be supported by plans for new xmlrpc methods in the hostmaster signup module.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Nice-to-haves-2">2.2. Nice-to-haves</h2>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Desjardins_recurring_payments">2.2.1. Desjardins recurring payments</h3>

<p>This is a seperate module being developed by Koumbit.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Importable_demo_products">2.2.2. Importable demo products</h3>

<p>This would be really great.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Simple_procedure_to_deny_user_1_to_certain_clients">2.2.3. Simple procedure to deny user 1 to certain clients</h3>

<p>Ergonlogic has published a module that should make this possible: <a href="http://drupal.org/project/hosting_profile_roles" title="http://drupal.org/project/hosting_profile_roles">http://drupal.org/project/hosting_profile_roles</a>.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h1 id="Wishlist:">3. Wishlist:</h1>

<ul>
<li>A decent ubercart import function (see <a href="http://www.sthlmconnection.se/tips-and-tweaks/exportable-configuration-ctools-revisited">this</a> and <a href="http://stellapower.net/content/using-chaos-tools-module-create-exportables">this</a>... <a href="http://drupal.org/node/349408">this</a> and maybe <a href="http://drupal.org/node/590956">this</a>)</li>
</ul>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h1 id="Unanswered_Questions">4. Unanswered Questions</h1>

<ol>
<li>Will the Drupal 7 version use Ubercart or Commerce? Both? Neither?</li>
<li>How and when will people be billed? And what degree of control will uc_hosting offer over that?</li>
<li>Aegir has clients &amp; UC has clients. How are they related/distinct? How do we keep this clear to users/admins?</li>
</ol><div class="toc-back-to-top"><a href="#toc">Back to top</a></div><script type="text/javascript">toc_scroll_back_to_top = 1;</script>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-423.html?destination=node%2F108%23comment-form">Login</a> or <a href="../../../../../user/register/index-423.html?destination=node%2F108%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../108/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-707" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../creating-product-features-using-uchosting-1x/index.html">Creating product features using uc_hosting 1.x</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_27 first last"><a href="../../../../../category/level/developer/index.html" rel="tag" title="This level is generally for users interested in further developing the Aegir system itself, or extending it with contributed modules.">Developer</a></li>
</ul></div><p>This document assumes you want to implement a product feature using uc_hosting's database tables and exiting infrastructure. For a more complete example of an Ubercart 2.x product feature implementation, check out uc_file in the Ubercart core.</p>

<h2>The Basics</h2>

<p>Any module implementing a uc_hosting feature should include both uc_hosting and uc_hosting_products as dependencies. Include these lines in your .info file:</p>

<pre><code>dependencies[] = uc_hosting
dependencies[] = uc_hosting_products
</code></pre>

<h2>Declaring product features to Ubercart 2.x</h2>

<p>The first step is to implement Ubercart's hook_product_feature. Here is an example implementation for the platform access feature in uc_hosting_products:</p>

<pre><code>/**
 * Implementation of hook_product_feature().
 */
function uc_hosting_products_product_feature () {
  $features = array();

  // Set the feature for the platforms
  $features[] = array(
    'id' =&gt; 'hosting_platform',
    'title' =&gt; t('Access to a platform'),
    'callback' =&gt; 'uc_hosting_products_platform_form',
    'delete' =&gt; 'uc_hosting_products_feature_delete',
    'settings' =&gt; 'uc_hosting_products_platform_settings',
  );

  return $features;
}
</code></pre>

<p>An implementation of hook_product_feature returns a numerical array of associative arrays. Feature arrays must include five keys:</p>

<ul>
<li><strong>id</strong> will be used to identify your feature at the database level, in the uc_product_features table, and also in urls. Think of it as the type of your feature.</li>
<li><strong>title</strong> is the name of your feature as it will be displayed to site admins.</li>
<li><strong>callback</strong> will be used to create and modify instances of your feature attached to specific products. This callback should return a drupal form passed through the uc_product_feature_form function.</li>
<li><strong>delete</strong> is a simple function called on the removal of a feature instance from a product.</li>
<li><strong>settings</strong> is a callback that provides additional settings for the feature, and is not used presently in any uc_hosting product feature.</li>
</ul>

<p>Of note is that, unlike Drupal's core hook_menu and hook_theme, hook_product_feature does not include a 'file' key. uc_hosting works around this by using include_once at the beginning of the hook_product_feature implementation.</p>

<p>If you wish to use uc_hosting's shared feature functions, make sure to include the file "products/inc/uc_hosting_products.feature_shared.inc" (path relative to the uc_hosting root) at the beginning of your implementation of hook_product_feature.</p>

<h2>The callback form</h2>

<p>This form is called everytime someone adds a product feature to a product. It allows you to set any options for your feature that should be delivered on a per-product basis. Lets take a look at this function for the platform access feature:</p>

<pre><code>/**
 * Callback to add the platform form on the product feature page
 */
function uc_hosting_products_platform_form ($form_state, $node, $feature) {
  $form = array();

  // Get default values and shared form elements for all uc_hosting features
  $hosting_product = _uc_hosting_products_feature_fetch_product($feature);
  if (empty($feature)) {
    $feature = array('id' =&gt; 'hosting_platform');
  }
</code></pre>

<p>_<strong>uc_hosting_products_feature_fetch_product</strong> attempts to retrieve existing values for this instance of a product feature from the database.</p>

<pre><code>  _uc_hosting_products_feature_shared_elements(&amp;$form, $node, $feature, $hosting_product);
</code></pre>

<p>_<strong>uc_hosting_products_feature_shared_elements</strong> declares some form elements that either uc_hosting or Ubercart itself depend on to provide the product feature functionality.</p>

<pre><code>  // @see _hosting_get_platforms()
  if (user_access('view locked platforms')) {
    $platforms = _hosting_get_platforms();
  }
  else if (user_access('view platform')) {
    $platforms = _hosting_get_enabled_platforms();
  }
  else {
    $platforms = array();
    drupal_set_message('You must have permission to access platforms to enable this feature.', 'warning');
  }

  $form['platform'] = array(
    '#type' =&gt; 'select',
    '#title' =&gt; t('Platform'),
    '#description' =&gt; t('Select the platform to associate with this product.'),
    '#default_value' =&gt; $hosting_product-&gt;value,
    '#options' =&gt; $platforms,
    '#required' =&gt; TRUE,
  );
</code></pre>

<p>This code block generates a list of platforms to allow the admin to select which platform to bind to his product. This code is specific to the platform access implementation - this is where you should include your own form elements relevant to your feature.</p>

<pre><code>  $form['#validate'][] = 'uc_hosting_products_single_feature_validate';
</code></pre>

<p>For many implementations, <strong>uc_hosting_products_single_feature_validate</strong> ensures that a given uc_hosting product feature can only be enabled once on any given product. All of the exising uc_hosting_products features make use of this function.</p>

<pre><code>  return uc_product_feature_form ($form);
}
</code></pre>

<p>Finally, <strong>uc_product_feature_form</strong> adds some required form elements from Ubercart.</p>

<p>You also need to make sure to code a submit function for your callback, of the form callback_submit:</p>

<pre><code>/**
 * Save the platform feature settings.
 */
function uc_hosting_products_platform_form_submit($form, &amp;$form_state) {
  $hosting_product = array(
    'pfid' =&gt; $form_state['values']['pfid'],
    'model' =&gt; $form_state['values']['model'],
    'type' =&gt; 'platform',
    'value' =&gt; $form_state['values']['platform'],
  );

  $platform_node = node_load($hosting_product['value']);
  $description = t('&lt;strong&gt;SKU:&lt;/strong&gt; !sku&lt;br /&gt;', array('!sku' =&gt; empty($hosting_product['model']) ? 'Any' : $hosting_product['model']));
  $description .= t('&lt;strong&gt;Platform:&lt;/strong&gt; !platform', array('!platform' =&gt; $platform_node-&gt;title));

  $data = array(
    'pfid' =&gt; $form_state['values']['pfid'],
    'nid' =&gt; $form_state['values']['nid'],
    'fid' =&gt; 'hosting_platform',
    'description' =&gt; $description,
  );

  $form_state['redirect'] = uc_product_feature_save($data);
</code></pre>

<p>We manually save the product_feature to ubercart's database tables here. This is so that we can then retrieve the index of the entry in the uc_product_features table for later use in our own data.</p>

<pre><code>  // Insert or update uc_hosting_products table
  if (empty($hosting_product['pfid'])) {
    $hosting_product['pfid'] = db_last_insert_id('uc_product_features', 'pfid');
  }

  $existing_prod = db_fetch_object(db_query("SELECT hpid, data FROM {uc_hosting_products} WHERE pfid = %d LIMIT 1", $hosting_product['pfid']));

  $key = NULL;
  if ($existing_prod-&gt;hpid) {
    $key = 'hpid';
    $hosting_product['hpid'] = $existing_prod-&gt;hpid;
    $hosting_product['data'] = unserialize($existing_prod-&gt;data);
    $hosting_product['data']['platform'] = $hosting_product['value'];
  }
  // If necessary build a data array from scratch
  else {
    $hosting_product['data'] = array(
      'platform' =&gt; $hosting_product['value'],
    );
  }

  $hosting_product['data'] = serialize($hosting_product['data']);

  drupal_write_record('uc_hosting_products', $hosting_product, $key);
}
</code></pre>

<p>Note that the uc_hosting_products table has both an integer column <strong>value</strong>, and a longtext column <strong>data</strong> for storing serialized information about the feature.</p>

<h2>Taking action in Aegir based on product features</h2>

<p>uc_hosting assumes that most purchases made via Ubercart are intended to be expressed as changes to an Aegir client node. So it provides some code to help you create new clients or modify exiting ones when an order containing your feature is made. Any other actions needed to make your feature work you will need to implement yourself. This will involve implementing the Ubercart hook, <a href="http://api.ubercart.org/api/function/hook_order/2">hook_order</a> and your own callback function.</p>

<p>Lets start by taking a look at uc_hosting_products own implementation of hook_order:</p>

<pre><code>/**
 * Implementation of hook_order
 *
 * Actions t$form_state['values']['create_later']o take on order changes involving an aegir product
 *
 * @param $op string
 *   Provided by ubercart on invocation
 * @param &amp;$arg1
 *   Different data depending on the op
 * @param $arg2
 *   Different data depending on the op
 */
function uc_hosting_products_order ($op, &amp;$arg1, $arg2) {
  switch ($op) {
    case 'update':
      if ($arg2 == 'completed') {
        foreach ($arg1-&gt;products as $product) {
          if (_uc_hosting_products_has_feature ($product)) {
            // Make the changes necessary to the hosting client
            $client = uc_hosting_update_client($arg1, $product, 'uc_hosting_products_client_update');
          }
        }
      }
      break;
    default:
      break;
  }
}
</code></pre>

<p>_<strong>uc_hosting_products_has_feature</strong> is defined in uc_hosting_products.module, and provides some simple logic to detect uc_hosting product features. Rather than use this function, you will most likely want to define your own conditions.</p>

<p><strong>uc_hosting_update_client</strong> does the work of matching up an incoming ubercart order to an existing Aegir client, if possible. If not possible, it creates a new client node. It then calls the function provided as a third argument, in this case uc_hosting_products_client_update, and passes to that function the affected client node, as well as the product and order objects from Ubercart.</p>

<p>This callback function is the place to take actions in Aegir or pass commands. Take a look at uc_hosting_products for a fully fleshed out example.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-210.html?destination=node%2F707%23comment-form">Login</a> or <a href="../../../../../user/register/index-210.html?destination=node%2F707%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-210.html?destination=node%2F707%23comment-form">Login</a> or <a href="../../../../../user/register/index-210.html?destination=node%2F707%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-2825" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/contrib/class-auto-loading/index.html">Class auto-loading</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_27 first last"><a href="../../../../../category/level/developer/index.html" rel="tag" title="This level is generally for users interested in further developing the Aegir system itself, or extending it with contributed modules.">Developer</a></li>
</ul></div><p>Provision has been refactored in 6.x-2.x to use class auto-loading. This simplifies use of classes, as it obviates the need to explicitly include the files in which the class and it's parent classes are defined. In addition, it standardizes the placement of class definitions within a hierarchical file-system structure and will make name-spacing simpler if/when we begin to adopt Symfony components.</p>

<p>While not strictly required in contributed modules, it is highly encouraged. If you maintain a contributed Provision extension, some re-factoring will be required to support class auto-loading.</p>

<p>First off, you'll need to add a registration function that will enable Provision to autoload your extensions classes. Here's an example from provision_civicrm:</p>

<p><div class="codeblock"><code>/**<br /> * Register our directory as a place to find Provision classes.<br /> *<br /> * This allows Provision to autoload our classes, so that we don&#039;t need to<br /> * specifically include the files before we use the class.<br /> */<br />function civicrm_provision_register_autoload() {<br />&nbsp; static $loaded = FALSE;<br />&nbsp; if (!$loaded) {<br />&nbsp;&nbsp;&nbsp; $loaded = TRUE;<br />&nbsp;&nbsp;&nbsp; $list = drush_commandfile_list();<br />&nbsp;&nbsp;&nbsp; $provision_dir = dirname($list[&#039;provision&#039;]);<br />&nbsp;&nbsp;&nbsp; include_once($provision_dir . &#039;/provision.inc&#039;);<br />&nbsp;&nbsp;&nbsp; include_once($provision_dir . &#039;/provision.service.inc&#039;);<br />&nbsp;&nbsp;&nbsp; provision_autoload_register_prefix(&#039;Provision_&#039;, dirname(__FILE__));<br />&nbsp; }<br />}</code></div></p>

<p>Next, your extension will need to call your new function in a hook_drush_init(), so that it is run as early as possible during a Drush bootstrap.</p>

<p><div class="codeblock"><code>/**<br /> * Implements hook_drush_init().<br /> */<br />function provision_civicrm_drush_init() {<br />&nbsp; // Register our service classes for autoloading.<br />&nbsp; civicrm_provision_register_autoload();<br />&nbsp; ...</code></div></p>

<p>Finally, you can move your class definitions into the proper file-system structure. In provision_civicrm, we defined a new (stub) service to allow saving data from the front-end into a site context (entity/alias). So, we created a file at Provision/Service/civicrm.php that included the class definition:</p>

<p><div class="codeblock"><code>/<strong><br /> * The civicrm service base class.<br /> */<br />class Provision_Service_civicrm extends Provision_Service {<br />&nbsp; public $service = &#039;civicrm&#039;;<br /><br />&nbsp; /</strong><br />&nbsp;&nbsp; * Add the civicrm_version property to the site context.<br />&nbsp;&nbsp; */<br />&nbsp; static function subscribe_site($context) {<br />&nbsp;&nbsp;&nbsp; $context-&gt;setProperty(&#039;civicrm_version&#039;);<br />&nbsp; }<br />}</code></div></p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-211.html?destination=node%2F2825%23comment-form">Login</a> or <a href="../../../../../user/register/index-211.html?destination=node%2F2825%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-211.html?destination=node%2F2825%23comment-form">Login</a> or <a href="../../../../../user/register/index-211.html?destination=node%2F2825%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-879" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../contrib/customizing-platform-templates/index.html">Customizing Platform Templates</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>Non-standard Aegir installs may require adjustments to the default configurations for a platform that are defined by Aegir during the creation of a platform. These templates can be found in /home/aegir/.drush/provision.</p>

<p>Editing the actual templates prevents Aegir from overwriting your customizations when the verify task is run on an live platform.</p>

<p>Below are examples of customizations made to non-standard Aegir installs</p>

<h2>Running an Aegir platform on a unix socket for php-fpm on Nginx</h2>

<p>First let's find out where provision has the default config templates for our platfom.
<div class="codeblock"><code>[root@host]cd /home/aegir/.drush; grep -nir &quot;fastcgi_pass&quot; --exclude=&#42;.svn&#42; *<br />provision/http/nginx/nginx_advanced_include.conf:227:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_advanced_include.conf:360:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_simple_include.conf:213:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_simple_include.conf:346:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000</code></div>
We can see that the config templates for Nginx direct all php requests to port 9000 on the localhost I.P. Let's change that to a unix socket (which avoids the slight delay associated with tcp connections).
After commenting out those lines and adding our custom lines which will use a unix socket instead of a tcp port, we get..
<div class="codeblock"><code>provision/http/nginx/nginx_advanced_include.conf:227:&nbsp;&nbsp;&nbsp; #&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_advanced_include.conf:228:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;<br />provision/http/nginx/nginx_advanced_include.conf:361:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_advanced_include.conf:362:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;<br />provision/http/nginx/nginx_simple_include.conf:213:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_simple_include.conf:214: fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;<br />provision/http/nginx/nginx_simple_include.conf:347:#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm lis#tening on port 9000<br />provision/http/nginx/nginx_simple_include.conf:348:&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;</code></div></p>

<p>Remember to do the same to your platform config files in /home/aegir/config/includes. Next time you verify your platform your customizations will remain after verification.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-212.html?destination=node%2F879%23comment-form">Login</a> or <a href="../../../../../user/register/index-212.html?destination=node%2F879%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-212.html?destination=node%2F879%23comment-form">Login</a> or <a href="../../../../../user/register/index-212.html?destination=node%2F879%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-935" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/contrib/passing-values-site-drushrcphp-file-during-migrations/index.html">Passing values into the site drushrc.php file during migrations</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>It's possible rely to on manipulating the drush context for certain tasks and using hook_post_command to make use of that data. In this case, I wanted to save values to the site's drushrc.php file.</p>

<p>Add the following code to <code>hook_post_provision_verify</code>:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">if (</span><span style="color: #0000BB">d</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">type </span><span style="color: #007700">== </span><span style="color: #DD0000">'site'</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">$val </span><span style="color: #007700">= </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'my_custom_option'</span><span style="color: #007700">);<br />&nbsp; </span><span style="color: #0000BB">drush_set_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'my_custom_option'</span><span style="color: #007700">, </span><span style="color: #0000BB">$val</span><span style="color: #007700">, </span><span style="color: #DD0000">'site'</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>This makes sure that <code>my_custom_option</code> perpetuates through these potentially destructive operations. Since it is provision-verify that writes the drushrc.php file for the site, drush options set in the site context during <code>hook_post_provision_verify</code> will be saved.</p>

<p>The final step is to make sure the verify hook is run with the appropriate options at the end of my migrate task, so add this to <code>hook_post_provision_migrate</code>.</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">if (</span><span style="color: #0000BB">d</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">type </span><span style="color: #007700">== </span><span style="color: #DD0000">'site'</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">$options </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'my_custom_option' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'my_custom_option'</span><span style="color: #007700">));<br />&nbsp; </span><span style="color: #0000BB">$target </span><span style="color: #007700">= </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'target_name'</span><span style="color: #007700">);<br />&nbsp; </span><span style="color: #0000BB">provision_backend_invoke</span><span style="color: #007700">(</span><span style="color: #0000BB">$target</span><span style="color: #007700">, </span><span style="color: #DD0000">'provision-verify'</span><span style="color: #007700">, array(), </span><span style="color: #0000BB">$options</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>I got this idea from looking at the <code>drush_provision_drupal_provision_migrate function</code> in <code>platform/migrate.provision.inc</code>.</p>

<p>I used this approach to create a <a href="http://drupal.org/node/1282200#comment-5173768">patch for provision_civicrm</a></p>

<p>This was originally <a href="http://drupal.org/node/955018#comment-5171904">documented in the provision issue queue</a>.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-213.html?destination=node%2F935%23comment-form">Login</a> or <a href="../../../../../user/register/index-213.html?destination=node%2F935%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-213.html?destination=node%2F935%23comment-form">Login</a> or <a href="../../../../../user/register/index-213.html?destination=node%2F935%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-946" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/developing/integrating-aegir/index.html">Integrating Aegir</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>This section of the documentation deals with integrating Aegir components with other services (as opposed to extending or overriding direct Aegir functionality itself).</p>

<p>Examples might include using Aegir's database to authenticate users based on their presence as 'clients' in the Aegir system, e.g authenticating FTP access to sites for clients that have those sites managed in Aegir.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-214.html?destination=node%2F946%23comment-form">Login</a> or <a href="../../../../../user/register/index-214.html?destination=node%2F946%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-214.html?destination=node%2F946%23comment-form">Login</a> or <a href="../../../../../user/register/index-214.html?destination=node%2F946%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-2789" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/content/developing/integrating-aegir/integrating-aegir-openssh/index.html">Integrating Aegir with OpenSSH</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_502 first"><a href="../../../../../category/keywords/openssh/index.html" rel="tag" title="">openssh</a></li>
<li class="taxonomy_term_503"><a href="../../../../../category/keywords/pam/index.html" rel="tag" title="">pam</a></li>
<li class="taxonomy_term_501"><a href="../../../../../category/keywords/sftp/index.html" rel="tag" title="">sftp</a></li>
<li class="taxonomy_term_91"><a href="../../../../../category/keywords/ssh/index.html" rel="tag" title="">SSH</a></li>
<li class="taxonomy_term_2 last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>Adam has written an article that explains how to hook up OpenSSH and PAM on your Linux server, so that you can authenticate your clients via the Aegir database and have them SFTP/SSH into your server and be chrooted (locked) into just seeing their sites (or a platform) with a restricted command(s) shell.</p>

<p><a href="http://www.adamtk.com/aegir-virtual-sftp-and-chrooted-ssh">Read the article here.</a></p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-215.html?destination=node%2F2789%23comment-form">Login</a> or <a href="../../../../../user/register/index-215.html?destination=node%2F2789%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-215.html?destination=node%2F2789%23comment-form">Login</a> or <a href="../../../../../user/register/index-215.html?destination=node%2F2789%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-947" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/content/developing/integrating-aegir/integrating-aegir-pureftp/index.html">Integrating Aegir with PureFTP</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>Cafuego has written an excellent article that explains how to hook up PureFTPd and PAM on your Linux server, so that you can authenticate your clients via the Aegir database and have them FTP into your server and be chrooted (locked) into just seeing their sites.</p>

<p><a href="http://cafuego.net/2011/11/08/integrating-aegir-linux-and-ftp">Read the article here.</a></p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-363.html?destination=node%2F947%23comment-form">Login</a> or <a href="../../../../../user/register/index-363.html?destination=node%2F947%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../947/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-589" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../developing/continuous-integration/index.html">Continuous Integration</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_25 first"><a href="../../../../../category/keywords/continuous-integration/index.html" rel="tag" title="">continuous integration</a></li>
<li class="taxonomy_term_24"><a href="../../../../../category/keywords/developer/index.html" rel="tag" title="">developer</a></li>
<li class="taxonomy_term_2"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
<li class="taxonomy_term_26 last"><a href="../../../../../category/keywords/testing/index.html" rel="tag" title="">testing</a></li>
</ul></div><p><strong>Testing server URL:</strong> <a href="http://ci.aegirproject.org/" title="http://ci.aegirproject.org">http://ci.aegirproject.org</a></p>

<p>Recently, mig5 <a href="http://greenbeedigital.com.au/content/discovering-jenkins-and-increasing-productivity">put together</a> a testing server based on <a href="http://jenkins-ci.org/">Jenkins</a>.</p>

<p>So what? In doing so, he's produced a tool that will allow us to spin up a temporary virtual server, drag in our codebase from Drush Make, other codebases as platforms, and do  test installs of sites on it. This should become a routine start-to-finish test of our applications, features, modules, etc. All at the click of a button (or less, by scheduling it!)</p>

<p>Currently, we have a build project that:</p>

<ul>
<li>Provisions a new VPS at Rackspace Cloud</li>
<li>Installs Aegir 6.x-1.x branch</li>
<li>Builds a Drupal 6, Drupal 7 and OpenAtrium platform using Drush Make</li>
<li>Installs a site (with respective install profiles) on all three platforms</li>
</ul>

<p>If anything fails here, an alert will come through to #aegir on Freenode. This will help us to test the Aegir install (especially to ensure our compatibility with Drush and Drush Make releases), and to identify any regressions in our own project.</p>

<p>Every 15 minutes, Jenkins will check if there's a new commit to hostmaster and provision, and if there is, fire up a new install and test a few things to find regressions.</p>

<p>We also have a build project for the most recent official release of Aegir (@TODO: test .deb installation method of Aegir for this), as well as a build that installs an earlier Aegir and then upgrades to the latest 6.x-1.x to test the upgrade path.</p>

<p>Also, steven has created a <a href="https://drupal.org/sandbox/darthsteven/1286014">sandbox</a> to host the code that runs the tests on the jenkins server.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-425.html?destination=node%2F589%23comment-form">Login</a> or <a href="../../../../../user/register/index-425.html?destination=node%2F589%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../589/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-12855" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/developing/despamming-guide/index.html">Despamming guide</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>We have seen numerous waves of spam on this site. At first we setup <a href="../../../../410/index.html">mollom, in 2011</a> but sometimes it is not enough.</p>

<h1>Current practices</h1>

<p>The very first step is to identify the user account and disable it (<em>not</em> delete it, we need it to find the content to remove).</p>

<p>Views Bulk Operations views used for despamming:</p>

<ul>
<li><a href="../../../../../admin/content/comment/spam/index.html">comments</a></li>
<li><a href="../../../../../admin/content/node/spam/index.html">nodes</a></li>
</ul>

<p>Note that this will flood your screen with <code>drupal_set_message</code> for every page that is deleted, which may make the site difficult to use for a while. To top that, the final page will list the name of every page that was removed, just to make sure you had enough spam for the day.</p>

<p>You can also use the <a href="../../../../../admin/content/node/index.html">regular comment view to delete content and report it to mollom</a> if you are patient enough.</p>

<p>You can also delete the account if you are motivated and want to grind that specific axe. Look at the <a href="../../../../../admin/user/user/index.html?sort=desc&amp;order=Member+for">regular user listing</a> for the latest user accounts created.</p>

<h1>Other ideas</h1>

<ul>
<li><a href="https://www.drupal.org/project/httpbl">http:BL</a> - used on Drupal.org</li>
<li><a href="https://www.drupal.org/project/blogspam">blogspam</a> - used on debian-administration.org, but <a href="https://www.drupal.org/node/2090911">not ported to new API</a></li>
<li><a href="https://www.drupal.org/project/spambot">spambot</a> - similar</li>
<li><a href="https://www.drupal.org/project/rate">rate</a> - may be used to process small amounts of spam by the community</li>
<li><a href="https://www.drupal.org/project/botcha">botcha</a></li>
</ul>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-216.html?destination=node%2F12855%23comment-form">Login</a> or <a href="../../../../../user/register/index-216.html?destination=node%2F12855%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-216.html?destination=node%2F12855%23comment-form">Login</a> or <a href="../../../../../user/register/index-216.html?destination=node%2F12855%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>



    </div>
      </div>
</body>


<!-- Mirrored from community.aegirproject.org/node/5/revisions/209/view?print&book_recurse by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 29 Jul 2015 17:40:15 GMT -->
</html>
