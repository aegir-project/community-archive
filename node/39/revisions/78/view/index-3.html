<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<!-- Mirrored from community.aegirproject.org/node/39/revisions/78/view?print&book_recurse by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 29 Jul 2015 18:05:55 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="prev" href="../../../../../dnswildcard/index.html" />
<link rel="up" href="../../../../../content/administrator/post-install-configuration/index.html" />
<link rel="next" href="../../../../73/index.html" />
<link rel="prev" href="../../../../../dnswildcard/index.html" />
<link rel="up" href="../../../../../content/administrator/post-install-configuration/index.html" />
<link rel="next" href="../../../../73/index.html" />
<link rel="canonical" href="index.html" />
<link rel="prev" href="../../../index.html" />
<link rel="up" href="../../../index.html" />
<link rel="next" href="../../../../72/index.html" />
<link rel="prev" href="../../../../73/index.html" />
<link rel="up" href="../../../index.html" />
<link rel="next" href="../../../../70/index.html" />
<link rel="prev" href="../../../../72/index.html" />
<link rel="up" href="../../../index.html" />
<link rel="next" href="../../../../../content/overriding-site-specific-php-values/index.html" />
<link rel="prev" href="../../../../70/index.html" />
<link rel="up" href="../../../../70/index.html" />
<link rel="next" href="../../../../71/index.html" />
<link rel="prev" href="../../../../../content/overriding-site-specific-php-values/index.html" />
<link rel="up" href="../../../index.html" />
<link rel="next" href="../../../../../content/injecting-drushrcphp/index.html" />
<link rel="prev" href="../../../../71/index.html" />
<link rel="up" href="../../../index.html" />
<link rel="next" href="../../../../../contrib-modules/index.html" />
<link rel="shortcut icon" href="../../../../../sites/community.aegirproject.org/themes/up/favicon/index.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="print" href="../../../../../sites/community.aegirproject.org/files/css/css_5fa73dc3677977c016a597acd186e4e7/index.css" />
<link type="text/css" rel="stylesheet" media="all" href="../../../../../sites/community.aegirproject.org/files/css/css_5fa73dc3677977c016a597acd186e4e7/index.css" />

  <title>Revision of Hooking into Aegir (site overrides) from Wed, 10/27/2010 - 09:12 | community.aegirproject.org</title>
</head>

<body  class="print rubik admin-static page">
  <div class='limiter clear-block'>
    <div id='content' class='clear-block'>
      <div class='print-header'>
      <h1 class='site-name'>community.aegirproject.org</h1>
  </div>
      

<div  id="node-39" class="node node-book clear-block node-page">
  
      <h2 class='node-title'>
            <a href="../../../index.html">Hooking into Aegir (site overrides)</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div id='diff-inline-39'><p>..for explanations/tips on how to use global.inc, local.settings.php and the <code>provision_apache_dir_config</code> hook</p></div>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-59.html?destination=node%2F39%23comment-form">Login</a> or <a href="../../../../../user/register/index-59.html?destination=node%2F39%23comment-form">register</a> to post comments</span></li>
<li class="print active"><a href="index-2.html?print" class="active">Print</a></li>
<li class="print_recurse active"><a href="index-3.html?print&amp;book_recurse" class="active">Print entire section</a></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-59.html?destination=node%2F39%23comment-form">Login</a> or <a href="../../../../../user/register/index-59.html?destination=node%2F39%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>



<div  id="node-73" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../73/index.html">Injecting into server-wide vhosts</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>Changing <em>maximum filesize upload</em> is common when setting up sites in Drupal. As described in <a href="../../../../990/index.html">Overriding site-specific PHP values</a> you can change this value for each site created with Ægir by adding a .drush.inc file in /var/aegir/.drush directory. But wouldn´t it be nice to be able to do it side-wide?</p>

<p>Here below is the same code from ergonlogic demonstrating how to create a <em>domainname</em>.drush.inc file using the domain name as a condition before the code injection.</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />&nbsp; </span><span style="color: #007700">function </span><span style="color: #0000BB">ergonlogiccom_provision_apache_vhost_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; if (</span><span style="color: #0000BB">$uri </span><span style="color: #007700">== </span><span style="color: #DD0000">"ergonlogic.com"</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">drush_log</span><span style="color: #007700">(</span><span style="color: #DD0000">"Overriding PHP file size values. See .drush/ergonlogiccom.drush.inc"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return array(</span><span style="color: #DD0000">"php_value upload_max_filesize 100M"</span><span style="color: #007700">, </span><span style="color: #DD0000">"php_value post_max_size 200M"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>Apparently you can do this side-wide by omitting the IF statement and create a file with a .drush.inc extension.</p>

<p>For instance, you could create a file called <em>global_settings.drush.inc</em> and put in the following code:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />&nbsp; </span><span style="color: #007700">function </span><span style="color: #0000BB">globalsettings_provision_apache_vhost_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">drush_log</span><span style="color: #007700">(</span><span style="color: #DD0000">"Overriding PHP file size values. See .drush/global_settings.drush.inc"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return array(</span><span style="color: #DD0000">"php_value upload_max_filesize 100M"</span><span style="color: #007700">, </span><span style="color: #DD0000">"php_value post_max_size 200M"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp; <br />&nbsp; }<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<em>* the closing ?&gt; syntax should not be used</em></p>

<p>Make sure you <strong>Verify</strong> your site after you create the file. Then scroll through the log and find the message you added in the code:</p>

<blockquote>Overriding PHP file size values. See .drush/global_settings.drush.inc</blockquote>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-60.html?destination=node%2F73%23comment-form">Login</a> or <a href="../../../../../user/register/index-60.html?destination=node%2F73%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-60.html?destination=node%2F73%23comment-form">Login</a> or <a href="../../../../../user/register/index-60.html?destination=node%2F73%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-72" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../72/index.html">Injecting into platform-wide vhosts (.htaccess)</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>Using a .htaccess with an Allow Override all directive in Apache can be a major performance killer, because it requires Apache to stat each subdirectory of the codebase looking for overrides in .htaccess.</p>

<p>As a result, Aegir disables the reading of the Drupal .htaccess in the runtime environment.</p>

<p>This does not mean that the .htaccess is not needed. Instead, when you run the Verify task against a Platform, the .htaccess is studied by Aegir and its contents are copied into the platform-wide Apache vhost configuration, typically located in /var/aegir/config/server_master/apache/platform.d</p>

<p>Need to make a modification to the .htaccess? Simple: you can simply edit it in-place as you normally would, but you must re-Verify the platform in Aegir afterward, in order for those new or modified settings to be 'loaded in' to the platform vhost file.</p>

<p>The end result is improved performance for your sites, without losing any functionality, as you can still customise the .htaccess to your liking.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-61.html?destination=node%2F72%23comment-form">Login</a> or <a href="../../../../../user/register/index-61.html?destination=node%2F72%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-61.html?destination=node%2F72%23comment-form">Login</a> or <a href="../../../../../user/register/index-61.html?destination=node%2F72%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-70" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../70/index.html">Injecting into site vhosts</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>Aegir provides some hook functions in its API, one of which allows you to inject extra configuration snippets into your Apache vhost files for sites.</p>

<h2>When would I want to do this?</h2>

<p>A good example for this is when you may need to inject a custom Rewrite rule that goes beyond what the Aegir Aliases 'redirection' feature provides.</p>

<p>Or, perhaps you have to inject some htpasswd mod_auth password protection for your site, or perhaps a CustomLog definition. The <a href="https://drupal.org/project/hosting_tasks_extra">http_basic_auth</a> module uses this. (<a href="http://drupalcode.org/project/hosting_tasks_extra.git/tree/HEAD:/http_basic_auth">code</a>)</p>

<p>Typically you'd just add what you need to the vhost file, but the problem is that Aegir manages these vhosts, and on every Verify task, will rewrite the config from a template, blowing away your changes in the process. Ouch!</p>

<p>Fortunately there is a very easy and elegant solution to this problem to save your configurations persistently across Verify tasks and the like, by means of invoking the Provision hook <code>provision_apache_vhost_config()</code>, or, if you are using Nginx, <code>provision_nginx_vhost_config()</code> (and just replace the below examples with 'nginx' instead of 'apache' where necessary). Below "mig5" is just an example, you can replace this with anything as drush looks for all *.drush.inc files in <code>~aegir/.drush</code></p>

<h2>A simple example</h2>

<p>In this example I'll inject a simple 'ErrorLog' apache definition into a vhost to save the site error logs to a file.</p>

<ol>
<li>Create a file in <code>~aegir/.drush</code> called <code>mig5.drush.inc</code>. (Choose <code>&lt;any&gt;</code> prefix for the file name <code>&lt;any&gt;.drush.inc</code>).  </li>
<li>Add this snippet of PHP to the file:
<div class="codeblock"><code> <br /> <span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />&nbsp; </span><span style="color: #007700">function </span><span style="color: #0000BB">mig5_provision_apache_vhost_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; return </span><span style="color: #DD0000">"ErrorLog /var/aegir/" </span><span style="color: #007700">. </span><span style="color: #0000BB">$uri </span><span style="color: #007700">. </span><span style="color: #DD0000">".error.log"</span><span style="color: #007700">;<br />&nbsp; }<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
(Choose <code>&lt;any&gt;</code> prefix for the function name <code>&lt;any&gt;_provision_apache_vhost_config</code>).</li>
<li><code>drush cache-clear drush</code> </li>
<li>Install a site or verify an existing one</li>
</ol>

<p>Check your site's vhost config file (in <code>/var/aegir/config/server_master/apache/vhost.d/</code>) and you'll see the line has been injected into the '#Extra configuration' area of the vhost</p>

<p><div class="codeblock"><code>&lt;VirtualHost *:80&gt;<br /><br />&nbsp; DocumentRoot /var/aegir/hostmaster-HEAD <br />&nbsp;&nbsp;&nbsp; <br />&nbsp; ServerName 1.mig5-forge.net<br />&nbsp; SetEnv db_type&nbsp; mysqli<br />&nbsp; SetEnv db_name&nbsp; 1mig5forgenet<br />&nbsp; SetEnv db_user&nbsp; 1mig5forgenet<br />&nbsp; SetEnv db_passwd&nbsp; X7KzsFhxhp<br />&nbsp; SetEnv db_host&nbsp; tardis<br />&nbsp; SetEnv db_port&nbsp; 3306<br /><br /><br /><br /># Extra configuration from modules:<br />&nbsp; ErrorLog /var/aegir/1.mig5-forge.net.error.log<br />&nbsp;&nbsp;&nbsp; # Error handler for Drupal &gt; 4.6.7<br />&nbsp;&nbsp;&nbsp; &lt;Directory &quot;/var/aegir/hostmaster-HEAD/sites/1.mig5-forge.net/files&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetHandler This_is_a_Drupal_security_line_do_not_remove<br />&nbsp;&nbsp;&nbsp; &lt;/Directory&gt;<br /><br />&lt;/VirtualHost&gt;</code></div></p>

<p>It's that simple! You can see that via the hook, we pass $uri and the drush data to the function, allowing me to abstract the site url so that each site will get its own error log. You could do extra PHP conditionals to ensure certain data only gets inserted into certain sites of a specific name.</p>

<p>To inject multiple lines instead of one, use an array, i.e</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">mig5_provision_apache_vhost_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; return array(</span><span style="color: #DD0000">"ErrorLog /var/aegir/" </span><span style="color: #007700">. </span><span style="color: #0000BB">$uri </span><span style="color: #007700">. </span><span style="color: #DD0000">".error.log"</span><span style="color: #007700">, </span><span style="color: #DD0000">"LogLevel warn"</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>The key point of this is that the file <code>~aegir/.drush/mig5.drush.inc</code> file will never be touched by Aegir, so you can rest assured your changes will be respected.</p>

<p>If you want to only inject code into a specific site, wrap your code with an if statement, i.e
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">mig5_provision_apache_vhost_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; if (</span><span style="color: #0000BB">$uri </span><span style="color: #007700">=== </span><span style="color: #DD0000">"&lt;site-name-in-aegir&gt;"</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return array(</span><span style="color: #DD0000">"ErrorLog /var/aegir/" </span><span style="color: #007700">. </span><span style="color: #0000BB">$uri </span><span style="color: #007700">. </span><span style="color: #DD0000">".error.log"</span><span style="color: #007700">, </span><span style="color: #DD0000">"LogLevel warn"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp; }<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<h2>A more advanced example</h2>

<p>Managing multiple versions of a production site can be a tricky proposition, even in Aegir.  This is particularly true when you want to use the same canonical domain name to allow users to access one such site of your choosing at any given moment.  For instance, in Aegir I might have a site named <a href="http://www.example.com/" title="www.example.com">www.example.com</a> (with an alias of example.com,) and a couple of alternates with the site names of test1.example.com and test2.example.com.  If I suddenly decide that I want my primary domain to access test1.example.com, Aegir forces me into a tedious process that ultimately results in site downtime – I have to delete or migrate the existing <a href="http://www.example.com/" title="www.example.com">www.example.com</a> site to a new unused site name (or clone it to an unused site name, and delete the original) and then I have to migrate test1.example.com to the vacated site name <a href="http://www.example.com/" title="www.example.com">www.example.com</a>.  Alternatively, I could add the <a href="http://www.example.com/" title="www.example.com">www.example.com</a> and example.com aliases to test1.example.com but then my users would just be redirected to test1.example.com.</p>

<p>Given the way Aegir manages aliases, it would actually be easier to make this switch if the desired address was never used as a site name to begin with.  Instead of having the site name <a href="http://www.example.com/" title="www.example.com">www.example.com</a> alongside of the two other test sites, we might have live.example.com, with in-use aliases of <a href="http://www.example.com/" title="www.example.com">www.example.com</a> and example.com, and a rewrite instruction in the vhost that rewrites live.example.com to <a href="http://www.example.com/" title="www.example.com">www.example.com</a>.  If we could easily change the rewrite instructions in that vhost, all we would need to do is move the aliases from one site to the next in the GUI (with the requisite verify tasks executed on each site in question) in order to quickly change which site was being loaded at any given moment by <a href="http://www.example.com/" title="www.example.com">www.example.com</a>.  For example, if I wanted to move to test2.example.com, I would remove the <a href="http://www.example.com/" title="www.example.com">www.example.com</a> and example.com aliases from live.example.com and verify, add those aliases to test2.example.com and verify, and change my vhost so that test2 .example.com is rewritten as <a href="http://www.example.com/" title="www.example.com">www.example.com</a>.  Since as previously mentioned Aegir overwrites changes to the vhost during the verify process, the solution is to use the provision_apache_vhost_config hook in a drush.inc file to selectively add the rewrite information to the vhost when verifying the site that we want our canonical domain to refer to.</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">aliasredirects_provision_apache_vhost_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// the uri to check here is the name of the site in Aegir<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #007700">if (</span><span style="color: #0000BB">$uri </span><span style="color: #007700">=== </span><span style="color: #DD0000">"test2.example.com"</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$rval</span><span style="color: #007700">[] = </span><span style="color: #DD0000">""</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$rval</span><span style="color: #007700">[] = </span><span style="color: #DD0000">"# Forces redirect to one uri"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$rval</span><span style="color: #007700">[] = </span><span style="color: #DD0000">"RewriteEngine On"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// if the host is not example.com <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$rval</span><span style="color: #007700">[] = </span><span style="color: #DD0000">"RewriteCond %{HTTP_HOST} !^example.com$ [NC]"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">// rewrite to example.com with a 301 redirect<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$rval</span><span style="color: #007700">[] = </span><span style="color: #DD0000">"RewriteRule ^(.*)$ http://example.com$1 [R=301,L]"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$rval</span><span style="color: #007700">[] = </span><span style="color: #DD0000">""</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">$rval</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp; }<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
When we want to switch again, say to test1.example.com, We could update the code to look for the test1.example.com uri.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-310.html?destination=node%2F70%23comment-form">Login</a> or <a href="../../../../../user/register/index-310.html?destination=node%2F70%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../70/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-990" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/overriding-site-specific-php-values/index.html">Overriding site-specific PHP values</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_27 first"><a href="../../../../../category/level/developer/index.html" rel="tag" title="This level is generally for users interested in further developing the Aegir system itself, or extending it with contributed modules.">Developer</a></li>
<li class="taxonomy_term_2 last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>Sometimes it is useful to override certain PHP values on a per-site basis, but changes to <code>php.ini</code> are generally server-wide. Depending on the value you want to override, a couple of options present themselves.</p>

<p>First, let's consider where PHP values can be changed. <a href="http://www.php.net/manual/en/ini.list.php" title="http://www.php.net/manual/en/ini.list.php">http://www.php.net/manual/en/ini.list.php</a> lists <code>php.ini</code> directives, and under the "Changeable" column, indicates <a href="http://www.php.net/manual/en/configuration.changes.modes.php">where a configuration setting may be set</a>. If your value shows either <code>PHP_INI_USER</code> or <code>PHP_INI_ALL</code>, then the easiest way to change this value would be using <code>ini_set()</code> in a <code>local.settings.php</code>:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /> </span><span style="color: #007700">@</span><span style="color: #0000BB">ini_set</span><span style="color: #007700">(</span><span style="color: #DD0000">'memory_limit'</span><span style="color: #007700">, </span><span style="color: #DD0000">'128M'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>On the other hand, if the changes mode is either <code>PHP_INI_PERDIR</code> or <code>PHP_INI_SYSTEM</code>, <code>php_ini()</code> won't work. In this case, the solution is to inject the value into the vhost. Since vhosts are managed by Aegir, manually adding an override to <code>/var/aegir/config/server_master/apache/vhost.d/&lt;uri&gt;</code> would get blown away the next time that the site is verified.</p>

<p>As described in <a href="../../../../70/index.html">Injecting into site vhosts</a>, we can inject values into vhosts using a Drush hook. For example, to raise the file upload size limit on <a href="http://ergonlogic.com/" title="http://ergonlogic.com">http://ergonlogic.com</a>, I added the following code in <code>/var/aegir/.drush/ergonlogiccom.drush.inc</code>:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />&nbsp; </span><span style="color: #007700">function </span><span style="color: #0000BB">ergonlogiccom_provision_apache_vhost_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; if (</span><span style="color: #0000BB">$uri </span><span style="color: #007700">== </span><span style="color: #DD0000">"ergonlogic.com"</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">drush_log</span><span style="color: #007700">(</span><span style="color: #DD0000">"Overriding PHP file size values. See .drush/ergonlogiccom.drush.inc"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return array(</span><span style="color: #DD0000">"php_value upload_max_filesize 100M"</span><span style="color: #007700">, </span><span style="color: #DD0000">"php_value post_max_size 200M"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>This results in the insertion of the following lines into <code>/var/aegir/config/server_master/apache/vhost.d/ergonlogic.com</code>:
<div class="codeblock"><code>php_value upload_max_filesize 100M<br />php_value post_max_size 200M</code></div></p>

<p>Also, in the verify task log I get the following informative message:
<div class="codeblock"><code>Overriding PHP file size values. See .drush/ergonlogiccom.drush.inc</code></div></p>

<p>One challenge this technique may present is inspecting the values of the parameters passed into this function. It appears that the Hostmaster site doesn't get bootstrapped, and so common debugging tools (such as devel.module's <a href="http://api.drupal.org/api/devel/devel.module/function/dd/6">dd()</a>) aren't available. However <a href="http://api.drush.ws/api/function/drush_log/4.x">drush_log()</a> is, and when called, will push arbitrary messages back into your Aegir site's verify task log.</p>

<p>So sticking the following into the function above can help:
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />&nbsp;&nbsp;&nbsp; drush_log</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$uri</span><span style="color: #DD0000">: " </span><span style="color: #007700">. </span><span style="color: #0000BB">print_r</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-62.html?destination=node%2F990%23comment-form">Login</a> or <a href="../../../../../user/register/index-62.html?destination=node%2F990%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-62.html?destination=node%2F990%23comment-form">Login</a> or <a href="../../../../../user/register/index-62.html?destination=node%2F990%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-71" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../71/index.html">Injecting into settings.php</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><h3>Introduction</h3>

<p>Every web site in an Aegir environment has a Drupal configuration file <code>settings.php</code> in /sites/example.com directory.  Web administrators often need to make changes to this file; however, the Aegir system also manages this file and any manual customizations will be lost when a site is verified.</p>

<p>Fortunately, there are two mechanisms to ensure that your customizations can be preserved.  If you look in the bottom of an Aegir <code>settings.php</code> file you will see references to two files <code>local.settings.php</code> and <code>global.inc</code>.</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />&nbsp; </span><span style="color: #FF8000"># Additional host wide configuration settings. Useful for safely specifying configuration settings.<br />&nbsp; </span><span style="color: #007700">if (</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #DD0000">'/var/aegir/config/includes/global.inc'</span><span style="color: #007700">)) {<br />&nbsp;&nbsp;&nbsp; include_once(</span><span style="color: #DD0000">'/var/aegir/config/includes/global.inc'</span><span style="color: #007700">);<br />&nbsp; }<br /><br />&nbsp; </span><span style="color: #FF8000"># Additional site configuration settings. Allows to override global settings.<br />&nbsp; </span><span style="color: #007700">if (</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #DD0000">'/var/aegir/example-platform/sites/example.com/local.settings.php'</span><span style="color: #007700">)) {<br />&nbsp;&nbsp;&nbsp; include_once(</span><span style="color: #DD0000">'/var/aegir/example-platform/sites/example.com/local.settings.php'</span><span style="color: #007700">);<br />&nbsp; }<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>If these files exist they are loaded at run time by Drupal.  As you can probably surmise from the paths to these files, <code>local.settings.php</code> is for site-specific customizations and <code>global.inc</code> is for Aegir-wide customization.</p>

<p>Let's look at these files in more detail.  We'll use customization of user session cookies as an example.  If you look at the <code>settings.php</code> file generated by Aegir you see that it sets more conservative php settings for cookies (<code>@ini_set(&#039;session.cookie_lifetime&#039;,&nbsp; 0);</code> i.e. cookies expire immediately) than are in the <code>default.settings.php</code> packaged with Drupal (<code>@ini_set(&#039;session.cookie_lifetime&#039;,&nbsp; 2000000);</code> i.e. 2 million seconds, which is just over 23 days).</p>

<h3>Site-specific Customization</h3>

<p>The <code>local.settings.php</code> file by default does not exist in a new Aegir site installation so you have to create it.  Continuing with our example of user session cookies, let's override the Aegir default.</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /> </span><span style="color: #FF8000"># site-specific Drupal customization<br /><br /># override Aegir-generated cookie policy for sites - set cookies to expire after a week (604,800 seconds)<br /></span><span style="color: #007700">@</span><span style="color: #0000BB">ini_set</span><span style="color: #007700">(</span><span style="color: #DD0000">'session.cookie_lifetime'</span><span style="color: #007700">, </span><span style="color: #0000BB">604800</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>Note that because <code>local.settings.php</code> is included after the variables are set in the main <code>settings.php</code> it's customizations takes precedence.</p>

<p>Now, whenever you clone a site or migrate it between platforms, Aegir moves a copy of <code>local.settings.php</code> as well.</p>

<h4>Using drush_hook_provision_drupal_config</h4>

<p>You can also use the API to add module-specific site configurations with hook_provision_drupal_config
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /> </span><span style="color: #007700">* </span><span style="color: #0000BB">Append PHP code to Drupal</span><span style="color: #DD0000">'s settings.php file.<br /> * <br /> * To use templating, return an include statement for the template.<br /> *<br /> * @param $uri<br /> *&nbsp;&nbsp; URI for the site.<br /> * @param $data<br /> *&nbsp;&nbsp; Associative array of data from provisionConfig_drupal_settings::data.<br /> *<br /> * @return<br /> *&nbsp;&nbsp; Lines to add to the site'</span><span style="color: #0000BB">s settings</span><span style="color: #007700">.</span><span style="color: #0000BB">php file</span><span style="color: #007700">.<br /> *<br /> * @</span><span style="color: #0000BB">see provisionConfig_drupal_settings<br /> </span><span style="color: #007700">*/<br />function </span><span style="color: #0000BB">drush_hook_provision_drupal_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">, </span><span style="color: #0000BB">$config</span><span style="color: #007700">) {<br />&nbsp; return </span><span style="color: #DD0000">'$conf[\'reverse_proxy\'] = TRUE;'</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>For example it could look like this
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">drupalwiki_provision_drupal_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">, </span><span style="color: #0000BB">$config</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">$extra </span><span style="color: #007700">= </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'site_extra_settings'</span><span style="color: #007700">, </span><span style="color: #DD0000">''</span><span style="color: #007700">);<br />&nbsp; </span><span style="color: #FF8000">// remove window CR<br />&nbsp; </span><span style="color: #0000BB">$extra </span><span style="color: #007700">= </span><span style="color: #0000BB">str_replace</span><span style="color: #007700">(</span><span style="color: #DD0000">"\r"</span><span style="color: #007700">,</span><span style="color: #DD0000">''</span><span style="color: #007700">,</span><span style="color: #0000BB">$extra</span><span style="color: #007700">);<br />&nbsp; return </span><span style="color: #0000BB">$extra</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>That is used to add the site settings added by the UI in the hosting backend implemented in <a href="https://github.com/EugenMayer/hosting_site_settings" title="https://github.com/EugenMayer/hosting_site_settings">https://github.com/EugenMayer/hosting_site_settings</a></p>

<h3>Aegir-wide Customization</h3>

<p>In some situations you may want to implement the same configuration settings on all your Aegir sites.  This is where <code>global.inc</code> comes in.  Note that <code>global.inc</code> is now included in <code>settings.php</code> <strong>before</strong> <code>local.settings.php</code>, so that Aegir system administrators no longer retain the ability to override configuration changes in <code>local.settings.php</code>, but instead it is possible to override global settings per site (read why this has been changed: <a href="http://drupal.org/node/1044938" title="http://drupal.org/node/1044938">http://drupal.org/node/1044938</a> - note: this change is available since 0.4-rc1 release).</p>

<p>For example, say the system administrator wanted to limit users' session lifetimes to a maximum of one day they could create a <code>global.inc</code> as follows:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /> </span><span style="color: #FF8000"># Aegir-wide Drupal customization<br /><br /># override Aegir-generated cookie policy for all sites - set cookies to expire after a day (86,400 seconds)<br /></span><span style="color: #007700">@</span><span style="color: #0000BB">ini_set</span><span style="color: #007700">(</span><span style="color: #DD0000">'session.cookie_lifetime'</span><span style="color: #007700">, </span><span style="color: #0000BB">86400</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>You can even set more granular policy within <code>global.inc</code> (however it makes more sense to keep site-specific overrides in the local.settings.php):</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /> </span><span style="color: #FF8000"># Aegir-wide Drupal customization<br /><br /># override Aegir-generated cookie policy for all sites - set cookies to expire after a day (86,400 seconds)<br /></span><span style="color: #007700">@</span><span style="color: #0000BB">ini_set</span><span style="color: #007700">(</span><span style="color: #DD0000">'session.cookie_lifetime'</span><span style="color: #007700">, </span><span style="color: #0000BB">86400</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000"># Make the aegir front-end server more secure by expiring cookies immediately<br /></span><span style="color: #007700">if (</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #DD0000">"/hostmaster/"</span><span style="color: #007700">, </span><span style="color: #0000BB">$conf</span><span style="color: #007700">[</span><span style="color: #DD0000">'install_profile'</span><span style="color: #007700">])) {<br />&nbsp; </span><span style="color: #FF8000"># set cookies to expire immediately on hostmaster<br />&nbsp; </span><span style="color: #007700">@</span><span style="color: #0000BB">ini_set</span><span style="color: #007700">(</span><span style="color: #DD0000">'session.cookie_lifetime'</span><span style="color: #007700">, </span><span style="color: #0000BB">0</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>If you are using Aegir to manage multiple remote webservers, you will need to run the Verify task on the webserver in order to push global.inc to the remote machine.</p>

<p>Note: on some Aegir installations (e.g. alpha14) the permissions on <code>/var/aegir/config</code> are insufficent for Apache to properly include the <code>global.inc</code> file.  If you find that the configuration settings in <code>global.inc</code> are being ignored, change the permissions with <code>chmod a+x /var/aegir/config</code>.  This only has to be applied to the config directory as the sub directory and file permissions should be correct.</p>

<p>If you have other configuration examples, create a wiki and reference it here.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-63.html?destination=node%2F71%23comment-form">Login</a> or <a href="../../../../../user/register/index-63.html?destination=node%2F71%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-63.html?destination=node%2F71%23comment-form">Login</a> or <a href="../../../../../user/register/index-63.html?destination=node%2F71%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-3007" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/injecting-drushrcphp/index.html">Injecting into drushrc.php</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>The <code>drushrc.php</code> file can be changed in two ways:</p>

<ol>
<li>by changing the templates used for the Drushrc context (see the <a href="http://api.aegirproject.org/api/aegir/provision3%21provision.api.php/function/hook_provision_config_load_templates/7.x-3.x">hook_provision_config_load_templates()</a> hook)</li>
<li>by creating a <code>local.drushrc.php</code> file in the site-specific folder (e.g. <code>sites/example.com/local.drushrc.php</code></li>
</ol>

<p>This is a stub. You can put more stuff here and it would be prettier.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-64.html?destination=node%2F3007%23comment-form">Login</a> or <a href="../../../../../user/register/index-64.html?destination=node%2F3007%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-64.html?destination=node%2F3007%23comment-form">Login</a> or <a href="../../../../../user/register/index-64.html?destination=node%2F3007%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>



    </div>
      </div>
</body>


<!-- Mirrored from community.aegirproject.org/node/39/revisions/78/view?print&book_recurse by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 29 Jul 2015 18:05:55 GMT -->
</html>
