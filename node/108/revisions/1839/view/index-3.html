<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<!-- Mirrored from community.aegirproject.org/node/108/revisions/1839/view?print&book_recurse by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 29 Jul 2015 18:20:56 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="prev" href="../../../../75/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../creating-product-features-using-uchosting-1x/index.html" />
<link rel="prev" href="../../../../75/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../creating-product-features-using-uchosting-1x/index.html" />
<link rel="prev" href="../../../../75/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../creating-product-features-using-uchosting-1x/index.html" />
<link rel="canonical" href="index.html" />
<link rel="prev" href="../../../index.html" />
<link rel="up" href="../../../index.html" />
<link rel="next" href="../../../../../content/contrib/class-auto-loading/index.html" />
<link rel="shortcut icon" href="../../../../../sites/community.aegirproject.org/themes/up/favicon/index.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="print" href="../../../../../sites/community.aegirproject.org/files/css/css_5fa73dc3677977c016a597acd186e4e7/index.css" />
<link type="text/css" rel="stylesheet" media="all" href="../../../../../sites/community.aegirproject.org/files/css/css_5fa73dc3677977c016a597acd186e4e7/index.css" />

  <title>Revision of E-Commerce Integration Roadmap from Wed, 05/18/2011 - 15:39 | community.aegirproject.org</title>
</head>

<body  class="print rubik admin-static page">
  <div class='limiter clear-block'>
    <div id='content' class='clear-block'>
      <div class='print-header'>
      <h1 class='site-name'>community.aegirproject.org</h1>
  </div>
      

<div  id="node-108" class="node node-book clear-block node-page">
  
      <h2 class='node-title'>
            <a href="../../../index.html">E-Commerce Integration Roadmap</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div id='diff-inline-108'><div class='diff-inline-metadata clear-block'><div class='diff-inline-byline'>Updated by <a href="../../../../../users/mig5/index.html" class="username" title="View user profile.">mig5</a> on 05/18/2011 - 15:39</div><div class='diff-inline-legend clear-block'><label>Legend</label><span class='diff-added'>Added</span><span class='diff-changed'>Changed</span><span class='diff-deleted'>Deleted</span></div></div><p>Related links:</p>

<ul>
<li>For installation and configuration instructions, see the <a href="../../../../516/index.html">Administrator Manual</a>.</li>
<li>There was some valuable discussion on <a href="http://groups.drupal.org/node/94959">use cases</a> on groups.drupal.org.</li>
</ul>

<p><strong><em>Don't put feature requests in here. Submit them to the <a href="http://drupal.org/project/issues/uc_hosting">uc_hosting</a> or <a href="http://drupal.org/project/issues/hostmaster">hostmaster</a> issue queues instead.</em></strong></p>

<h1>Drupal 6 / uc_hosting 1.0</h1>

<p><strong>Aiming for compatibility with:</strong></p>

<ul>
<li>Hostmaster 1.0</li>
<li>Ubercart 2.4</li>
</ul>

<p><strong>Structure:</strong></p>

<ul>
<li><strong>uc_hosting</strong>: This implements shared functions and classes, including the function to create a client based on an ubercart order and product.</li>
<li><strong>uc_hosting_products</strong>: This is where we put the ubercart function calls, attribute generation, etc... This module is intended to be used alone for the "my ubercart is on my aegir site" scenario.</li>
</ul>

<h2>Goals</h2>

<h3>Single site products</h3>

<p>In.</p>

<h3>Multi site packages</h3>

<p>In.</p>

<h3>Recurring payments</h3>

<p>We need to test the module using uc_recurring.</p>

<h2>Nice-to-haves</h2>

<p>Given where we are at now, this stuff will most likely not make it in until an eventual 1.1 release. The exception being Hadsie's work on "try before you buy".</p>

<h3>Purchasing wizard</h3>

<p>Stills needs to be developed. The create my site now option is a start and is already in.</p>

<h3>Make it unnecessary to log single-site purchasers into the aegir site</h3>

<p>Needs some testing but should be doable. Maybe just needs a little documentation. I believe Hadsie's work is related to this.</p>

<h3>Deferred payments</h3>

<p>Ergonlogic is working on this.</p>

<h1>Drupal 7 / uc_hosting 2.0</h1>

<p>We are still unsure about whether to support commerce, ubercart, or both with this module. We will most likely wait until development on the D7 port of aegir starts before beginning this work so we will see then what the landscape looks like.</p>

<p><strong>Aiming for compatibility with:</strong></p>

<ul>
<li>Hostmaster 2.x</li>
<li>Ubercart 3.x, or Commerce 1.x (maybe both?)</li>
</ul>

<h2>Goals</h2>

<h3>Remote storefronts</h3>

<p>Hopefully, this will be supported by plans for new xmlrpc methods in the hostmaster signup module.</p>

<h2>Nice-to-haves</h2>

<h3>Desjardins recurring payments</h3>

<p>This is a seperate module being developed by Koumbit.</p>

<h3>Importable demo products</h3>

<p>This would be really great.</p>

<h3>Simple procedure to deny user 1 to certain clients</h3>

<p>Hadsie's work on this is interesting and it would be useful to enable as an option on a uc_hosting install.</p>

<h1>Wishlist:</h1>

<ul>
<li>A decent ubercart import function (see <a href="http://www.sthlmconnection.se/tips-and-tweaks/exportable-configuration-ctools-revisited">this</a> and <a href="http://stellapower.net/content/using-chaos-tools-module-create-exportables">this</a>... <a href="http://drupal.org/node/349408">this</a> and maybe <a href="http://drupal.org/node/590956">this</a>)</li>
</ul>

<h1>Unanswered Questions</h1>

<ol>
<li>Will the Drupal 7 version use Ubercart or Commerce? Both? Neither?</li>
<li>How and when will people be billed? And what degree of control will uc_hosting offer over that?</li>
<li>Aegir has clients &amp; UC has clients. How are they related/distinct? How do we keep this clear to users/admins?</li>
</ol></div>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-423.html?destination=node%2F108%23comment-form">Login</a> or <a href="../../../../../user/register/index-423.html?destination=node%2F108%23comment-form">register</a> to post comments</span></li>
<li class="print active"><a href="index-2.html?print" class="active">Print</a></li>
<li class="print_recurse active"><a href="index-3.html?print&amp;book_recurse" class="active">Print entire section</a></li>
<li class="talk_comments last"><a href="../../../talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>



<div  id="node-707" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../creating-product-features-using-uchosting-1x/index.html">Creating product features using uc_hosting 1.x</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_27 first last"><a href="../../../../../category/level/developer/index.html" rel="tag" title="This level is generally for users interested in further developing the Aegir system itself, or extending it with contributed modules.">Developer</a></li>
</ul></div><p>This document assumes you want to implement a product feature using uc_hosting's database tables and exiting infrastructure. For a more complete example of an Ubercart 2.x product feature implementation, check out uc_file in the Ubercart core.</p>

<h2>The Basics</h2>

<p>Any module implementing a uc_hosting feature should include both uc_hosting and uc_hosting_products as dependencies. Include these lines in your .info file:</p>

<pre><code>dependencies[] = uc_hosting
dependencies[] = uc_hosting_products
</code></pre>

<h2>Declaring product features to Ubercart 2.x</h2>

<p>The first step is to implement Ubercart's hook_product_feature. Here is an example implementation for the platform access feature in uc_hosting_products:</p>

<pre><code>/**
 * Implementation of hook_product_feature().
 */
function uc_hosting_products_product_feature () {
  $features = array();

  // Set the feature for the platforms
  $features[] = array(
    'id' =&gt; 'hosting_platform',
    'title' =&gt; t('Access to a platform'),
    'callback' =&gt; 'uc_hosting_products_platform_form',
    'delete' =&gt; 'uc_hosting_products_feature_delete',
    'settings' =&gt; 'uc_hosting_products_platform_settings',
  );

  return $features;
}
</code></pre>

<p>An implementation of hook_product_feature returns a numerical array of associative arrays. Feature arrays must include five keys:</p>

<ul>
<li><strong>id</strong> will be used to identify your feature at the database level, in the uc_product_features table, and also in urls. Think of it as the type of your feature.</li>
<li><strong>title</strong> is the name of your feature as it will be displayed to site admins.</li>
<li><strong>callback</strong> will be used to create and modify instances of your feature attached to specific products. This callback should return a drupal form passed through the uc_product_feature_form function.</li>
<li><strong>delete</strong> is a simple function called on the removal of a feature instance from a product.</li>
<li><strong>settings</strong> is a callback that provides additional settings for the feature, and is not used presently in any uc_hosting product feature.</li>
</ul>

<p>Of note is that, unlike Drupal's core hook_menu and hook_theme, hook_product_feature does not include a 'file' key. uc_hosting works around this by using include_once at the beginning of the hook_product_feature implementation.</p>

<p>If you wish to use uc_hosting's shared feature functions, make sure to include the file "products/inc/uc_hosting_products.feature_shared.inc" (path relative to the uc_hosting root) at the beginning of your implementation of hook_product_feature.</p>

<h2>The callback form</h2>

<p>This form is called everytime someone adds a product feature to a product. It allows you to set any options for your feature that should be delivered on a per-product basis. Lets take a look at this function for the platform access feature:</p>

<pre><code>/**
 * Callback to add the platform form on the product feature page
 */
function uc_hosting_products_platform_form ($form_state, $node, $feature) {
  $form = array();

  // Get default values and shared form elements for all uc_hosting features
  $hosting_product = _uc_hosting_products_feature_fetch_product($feature);
  if (empty($feature)) {
    $feature = array('id' =&gt; 'hosting_platform');
  }
</code></pre>

<p>_<strong>uc_hosting_products_feature_fetch_product</strong> attempts to retrieve existing values for this instance of a product feature from the database.</p>

<pre><code>  _uc_hosting_products_feature_shared_elements(&amp;$form, $node, $feature, $hosting_product);
</code></pre>

<p>_<strong>uc_hosting_products_feature_shared_elements</strong> declares some form elements that either uc_hosting or Ubercart itself depend on to provide the product feature functionality.</p>

<pre><code>  // @see _hosting_get_platforms()
  if (user_access('view locked platforms')) {
    $platforms = _hosting_get_platforms();
  }
  else if (user_access('view platform')) {
    $platforms = _hosting_get_enabled_platforms();
  }
  else {
    $platforms = array();
    drupal_set_message('You must have permission to access platforms to enable this feature.', 'warning');
  }

  $form['platform'] = array(
    '#type' =&gt; 'select',
    '#title' =&gt; t('Platform'),
    '#description' =&gt; t('Select the platform to associate with this product.'),
    '#default_value' =&gt; $hosting_product-&gt;value,
    '#options' =&gt; $platforms,
    '#required' =&gt; TRUE,
  );
</code></pre>

<p>This code block generates a list of platforms to allow the admin to select which platform to bind to his product. This code is specific to the platform access implementation - this is where you should include your own form elements relevant to your feature.</p>

<pre><code>  $form['#validate'][] = 'uc_hosting_products_single_feature_validate';
</code></pre>

<p>For many implementations, <strong>uc_hosting_products_single_feature_validate</strong> ensures that a given uc_hosting product feature can only be enabled once on any given product. All of the exising uc_hosting_products features make use of this function.</p>

<pre><code>  return uc_product_feature_form ($form);
}
</code></pre>

<p>Finally, <strong>uc_product_feature_form</strong> adds some required form elements from Ubercart.</p>

<p>You also need to make sure to code a submit function for your callback, of the form callback_submit:</p>

<pre><code>/**
 * Save the platform feature settings.
 */
function uc_hosting_products_platform_form_submit($form, &amp;$form_state) {
  $hosting_product = array(
    'pfid' =&gt; $form_state['values']['pfid'],
    'model' =&gt; $form_state['values']['model'],
    'type' =&gt; 'platform',
    'value' =&gt; $form_state['values']['platform'],
  );

  $platform_node = node_load($hosting_product['value']);
  $description = t('&lt;strong&gt;SKU:&lt;/strong&gt; !sku&lt;br /&gt;', array('!sku' =&gt; empty($hosting_product['model']) ? 'Any' : $hosting_product['model']));
  $description .= t('&lt;strong&gt;Platform:&lt;/strong&gt; !platform', array('!platform' =&gt; $platform_node-&gt;title));

  $data = array(
    'pfid' =&gt; $form_state['values']['pfid'],
    'nid' =&gt; $form_state['values']['nid'],
    'fid' =&gt; 'hosting_platform',
    'description' =&gt; $description,
  );

  $form_state['redirect'] = uc_product_feature_save($data);
</code></pre>

<p>We manually save the product_feature to ubercart's database tables here. This is so that we can then retrieve the index of the entry in the uc_product_features table for later use in our own data.</p>

<pre><code>  // Insert or update uc_hosting_products table
  if (empty($hosting_product['pfid'])) {
    $hosting_product['pfid'] = db_last_insert_id('uc_product_features', 'pfid');
  }

  $existing_prod = db_fetch_object(db_query("SELECT hpid, data FROM {uc_hosting_products} WHERE pfid = %d LIMIT 1", $hosting_product['pfid']));

  $key = NULL;
  if ($existing_prod-&gt;hpid) {
    $key = 'hpid';
    $hosting_product['hpid'] = $existing_prod-&gt;hpid;
    $hosting_product['data'] = unserialize($existing_prod-&gt;data);
    $hosting_product['data']['platform'] = $hosting_product['value'];
  }
  // If necessary build a data array from scratch
  else {
    $hosting_product['data'] = array(
      'platform' =&gt; $hosting_product['value'],
    );
  }

  $hosting_product['data'] = serialize($hosting_product['data']);

  drupal_write_record('uc_hosting_products', $hosting_product, $key);
}
</code></pre>

<p>Note that the uc_hosting_products table has both an integer column <strong>value</strong>, and a longtext column <strong>data</strong> for storing serialized information about the feature.</p>

<h2>Taking action in Aegir based on product features</h2>

<p>uc_hosting assumes that most purchases made via Ubercart are intended to be expressed as changes to an Aegir client node. So it provides some code to help you create new clients or modify exiting ones when an order containing your feature is made. Any other actions needed to make your feature work you will need to implement yourself. This will involve implementing the Ubercart hook, <a href="http://api.ubercart.org/api/function/hook_order/2">hook_order</a> and your own callback function.</p>

<p>Lets start by taking a look at uc_hosting_products own implementation of hook_order:</p>

<pre><code>/**
 * Implementation of hook_order
 *
 * Actions t$form_state['values']['create_later']o take on order changes involving an aegir product
 *
 * @param $op string
 *   Provided by ubercart on invocation
 * @param &amp;$arg1
 *   Different data depending on the op
 * @param $arg2
 *   Different data depending on the op
 */
function uc_hosting_products_order ($op, &amp;$arg1, $arg2) {
  switch ($op) {
    case 'update':
      if ($arg2 == 'completed') {
        foreach ($arg1-&gt;products as $product) {
          if (_uc_hosting_products_has_feature ($product)) {
            // Make the changes necessary to the hosting client
            $client = uc_hosting_update_client($arg1, $product, 'uc_hosting_products_client_update');
          }
        }
      }
      break;
    default:
      break;
  }
}
</code></pre>

<p>_<strong>uc_hosting_products_has_feature</strong> is defined in uc_hosting_products.module, and provides some simple logic to detect uc_hosting product features. Rather than use this function, you will most likely want to define your own conditions.</p>

<p><strong>uc_hosting_update_client</strong> does the work of matching up an incoming ubercart order to an existing Aegir client, if possible. If not possible, it creates a new client node. It then calls the function provided as a third argument, in this case uc_hosting_products_client_update, and passes to that function the affected client node, as well as the product and order objects from Ubercart.</p>

<p>This callback function is the place to take actions in Aegir or pass commands. Take a look at uc_hosting_products for a fully fleshed out example.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-210.html?destination=node%2F707%23comment-form">Login</a> or <a href="../../../../../user/register/index-210.html?destination=node%2F707%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-210.html?destination=node%2F707%23comment-form">Login</a> or <a href="../../../../../user/register/index-210.html?destination=node%2F707%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>



    </div>
      </div>
</body>


<!-- Mirrored from community.aegirproject.org/node/108/revisions/1839/view?print&book_recurse by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 29 Jul 2015 18:20:56 GMT -->
</html>
