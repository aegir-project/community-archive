<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<!-- Mirrored from community.aegirproject.org/node/33/revisions/1851/view?print&book_recurse by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 29 Jul 2015 18:20:39 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="prev" href="../../../../494/index.html" />
<link rel="up" href="../../../../../developing/index.html" />
<link rel="next" href="../../../../../dev-cheat-sheet/index.html" />
<link rel="prev" href="../../../../494/index.html" />
<link rel="up" href="../../../../../developing/index.html" />
<link rel="next" href="../../../../../dev-cheat-sheet/index.html" />
<link rel="prev" href="../../../../494/index.html" />
<link rel="up" href="../../../../../developing/index.html" />
<link rel="next" href="../../../../../dev-cheat-sheet/index.html" />
<link rel="canonical" href="index.html" />
<link rel="prev" href="../../../../../contrib/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../75/index.html" />
<link rel="prev" href="../../../../../dev-cheat-sheet/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../108/index.html" />
<link rel="prev" href="../../../../75/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../creating-product-features-using-uchosting-1x/index.html" />
<link rel="prev" href="../../../../108/index.html" />
<link rel="up" href="../../../../108/index.html" />
<link rel="next" href="../../../../../content/contrib/class-auto-loading/index.html" />
<link rel="prev" href="../../../../../creating-product-features-using-uchosting-1x/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../contrib/customizing-platform-templates/index.html" />
<link rel="prev" href="../../../../../content/contrib/class-auto-loading/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../content/contrib/passing-values-site-drushrcphp-file-during-migrations/index.html" />
<link rel="prev" href="../../../../../contrib/customizing-platform-templates/index.html" />
<link rel="up" href="../../../../../contrib/index.html" />
<link rel="next" href="../../../../../content/developing/integrating-aegir/index.html" />
<link rel="shortcut icon" href="../../../../../sites/community.aegirproject.org/themes/up/favicon/index.ico" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="print" href="../../../../../sites/community.aegirproject.org/files/css/css_5fa73dc3677977c016a597acd186e4e7/index.css" />
<link type="text/css" rel="stylesheet" media="all" href="../../../../../sites/community.aegirproject.org/files/css/css_5fa73dc3677977c016a597acd186e4e7/index.css" />

  <title>Revision of Extending Aegir from Wed, 05/18/2011 - 16:16 | community.aegirproject.org</title>
</head>

<body  class="print rubik admin-static page">
  <div class='limiter clear-block'>
    <div id='content' class='clear-block'>
      <div class='print-header'>
      <h1 class='site-name'>community.aegirproject.org</h1>
  </div>
      

<div  id="node-33" class="node node-book clear-block node-page">
  
      <h2 class='node-title'>
            <a href="../../../../../contrib/index.html">Extending Aegir</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_27 first last"><a href="../../../../../category/level/developer/index.html" rel="tag" title="This level is generally for users interested in further developing the Aegir system itself, or extending it with contributed modules.">Developer</a></li>
</ul></div><div id='diff-inline-33'><div class='diff-inline-metadata clear-block'><div class='diff-inline-byline'>Updated by <a href="../../../../../users/mig5/index.html" class="username" title="View user profile.">mig5</a> on 05/18/2011 - 16:16</div><div class='diff-inline-legend clear-block'><label>Legend</label><span class='diff-added'>Added</span><span class='diff-changed'>Changed</span><span class='diff-deleted'>Deleted</span></div></div><p>Aegir is designed to be easily extendable by developers. As it is made with Drupal and Drush, it is made of the hooks and command you know and love.<span class='diff-added'> If you are a user or admin looking to deploy contrib modules, you should look into the </span><a href="../../../../../contrib-modules/index.html"><span class='diff-added'>contrib modules list and user documentation</span></a><span class='diff-added'> instead.</span></p>

<h2>What can I extend exactly?</h2>

<p>These extensions may come in the form of</p>

<ul>
<li>Adding new tasks to be performed against sites</li>
<li>Adding new services or implementations of service types (postgres for the DB service, for example)</li>
<li><a href="../../../../75/index.html">Overriding or hooking into existing forms such as the site form, to send extra data to the backend</a></li>
<li>Using APIs to inject bits of configuration into configuration files such as settings.php and vhosts.</li>
</ul>

<p>This area is be devoted to teaching you how to extend and develop for Aegir to encourage contributions to the Aegir project or to help you modify Aegir to suit your unique use case.</p>

<h2>Aegir API documentation</h2>

<p>The inline documentation is a good start to understand the various hooks and internals that allow you to extend and customize Aegir to your liking. The documentation is rendered on <a href="http://api.aegirproject.org/">api.aegirproject.org</a> daily.</p>

<p>See also the <a href="../../../../../dev-cheat-sheet/index.html">developer cheat sheet</a>.</p>

<blockquote>
  <p><em>Please submit any suggestions or bug reports to the <a href="http://drupal.org/project/issues?text=&amp;projects=hosting,+provision,+eldir,+Hostmaster+%28Aegir%29&amp;status=Open&amp;priorities=All&amp;categories=All">Aegir Project issue queue of your choice</a>, under the "documentation" component.</em></p>
</blockquote>

<h2>Example modules</h2>

<p>The <a href="../../../../../contrib/index.html">contrib</a> page documents all known Aegir extensions in existence. There are also specific developer documentation pages below.</p>

<h2>Contrib developer documentation and roadmaps</h2>

<p>Contrib developers are free to use this space to document the internals of their modules or their roadmaps. There is already this documentation:</p>

<ul>
<li><a href="../../../../108/index.html">E-Commerce Integration Roadmap</a> (uc_hosting)</li>
</ul></div>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-208.html?destination=node%2F33%23comment-form">Login</a> or <a href="../../../../../user/register/index-208.html?destination=node%2F33%23comment-form">register</a> to post comments</span></li>
<li class="print active"><a href="index-2.html?print" class="active">Print</a></li>
<li class="print_recurse active"><a href="index-3.html?print&amp;book_recurse" class="active">Print entire section</a></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-208.html?destination=node%2F33%23comment-form">Login</a> or <a href="../../../../../user/register/index-208.html?destination=node%2F33%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>



<div  id="node-537" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../dev-cheat-sheet/index.html">Aegir developer cheat sheet</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <script type="text/javascript">toc_collapse=0;</script><div class="toc" id="toc">
<div class="toc-title">Table of Contents<span class="toc-toggle-message">&nbsp;</span></div>
<div class="toc-list">
<ol>
	<li class="toc-level-1"><a href="#Locations_and_paths"><span class="toc-number">1. </span>Locations and paths</a></li>
	<li class="toc-level-1"><a href="#File_permissions_and_ownership"><span class="toc-number">2. </span>File permissions and ownership</a></li>
	<li class="toc-level-1"><a href="#Enablingdisabling_drushprovision_extensions_from_hostmaster"><span class="toc-number">3. </span>Enabling/disabling drush/provision extensions from hostmaster</a></li>
	<li class="toc-level-1"><a href="#References"><span class="toc-number">4. </span>References</a></li>
</ol>
</div>
</div>

<h3 id="Locations_and_paths">1. Locations and paths</h3>

<ul>
<li>Site URI: d()-&gt;uri; // ex: $base_url = 'http://' . d()-&gt;uri;</li>
<li>Drupal root: d()-&gt;site // returns: /var/aegir/platform/drupal-6.20/</li>
<li>Site path: d()-&gt;site_path // returns: /var/aegir/platform/drupal-6.20/sites/example.org/</li>
</ul>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="File_permissions_and_ownership">2. File permissions and ownership</h3>

<pre>
 $ctools_path = d()-&gt;site_path . '/files/ctools';

 provision_file()-&gt;chmod($ctools_path, 0770, TRUE)
   -&gt;succeed('Changed permissions of <code>@path</code> to @perm')
   -&gt;fail('Could not change permissions <code>@path</code> to @perm')
   -&gt;status();

 provision_file()-&gt;chgrp($ctools_path, d('@server_master')-&gt;web_group, TRUE)
   -&gt;succeed('Change group ownership of settings.php to @path')
   -&gt;fail('Could not change group ownership of settings.php to @path')
   -&gt;status();
</pre>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Enablingdisabling_drushprovision_extensions_from_hostmaster">3. Enabling/disabling drush/provision extensions from hostmaster</h3>

<p>Every drush extension can implement a hook_drush_load(), and check if a module is enabled in the hostmaster site. See <a href='http://drupalcode.org/project/provision.git/blob/refs/heads/6.x-2.x:/provision.api.php'>provision.api.php for an example</a>.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="References">4. References</h3>

<p><a href="http://api.aegirproject.org/" title="http://api.aegirproject.org/">http://api.aegirproject.org/</a></p><div class="toc-back-to-top"><a href="#toc">Back to top</a></div><script type="text/javascript">toc_scroll_back_to_top = 1;</script>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-209.html?destination=node%2F537%23comment-form">Login</a> or <a href="../../../../../user/register/index-209.html?destination=node%2F537%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-209.html?destination=node%2F537%23comment-form">Login</a> or <a href="../../../../../user/register/index-209.html?destination=node%2F537%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-75" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../75/index.html">Extending Aegir and communicating with install profiles</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_2 first last"><a href="../../../../../taxonomy/term/2/index.html" rel="tag" title="This level is generally for users with the root access to their server, who are responsible for installation and configuration of entire Aegir system environment.">Sysadmin</a></li>
</ul></div><p>This article has been republished from mig5's website. <a href="http://www.migueljacq.com/content/developing-aegir-extending-aegir-and-communicating-install-profiles">Original URL</a></p>
<p>Aegir is a pretty powerful tool that allows you to very quickly provision new Drupal sites out of the box and manage them throughout their lifespan through a variety of tasks.</p>
<p>Its ability to understand different install profiles and thus 'distributions' shoots the awesome factor through the roof once you can deploy instances of OpenAtrium, Pressflow, ManagingNews or your own custom distro in just a couple of clicks.</p>
<p>Inevitably, though, your requirements will grow more complex. Aegir is about automation, and install profiles that prompt users for information through a series of tasks, and fail without that information, aren't much help. You might resort to a bunch of hacks to get that data into your client's site. You might try and insert some custom stuff into the site's vhost only to whimper in dismay when Aegir does a routine Verify sanity check and obliterates your changes.</p>
<p>If you get to this point, the simplicity of Aegir will be a distant memory and you'll be shaking your fist at us developers for forgetting about your corner case. Curses!</p>
<p>Rest assured, despite the constantly shifting development in Aegir and its early alpha stages, we try to maintain an ability to hook into Aegir and extend it as easily as possible, and it will only continue to get easier, especially once our API stabilises and is published.</p>
<p>Today I'm going to show you:</p>
<ul>
<li>how to add a custom Hosting submodule to Aegir</li>
<li>how to alter the site form to add custom fields of data</li>
<li>how to send that data to the backend</li>
<li>how to apply that data to site vhosts and inside your custom install profile and site database</li>
</ul>
<p>There are a few files here, because we're creating a custom module and install profile, and a few other things. For the impatient, I've attached a tarball to this article called 'cheesy.tar.gz' that contains all the relevant components and a README.txt instructing where to put it all.</p>
<p>Those of you who follow me on Twitter know I like to perpetuate the semi-French stereotype and rant and rave about cheese. I spent some time trying to think of a non-cheesy example to use in this tutorial, before realising what a silly idea that was. You can never have enough cheese :)</p>
<h3>Part one - Adding a cheesy module</h3>
<p>We'll add a custom module to the Hosting frontend called 'Cheese'.</p>
<p>Hosting is the 'frontend' bit of the Aegir system that allows you to plug data in via a web interface and have that information, if necessary, communicated to the backend Drush/Provision system by way of 'tasks'.</p>
<p>Our new module is simple: we're going to invoke a hook_form_alter() to add a textfield to the site form. The module will add a table to the Aegir database that stores this value, linked to the site nid. Keeping it out of the hosting_site table means we can disable and uninstall this module later and clean up properly.</p>
<p>There's nothing new or unusual about a Hosting submodule than any other Drupal module.  Make the directory <code>/var/aegir/hostmaster-0.x/profiles/hostmaster/modules/hosting/cheese</code></p>
<p><strong>Info file</strong></p>
<p>Here's our hosting_cheese.info</p>
<div class="codeblock"><code>name = Cheese<br />description = Cheesemongers need to define cheese in their Drupal sites.<br />package = Hosting<br />dependencies[] = hosting_site
<p>core = 6.x</p></code></div>
<p>You can see we depend on hosting_site, because hosting_site is the module that provides the site form for installing sites!</p>
<p><strong>Install file</strong></p>
<p>Now let's add an .install file that defines our database table schema and how to install/uninstall it. Standard Drupal stuff.</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Implementation of hook_schema().<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_schema</span><span style="color: #007700">() {<br />&nbsp; </span><span style="color: #0000BB">$schema</span><span style="color: #007700">[</span><span style="color: #DD0000">'hosting_cheese'</span><span style="color: #007700">] = array(<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'fields' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'vid' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'int'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'not null' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'default' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">0</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'nid' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'int'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'unsigned' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'not null' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'default' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">0</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'cheese' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'varchar'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'length' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">128</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'not null' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br />&nbsp;&nbsp;&nbsp; ),<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'indexes' </span><span style="color: #007700">=&gt; array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'vid' </span><span style="color: #007700">=&gt; array(</span><span style="color: #DD0000">'vid'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'cheese' </span><span style="color: #007700">=&gt; array(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp; ),<br />&nbsp; );
<p>&nbsp; return </p></span><span style="color: #0000BB">$schema</span><span style="color: #007700">;<br />}
<p>function </p></span><span style="color: #0000BB">hosting_cheese_install</span><span style="color: #007700">() {<br />&nbsp; </span><span style="color: #FF8000">// Create tables.<br />&nbsp; </span><span style="color: #0000BB">drupal_install_schema</span><span style="color: #007700">(</span><span style="color: #DD0000">'hosting_cheese'</span><span style="color: #007700">);<br />}
<p>function </p></span><span style="color: #0000BB">hosting_cheese_uninstall</span><span style="color: #007700">() {<br />&nbsp; </span><span style="color: #FF8000">// Remove tables.<br />&nbsp; </span><span style="color: #0000BB">drupal_uninstall_schema</span><span style="color: #007700">(</span><span style="color: #DD0000">'hosting_cheese'</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p><strong>The module</strong></p>
<p>Here's our simple hosting_cheese.module file.</p>
<p>It's pretty straightforward: our first function is a <code>hook_form_alter()</code> of <code>hosting_site_form()</code>. We are adding a single textfield to the form called 'Cheese'. Because it's my favourite, the default value is going to be 'camembert' if it hasn't already been set on the node (if we're updating a site rather than creating a new one).</p>
<p>The next few functions are invocations of common database hooks such as insert, update and delete. They will insert the 'cheese' value from our form into the <code>hosting_cheese</code> table.</p>
<p>I call <code>hook_nodeapi()</code> to do $stuff on those actions. There's validation to check that a cheese was entered. We invoke <code>hook_load()</code>, which allows various modules and features to return their bits and pieces from various parts of the database as 'additions' to the core node attributes. With this we can call <code>$node-&gt;cheese</code> when we might need to.</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Implementation of hook_form_alter()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_form_alter</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$form</span><span style="color: #007700">, </span><span style="color: #0000BB">$form_state</span><span style="color: #007700">, </span><span style="color: #0000BB">$form_id</span><span style="color: #007700">) {<br />&nbsp; if (</span><span style="color: #0000BB">$form_id </span><span style="color: #007700">== </span><span style="color: #DD0000">'site_node_form'</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">] = array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'textfield'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#title' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'Cheese'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#description' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'What sort of cheese?'</span><span style="color: #007700">),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#default_value' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'#node'</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">cheese </span><span style="color: #007700">? </span><span style="color: #0000BB">$form</span><span style="color: #007700">[</span><span style="color: #DD0000">'#node'</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">cheese </span><span style="color: #007700">: </span><span style="color: #DD0000">'camembert'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#required' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">TRUE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'#weight' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">0</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp; );<br />&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">$form</span><span style="color: #007700">;<br />&nbsp; }<br />}
<p></p></span><span style="color: #FF8000">/** <br /> * Implementation of hook_insert()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">) {<br />&nbsp; if (</span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cheese</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT INTO {hosting_cheese} (vid, nid, cheese) VALUES (%d, %d, '%s')"</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">vid</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">nid</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cheese</span><span style="color: #007700">);<br />&nbsp; }<br />}
<p></p></span><span style="color: #FF8000">/**<br /> * Implementation of hook_update()<br /> */
<p></p></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_update</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"UPDATE {hosting_cheese} SET cheese = '%s' WHERE nid = %d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cheese</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">nid</span><span style="color: #007700">);<br />}
<p></p></span><span style="color: #FF8000">/**<br /> * Implementation of hook_delete()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_delete</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DELETE FROM {hosting_cheese} WHERE nid=%d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">nid</span><span style="color: #007700">);<br />}
<p></p></span><span style="color: #FF8000">/**<br /> * Implementation of hook_delete_revision()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_delete_revision</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DELETE FROM {hosting_cheese} WHERE vid=%d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">vid</span><span style="color: #007700">);<br />}
<p></p></span><span style="color: #FF8000">/** <br /> * Implementation of hook_nodeapi()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">hosting_cheese_nodeapi</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$node</span><span style="color: #007700">, </span><span style="color: #0000BB">$op</span><span style="color: #007700">, </span><span style="color: #0000BB">$a3 </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">, </span><span style="color: #0000BB">$a4 </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">) {<br />&nbsp; if (</span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">type </span><span style="color: #007700">== </span><span style="color: #DD0000">'site'</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; switch (</span><span style="color: #0000BB">$op</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'insert'</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">hosting_cheese_insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'update'</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">hosting_cheese_update</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'delete' </span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">hosting_cheese_delete</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'delete revision'</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">hosting_cheese_delete_revision</span><span style="color: #007700">(</span><span style="color: #0000BB">$node</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'validate' </span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!</span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cheese</span><span style="color: #007700">) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">form_set_error</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">, </span><span style="color: #0000BB">t</span><span style="color: #007700">(</span><span style="color: #DD0000">'You must enter a cheese!'</span><span style="color: #007700">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case </span><span style="color: #DD0000">'load'</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$additions</span><span style="color: #007700">[</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">] = </span><span style="color: #0000BB">db_result</span><span style="color: #007700">(</span><span style="color: #0000BB">db_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT cheese FROM {hosting_cheese} WHERE vid=%d"</span><span style="color: #007700">, </span><span style="color: #0000BB">$node</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">vid</span><span style="color: #007700">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return </span><span style="color: #0000BB">$additions</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>At this point, you can go to <code>/admin/build/modules</code> and enable the Cheese feature. The database table will get installed, and you can now go to <code>Create Content &gt; Site</code> and see our cheese field is present in the site form!</p>
<div align="center"><img src="../../../../../sites/community.aegirproject.org/files/cheese_form/index.png" /></div>
<h3>Part two - sending the cheese to the backend</h3>
<p>Yes, it's very exciting that we have cheese in Aegir now. But don't provision a site yet! The fun hasn't even started.</p>
<p>In the same directory as the hosting_cheese module, create a new file called <code>hosting_cheese.drush.inc</code>. This is a Drush file that is going to be responsible for catching when an Install or Verify task is being executed against a site, and to send the cheese value along for the ride to the backend.</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Implementation of drush_hook_pre_hosting_task()<br /> * Send the site's cheese attribute to the backend for processing.<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">drush_hosting_cheese_pre_hosting_task</span><span style="color: #007700">() {<br />&nbsp; </span><span style="color: #0000BB">$task </span><span style="color: #007700">=&amp; </span><span style="color: #0000BB">drush_get_context</span><span style="color: #007700">(</span><span style="color: #DD0000">'HOSTING_TASK'</span><span style="color: #007700">);<br />&nbsp; if (</span><span style="color: #0000BB">$task</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ref</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">type </span><span style="color: #007700">== </span><span style="color: #DD0000">'site' </span><span style="color: #007700">&amp;&amp; (</span><span style="color: #0000BB">$task</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">task_type </span><span style="color: #007700">== </span><span style="color: #DD0000">'install' </span><span style="color: #007700">|| </span><span style="color: #0000BB">$task</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">task_type </span><span style="color: #007700">== </span><span style="color: #DD0000">'verify'</span><span style="color: #007700">)) {<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #0000BB">$task</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">options</span><span style="color: #007700">[</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">] = </span><span style="color: #0000BB">$task</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ref</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">cheese</span><span style="color: #007700">;<br />&nbsp; }<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>In this code, <code>$task-&gt;ref</code> represents the node object (the site).</p>
<p>Because of our additions in our implementation of hook_node_load(), the cheese value is fetched and available for us to use.</p>
<h3>Part three - an install profile (just for fun)</h3>
<p>I'm demonstrating all this to show you how to get data from the frontend (in the site form) to the backend. We've achieved that, but you probably want to actually *do* stuff with the data. </p>
<p>I'll demonstrate two things you can do with this data. They are just examples - Aegir isn't limited to this at all. </p>
<p><strong>cheesy_sites.profile</strong><br />
First let's create a simple install profile called 'Cheesy sites'.</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Return an array of the modules to be enabled when this profile is installed.<br /> *<br /> * @return<br /> *&nbsp; An array of modules to be enabled.<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">cheesy_sites_profile_modules</span><span style="color: #007700">() {<br />&nbsp; return array(<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">/* core */ </span><span style="color: #DD0000">'block'</span><span style="color: #007700">, </span><span style="color: #DD0000">'color'</span><span style="color: #007700">, </span><span style="color: #DD0000">'filter'</span><span style="color: #007700">, </span><span style="color: #DD0000">'help'</span><span style="color: #007700">, </span><span style="color: #DD0000">'menu'</span><span style="color: #007700">, </span><span style="color: #DD0000">'node'</span><span style="color: #007700">, </span><span style="color: #DD0000">'system'</span><span style="color: #007700">, </span><span style="color: #DD0000">'user'</span><span style="color: #007700">, </span><span style="color: #DD0000">'path'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #FF8000">/* other contrib */ </span><span style="color: #DD0000">'install_profile_api'</span><span style="color: #007700">, </span><span style="color: #DD0000">'token'</span><span style="color: #007700">, </span><span style="color: #DD0000">'pathauto'</span><span style="color: #007700">, </span><span style="color: #DD0000">'views'</span><span style="color: #007700">,<br />&nbsp; );<br />}
<p></p></span><span style="color: #FF8000">/**<br /> * Return a description of the profile for the initial installation screen.<br /> *<br /> * @return<br /> *&nbsp;&nbsp; An array with keys 'name' and 'description' describing this profile.<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">cheesy_sites_profile_details</span><span style="color: #007700">() {<br />&nbsp; return array(<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'name' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Cheesy site'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp; </span><span style="color: #DD0000">'description' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Select this profile to install a really cheesy site.'<br />&nbsp; </span><span style="color: #007700">);<br />}
<p>function </p></span><span style="color: #0000BB">cheesy_sites_profile_tasks</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$task</span><span style="color: #007700">, </span><span style="color: #0000BB">$url</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #FF8000">// Install dependencies<br />&nbsp; </span><span style="color: #0000BB">install_include</span><span style="color: #007700">(</span><span style="color: #0000BB">cheesy_sites_profile_modules</span><span style="color: #007700">());<br />&nbsp; </span><span style="color: #FF8000">// Fetch and set the cheese attribute from Drush, sent originally <br />&nbsp; // from the site form in the Aegir frontend.<br />&nbsp; </span><span style="color: #0000BB">variable_set</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese' </span><span style="color: #007700">, </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">, </span><span style="color: #DD0000">'camembert'</span><span style="color: #007700">));<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>This is not meant as an exercise in learning how to write install profiles so I'll gloss over some of the details here. Basic version: we define our modules that the profile depends on (core + some contrib), we install those modules, and finally we do a basic <code>variable_set</code> to store a 'cheese' variable in the site's database, fetching the value from the Drush/Provision backend (sent by the frontend per above), defaulting to 'camembert' if there was none.</p>
<p>Obviously in a normal install profile, this file would be bigger, as you'd be doing a bunch of other stuff such as setting up node types, setting up menus, blocks, users etc.</p>
<p><strong>cheesy_sites.make</strong><br />
I provide a Drush makefile here to fetch the contrib for you. This is totally out of the scope of the tutorial, but it's just fun to use Drush Make and I encourage you to get used to it :)</p>
<div class="codeblock"><code>core = 6.x<br />api = 2
<p>; Contrib modules<br />projects[token][version] = &quot;1.15&quot;<br />projects[pathauto][version] = &quot;1.5&quot;<br />projects[views][version] = &quot;2.11&quot; <br />projects[install_profile_api][version] = &quot;2.1&quot;</p></code></div>
<p>Download Drupal into /var/aegir/drupal-6.19 and copy the cheesy_sites directory into the profiles directory of drupal-6.19, or use a Drush stub makefile to do it all.</p>
<p>If you downloaded core manually, you'll want to <code>cd drupal-6.19; drush make profiles/cheesy_sites/cheesy_sites.make --no-core</code>. The contrib will be downloaded to /var/aegir/drupal-6.19/sites/all/modules</p>
<p><strong>Add the platform</strong></p>
<p>Add a new Platform in Aegir with the Publish Path being that which we just created: /var/aegir/drupal-6.19. A Verify task will be spawned, and Aegir will pick up all the modules and also the 'cheesy_sites' profile, which you can check by viewing the 'Installation profiles' section of the 'Packages' menu tab on the platform node, after the Verify task has completed.</p>
<div align="center"><img src="../../../../../sites/community.aegirproject.org/files/cheesy_sites_profile/index.png" /></div>
<p>You could also add this profile and its dependencies to an existing platform and just re-Verify the platform, and the new profile will be synced up and added to this platform's package registry.</p>
<h3>Part four - make the backend knowledgeable about cheese</h3>
<p>Now we've set up the frontend to get the cheese, set up a drush file to send the cheese to the backend, and we have an install profile that expects to find cheese and set a variable about it in a database when installing a site.</p>
<p>We've left out one crucial stage, and that is to actually prepare the backend to tell it that cheese is coming!</p>
<p><strong>cheese.drush.inc</strong></p>
<p>Telling the backend about the incoming cheese is very similar to what we did earlier about capturing the cheese info on specific tasks and do $stuff with it. </p>
<p>To tell Drush and Provision (Aegir's Drush extension) about the cheese, create a file in ~aegir/.drush called <code>cheese.drush.inc</code>.</p>
<p>We'll invoke a Drush hook that sets the value for the backend on installing a site.</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/**<br /> * Implementation of hook_pre_provision_install()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">drush_cheese_pre_provision_install</span><span style="color: #007700">(</span><span style="color: #0000BB">$url </span><span style="color: #007700">= </span><span style="color: #0000BB">NULL</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">drush_set_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">, </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">, </span><span style="color: #DD0000">'camembert'</span><span style="color: #007700">), </span><span style="color: #DD0000">'site'</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>This saves the value into the site context, where it's usable by the install profile. This occurs in the pre hook, prior to when Aegir starts executing the tasks outlined by the install profile.</p>
<h3>Part five - using Aegir hooks to inject settings into the site vhost</h3>
<p>In Part four, we'll have accomplished what is needed to set the cheese value for the backend, which in turn means you can now create a site in the Aegir frontend, choose the 'Cheesy site' profile, and expect the install profile to pick that cheese setting up and store it in the new site's database as a variable.</p>
<p>But! While I'm here, let me show you another Aegir hook that allows you to safely inject extra configuration sent from the frontend into the site's Apache vhost config file, persistently, without it being overwritten next time the site is Verified.</p>
<p>We'll invoke an Aegir hook called <code>provision_apache_vhost_config()</code> to insert a SetEnv into the vhost file, just for the hell of it.</p>
<p>Another example where you might want to do this is, say, to set a htpasswd password in the site form, and use the hook to inject mod_auth htpasswd protection for the site (perhaps a demonstration for another time!).</p>
<p>Add this to your cheese.drush.inc:</p>
<div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*<br /> * Implementation of hook_provision_apache_vhost_config()<br /> */<br /></span><span style="color: #007700">function </span><span style="color: #0000BB">cheese_provision_apache_vhost_config</span><span style="color: #007700">(</span><span style="color: #0000BB">$uri</span><span style="color: #007700">, </span><span style="color: #0000BB">$data</span><span style="color: #007700">) {<br />&nbsp; return </span><span style="color: #DD0000">"&nbsp; SetEnv cheese&nbsp; " </span><span style="color: #007700">. </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'cheese'</span><span style="color: #007700">, </span><span style="color: #DD0000">'camembert'</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div>
<p>The return value is inserted into the vhost. You can return multiple lines by wrapping them in an array, or even more elegantly, simply return a path to a template .tpl.php file and do your customisations in the template!</p>
<h3>Part six - check the results!</h3>
<p>If you've done everything up to Part four and five prior to installing a site using the 'Cheesy site' install profile, do so now! </p>
<p>I'm going to create a site called 'cheesy.mig5-forge.net' and set my cheese type to be 'cheddar'.</p>
<div align="center"><img src="../../../../../sites/community.aegirproject.org/files/cheese_site/index.png" /></div>
<p>Now let's check to see those settings in their end result:</p>
<p><strong>The variable in the new site's database</strong></p>
<p>Run this command: <code>drush @yoursite.com vget cheese</code></p>
<p>You should see something like this:</p>
<div align="center"><img src="../../../../../sites/community.aegirproject.org/files/cheese_variable/index.png" /></div>
<p>Great! Now let's look at the Apache vhost file for this site, and we should see a 'SetEnv' parameter injected into the vhost.</p>
<div align="center"><img src="../../../../../sites/community.aegirproject.org/files/cheesy_vhost/index.png" /></div>
<h3>Conclusion</h3>
<p>I know these have been silly examples, but I hope you've taken some important lessons out of all this:</p>
<ul>
<li>How to extend the frontend of Aegir and hook into things like the site form and site node</li>
<li>How to capture data on task 'events' like install and send it to the backend</li>
<li>How to recognise that data in the backend and use it in install profiles or invoke our hooks to inject the data into configuration files</li>
<li>How much I really like cheese</li>
</ul>
<h2>Cheesy tarball</h2>
<p>As mentioned at the start of this article, you can download all these components I've been talking about here: <a href="http://www.migueljacq.com/files/cheesy.tar.gz">cheesy.tar.gz</a>. Remember to read the README.txt</p>
<h2>Further reading</h2>
<p>A great article by hadsie on g.d.o on <a href="http://groups.drupal.org/node/97039">sending data to an install profile via the Signup form</a> covers similar information on capturing data sent to the backend in an install profile.</p>
<p>Steven Jones has published a HTTP mod_auth feature extension for injecting htpasswd password protection on sites over at <a href="https://github.com/computerminds/aegir_http_basic" title="https://github.com/computerminds/aegir_http_basic">https://github.com/computerminds/aegir_http_basic</a></p>
    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-422.html?destination=node%2F75%23comment-form">Login</a> or <a href="../../../../../user/register/index-422.html?destination=node%2F75%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../75/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-108" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../108/index.html">E-Commerce Integration Roadmap</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>Related links:</p>

<ul>
<li>For installation and configuration instructions, see the <a href="../../../../516/index.html">Administrator Manual</a>.</li>
<li>There was some valuable discussion on <a href="http://groups.drupal.org/node/94959">use cases</a> on groups.drupal.org.</li>
</ul>

<p><strong><em>Don't put feature requests in here. Submit them to the <a href="http://drupal.org/project/issues/uc_hosting">uc_hosting</a> or <a href="http://drupal.org/project/issues/hostmaster">hostmaster</a> issue queues instead.</em></strong></p>

<script type="text/javascript">toc_collapse=0;</script><div class="toc" id="toc1">
<div class="toc-title">Table of Contents<span class="toc-toggle-message">&nbsp;</span></div>
<div class="toc-list">
<ol>
	<li class="toc-level-1"><a href="#Drupal_6_uc_hosting_1.0"><span class="toc-number">1. </span>Drupal 6 / uc_hosting 1.0</a>
<ol>
	<li class="toc-level-2"><a href="#Goals"><span class="toc-number">1.1. </span>Goals</a>
<ol>
	<li class="toc-level-3"><a href="#Single_site_products"><span class="toc-number">1.1.1. </span>Single site products</a></li>
	<li class="toc-level-3"><a href="#Multi_site_packages"><span class="toc-number">1.1.2. </span>Multi site packages</a></li>
	<li class="toc-level-3"><a href="#Recurring_payments"><span class="toc-number">1.1.3. </span>Recurring payments</a></li>
</ol>
</li>
	<li class="toc-level-2"><a href="#Nice-to-haves"><span class="toc-number">1.2. </span>Nice-to-haves</a>
<ol>
	<li class="toc-level-3"><a href="#Purchasing_wizard"><span class="toc-number">1.2.1. </span>Purchasing wizard</a></li>
	<li class="toc-level-3"><a href="#Make_it_unnecessary_to_log_single-site_purchasers_into_the_aegir_site"><span class="toc-number">1.2.2. </span>Make it unnecessary to log single-site purchasers into the aegir site</a></li>
	<li class="toc-level-3"><a href="#Deferred_payments"><span class="toc-number">1.2.3. </span>Deferred payments</a></li>
</ol>
</li>
</ol>
</li>
	<li class="toc-level-1"><a href="#Drupal_7_uc_hosting_2.0"><span class="toc-number">2. </span>Drupal 7 / uc_hosting 2.0</a>
<ol>
	<li class="toc-level-2"><a href="#Goals-1"><span class="toc-number">2.1. </span>Goals</a>
<ol>
	<li class="toc-level-3"><a href="#Remote_storefronts"><span class="toc-number">2.1.1. </span>Remote storefronts</a></li>
</ol>
</li>
	<li class="toc-level-2"><a href="#Nice-to-haves-2"><span class="toc-number">2.2. </span>Nice-to-haves</a>
<ol>
	<li class="toc-level-3"><a href="#Desjardins_recurring_payments"><span class="toc-number">2.2.1. </span>Desjardins recurring payments</a></li>
	<li class="toc-level-3"><a href="#Importable_demo_products"><span class="toc-number">2.2.2. </span>Importable demo products</a></li>
	<li class="toc-level-3"><a href="#Simple_procedure_to_deny_user_1_to_certain_clients"><span class="toc-number">2.2.3. </span>Simple procedure to deny user 1 to certain clients</a></li>
</ol>
</li>
</ol>
</li>
	<li class="toc-level-1"><a href="#Wishlist:"><span class="toc-number">3. </span>Wishlist:</a></li>
	<li class="toc-level-1"><a href="#Unanswered_Questions"><span class="toc-number">4. </span>Unanswered Questions</a></li>
</ol>
</div>
</div>

<h1 id="Drupal_6_uc_hosting_1.0">1. Drupal 6 / uc_hosting 1.0</h1>

<p><strong>Aiming for compatibility with:</strong></p>

<ul>
<li>Hostmaster 1.0</li>
<li>Ubercart 2.4</li>
</ul>

<p><strong>Structure:</strong></p>

<ul>
<li><strong>uc_hosting</strong>: This implements shared functions and classes, including the function to create a client based on an ubercart order and product.</li>
<li><strong>uc_hosting_products</strong>: This is where we put the ubercart function calls, attribute generation, etc... This module is intended to be used alone for the "my ubercart is on my aegir site" scenario.</li>
</ul>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Goals">1.1. Goals</h2>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Single_site_products">1.1.1. Single site products</h3>

<p>In.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Multi_site_packages">1.1.2. Multi site packages</h3>

<p>In.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Recurring_payments">1.1.3. Recurring payments</h3>

<p>We need to test the module using uc_recurring.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Nice-to-haves">1.2. Nice-to-haves</h2>

<p>Given where we are at now, this stuff will most likely not make it in until an eventual 1.1 release. The exception being Hadsie's work on "try before you buy".</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Purchasing_wizard">1.2.1. Purchasing wizard</h3>

<p>Stills needs to be developed. The create my site now option is a start and is already in.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Make_it_unnecessary_to_log_single-site_purchasers_into_the_aegir_site">1.2.2. Make it unnecessary to log single-site purchasers into the aegir site</h3>

<p>Needs some testing but should be doable. Maybe just needs a little documentation. I believe Hadsie's work is related to this.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Deferred_payments">1.2.3. Deferred payments</h3>

<p>Ergonlogic is working on this.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h1 id="Drupal_7_uc_hosting_2.0">2. Drupal 7 / uc_hosting 2.0</h1>

<p>We are still unsure about whether to support commerce, ubercart, or both with this module. We will most likely wait until development on the D7 port of aegir starts before beginning this work so we will see then what the landscape looks like.</p>

<p><strong>Aiming for compatibility with:</strong></p>

<ul>
<li>Hostmaster 2.x</li>
<li>Ubercart 3.x, or Commerce 1.x (maybe both?)</li>
</ul>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Goals-1">2.1. Goals</h2>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Remote_storefronts">2.1.1. Remote storefronts</h3>

<p>Hopefully, this will be supported by plans for new xmlrpc methods in the hostmaster signup module.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h2 id="Nice-to-haves-2">2.2. Nice-to-haves</h2>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Desjardins_recurring_payments">2.2.1. Desjardins recurring payments</h3>

<p>This is a seperate module being developed by Koumbit.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Importable_demo_products">2.2.2. Importable demo products</h3>

<p>This would be really great.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h3 id="Simple_procedure_to_deny_user_1_to_certain_clients">2.2.3. Simple procedure to deny user 1 to certain clients</h3>

<p>Ergonlogic has published a module that should make this possible: <a href="http://drupal.org/project/hosting_profile_roles" title="http://drupal.org/project/hosting_profile_roles">http://drupal.org/project/hosting_profile_roles</a>.</p>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h1 id="Wishlist:">3. Wishlist:</h1>

<ul>
<li>A decent ubercart import function (see <a href="http://www.sthlmconnection.se/tips-and-tweaks/exportable-configuration-ctools-revisited">this</a> and <a href="http://stellapower.net/content/using-chaos-tools-module-create-exportables">this</a>... <a href="http://drupal.org/node/349408">this</a> and maybe <a href="http://drupal.org/node/590956">this</a>)</li>
</ul>

<div class="toc-back-to-top"><a href="#toc">Back to top</a></div><h1 id="Unanswered_Questions">4. Unanswered Questions</h1>

<ol>
<li>Will the Drupal 7 version use Ubercart or Commerce? Both? Neither?</li>
<li>How and when will people be billed? And what degree of control will uc_hosting offer over that?</li>
<li>Aegir has clients &amp; UC has clients. How are they related/distinct? How do we keep this clear to users/admins?</li>
</ol><div class="toc-back-to-top"><a href="#toc">Back to top</a></div><script type="text/javascript">toc_scroll_back_to_top = 1;</script>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-423.html?destination=node%2F108%23comment-form">Login</a> or <a href="../../../../../user/register/index-423.html?destination=node%2F108%23comment-form">register</a> to post comments</span></li>
<li class="talk_comments last"><a href="../../../../108/talk/index.html" title="Jump to the first comment of this posting.">Talk</a></li>
</ul></div>
  </div>




<div  id="node-707" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../creating-product-features-using-uchosting-1x/index.html">Creating product features using uc_hosting 1.x</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_27 first last"><a href="../../../../../category/level/developer/index.html" rel="tag" title="This level is generally for users interested in further developing the Aegir system itself, or extending it with contributed modules.">Developer</a></li>
</ul></div><p>This document assumes you want to implement a product feature using uc_hosting's database tables and exiting infrastructure. For a more complete example of an Ubercart 2.x product feature implementation, check out uc_file in the Ubercart core.</p>

<h2>The Basics</h2>

<p>Any module implementing a uc_hosting feature should include both uc_hosting and uc_hosting_products as dependencies. Include these lines in your .info file:</p>

<pre><code>dependencies[] = uc_hosting
dependencies[] = uc_hosting_products
</code></pre>

<h2>Declaring product features to Ubercart 2.x</h2>

<p>The first step is to implement Ubercart's hook_product_feature. Here is an example implementation for the platform access feature in uc_hosting_products:</p>

<pre><code>/**
 * Implementation of hook_product_feature().
 */
function uc_hosting_products_product_feature () {
  $features = array();

  // Set the feature for the platforms
  $features[] = array(
    'id' =&gt; 'hosting_platform',
    'title' =&gt; t('Access to a platform'),
    'callback' =&gt; 'uc_hosting_products_platform_form',
    'delete' =&gt; 'uc_hosting_products_feature_delete',
    'settings' =&gt; 'uc_hosting_products_platform_settings',
  );

  return $features;
}
</code></pre>

<p>An implementation of hook_product_feature returns a numerical array of associative arrays. Feature arrays must include five keys:</p>

<ul>
<li><strong>id</strong> will be used to identify your feature at the database level, in the uc_product_features table, and also in urls. Think of it as the type of your feature.</li>
<li><strong>title</strong> is the name of your feature as it will be displayed to site admins.</li>
<li><strong>callback</strong> will be used to create and modify instances of your feature attached to specific products. This callback should return a drupal form passed through the uc_product_feature_form function.</li>
<li><strong>delete</strong> is a simple function called on the removal of a feature instance from a product.</li>
<li><strong>settings</strong> is a callback that provides additional settings for the feature, and is not used presently in any uc_hosting product feature.</li>
</ul>

<p>Of note is that, unlike Drupal's core hook_menu and hook_theme, hook_product_feature does not include a 'file' key. uc_hosting works around this by using include_once at the beginning of the hook_product_feature implementation.</p>

<p>If you wish to use uc_hosting's shared feature functions, make sure to include the file "products/inc/uc_hosting_products.feature_shared.inc" (path relative to the uc_hosting root) at the beginning of your implementation of hook_product_feature.</p>

<h2>The callback form</h2>

<p>This form is called everytime someone adds a product feature to a product. It allows you to set any options for your feature that should be delivered on a per-product basis. Lets take a look at this function for the platform access feature:</p>

<pre><code>/**
 * Callback to add the platform form on the product feature page
 */
function uc_hosting_products_platform_form ($form_state, $node, $feature) {
  $form = array();

  // Get default values and shared form elements for all uc_hosting features
  $hosting_product = _uc_hosting_products_feature_fetch_product($feature);
  if (empty($feature)) {
    $feature = array('id' =&gt; 'hosting_platform');
  }
</code></pre>

<p>_<strong>uc_hosting_products_feature_fetch_product</strong> attempts to retrieve existing values for this instance of a product feature from the database.</p>

<pre><code>  _uc_hosting_products_feature_shared_elements(&amp;$form, $node, $feature, $hosting_product);
</code></pre>

<p>_<strong>uc_hosting_products_feature_shared_elements</strong> declares some form elements that either uc_hosting or Ubercart itself depend on to provide the product feature functionality.</p>

<pre><code>  // @see _hosting_get_platforms()
  if (user_access('view locked platforms')) {
    $platforms = _hosting_get_platforms();
  }
  else if (user_access('view platform')) {
    $platforms = _hosting_get_enabled_platforms();
  }
  else {
    $platforms = array();
    drupal_set_message('You must have permission to access platforms to enable this feature.', 'warning');
  }

  $form['platform'] = array(
    '#type' =&gt; 'select',
    '#title' =&gt; t('Platform'),
    '#description' =&gt; t('Select the platform to associate with this product.'),
    '#default_value' =&gt; $hosting_product-&gt;value,
    '#options' =&gt; $platforms,
    '#required' =&gt; TRUE,
  );
</code></pre>

<p>This code block generates a list of platforms to allow the admin to select which platform to bind to his product. This code is specific to the platform access implementation - this is where you should include your own form elements relevant to your feature.</p>

<pre><code>  $form['#validate'][] = 'uc_hosting_products_single_feature_validate';
</code></pre>

<p>For many implementations, <strong>uc_hosting_products_single_feature_validate</strong> ensures that a given uc_hosting product feature can only be enabled once on any given product. All of the exising uc_hosting_products features make use of this function.</p>

<pre><code>  return uc_product_feature_form ($form);
}
</code></pre>

<p>Finally, <strong>uc_product_feature_form</strong> adds some required form elements from Ubercart.</p>

<p>You also need to make sure to code a submit function for your callback, of the form callback_submit:</p>

<pre><code>/**
 * Save the platform feature settings.
 */
function uc_hosting_products_platform_form_submit($form, &amp;$form_state) {
  $hosting_product = array(
    'pfid' =&gt; $form_state['values']['pfid'],
    'model' =&gt; $form_state['values']['model'],
    'type' =&gt; 'platform',
    'value' =&gt; $form_state['values']['platform'],
  );

  $platform_node = node_load($hosting_product['value']);
  $description = t('&lt;strong&gt;SKU:&lt;/strong&gt; !sku&lt;br /&gt;', array('!sku' =&gt; empty($hosting_product['model']) ? 'Any' : $hosting_product['model']));
  $description .= t('&lt;strong&gt;Platform:&lt;/strong&gt; !platform', array('!platform' =&gt; $platform_node-&gt;title));

  $data = array(
    'pfid' =&gt; $form_state['values']['pfid'],
    'nid' =&gt; $form_state['values']['nid'],
    'fid' =&gt; 'hosting_platform',
    'description' =&gt; $description,
  );

  $form_state['redirect'] = uc_product_feature_save($data);
</code></pre>

<p>We manually save the product_feature to ubercart's database tables here. This is so that we can then retrieve the index of the entry in the uc_product_features table for later use in our own data.</p>

<pre><code>  // Insert or update uc_hosting_products table
  if (empty($hosting_product['pfid'])) {
    $hosting_product['pfid'] = db_last_insert_id('uc_product_features', 'pfid');
  }

  $existing_prod = db_fetch_object(db_query("SELECT hpid, data FROM {uc_hosting_products} WHERE pfid = %d LIMIT 1", $hosting_product['pfid']));

  $key = NULL;
  if ($existing_prod-&gt;hpid) {
    $key = 'hpid';
    $hosting_product['hpid'] = $existing_prod-&gt;hpid;
    $hosting_product['data'] = unserialize($existing_prod-&gt;data);
    $hosting_product['data']['platform'] = $hosting_product['value'];
  }
  // If necessary build a data array from scratch
  else {
    $hosting_product['data'] = array(
      'platform' =&gt; $hosting_product['value'],
    );
  }

  $hosting_product['data'] = serialize($hosting_product['data']);

  drupal_write_record('uc_hosting_products', $hosting_product, $key);
}
</code></pre>

<p>Note that the uc_hosting_products table has both an integer column <strong>value</strong>, and a longtext column <strong>data</strong> for storing serialized information about the feature.</p>

<h2>Taking action in Aegir based on product features</h2>

<p>uc_hosting assumes that most purchases made via Ubercart are intended to be expressed as changes to an Aegir client node. So it provides some code to help you create new clients or modify exiting ones when an order containing your feature is made. Any other actions needed to make your feature work you will need to implement yourself. This will involve implementing the Ubercart hook, <a href="http://api.ubercart.org/api/function/hook_order/2">hook_order</a> and your own callback function.</p>

<p>Lets start by taking a look at uc_hosting_products own implementation of hook_order:</p>

<pre><code>/**
 * Implementation of hook_order
 *
 * Actions t$form_state['values']['create_later']o take on order changes involving an aegir product
 *
 * @param $op string
 *   Provided by ubercart on invocation
 * @param &amp;$arg1
 *   Different data depending on the op
 * @param $arg2
 *   Different data depending on the op
 */
function uc_hosting_products_order ($op, &amp;$arg1, $arg2) {
  switch ($op) {
    case 'update':
      if ($arg2 == 'completed') {
        foreach ($arg1-&gt;products as $product) {
          if (_uc_hosting_products_has_feature ($product)) {
            // Make the changes necessary to the hosting client
            $client = uc_hosting_update_client($arg1, $product, 'uc_hosting_products_client_update');
          }
        }
      }
      break;
    default:
      break;
  }
}
</code></pre>

<p>_<strong>uc_hosting_products_has_feature</strong> is defined in uc_hosting_products.module, and provides some simple logic to detect uc_hosting product features. Rather than use this function, you will most likely want to define your own conditions.</p>

<p><strong>uc_hosting_update_client</strong> does the work of matching up an incoming ubercart order to an existing Aegir client, if possible. If not possible, it creates a new client node. It then calls the function provided as a third argument, in this case uc_hosting_products_client_update, and passes to that function the affected client node, as well as the product and order objects from Ubercart.</p>

<p>This callback function is the place to take actions in Aegir or pass commands. Take a look at uc_hosting_products for a fully fleshed out example.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-210.html?destination=node%2F707%23comment-form">Login</a> or <a href="../../../../../user/register/index-210.html?destination=node%2F707%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-210.html?destination=node%2F707%23comment-form">Login</a> or <a href="../../../../../user/register/index-210.html?destination=node%2F707%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-2825" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/contrib/class-auto-loading/index.html">Class auto-loading</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <div class='field terms clear-block'><span class='field-label-inline-first'>Tagged:</span> <ul class="links inline"><li class="taxonomy_term_27 first last"><a href="../../../../../category/level/developer/index.html" rel="tag" title="This level is generally for users interested in further developing the Aegir system itself, or extending it with contributed modules.">Developer</a></li>
</ul></div><p>Provision has been refactored in 6.x-2.x to use class auto-loading. This simplifies use of classes, as it obviates the need to explicitly include the files in which the class and it's parent classes are defined. In addition, it standardizes the placement of class definitions within a hierarchical file-system structure and will make name-spacing simpler if/when we begin to adopt Symfony components.</p>

<p>While not strictly required in contributed modules, it is highly encouraged. If you maintain a contributed Provision extension, some re-factoring will be required to support class auto-loading.</p>

<p>First off, you'll need to add a registration function that will enable Provision to autoload your extensions classes. Here's an example from provision_civicrm:</p>

<p><div class="codeblock"><code>/**<br /> * Register our directory as a place to find Provision classes.<br /> *<br /> * This allows Provision to autoload our classes, so that we don&#039;t need to<br /> * specifically include the files before we use the class.<br /> */<br />function civicrm_provision_register_autoload() {<br />&nbsp; static $loaded = FALSE;<br />&nbsp; if (!$loaded) {<br />&nbsp;&nbsp;&nbsp; $loaded = TRUE;<br />&nbsp;&nbsp;&nbsp; $list = drush_commandfile_list();<br />&nbsp;&nbsp;&nbsp; $provision_dir = dirname($list[&#039;provision&#039;]);<br />&nbsp;&nbsp;&nbsp; include_once($provision_dir . &#039;/provision.inc&#039;);<br />&nbsp;&nbsp;&nbsp; include_once($provision_dir . &#039;/provision.service.inc&#039;);<br />&nbsp;&nbsp;&nbsp; provision_autoload_register_prefix(&#039;Provision_&#039;, dirname(__FILE__));<br />&nbsp; }<br />}</code></div></p>

<p>Next, your extension will need to call your new function in a hook_drush_init(), so that it is run as early as possible during a Drush bootstrap.</p>

<p><div class="codeblock"><code>/**<br /> * Implements hook_drush_init().<br /> */<br />function provision_civicrm_drush_init() {<br />&nbsp; // Register our service classes for autoloading.<br />&nbsp; civicrm_provision_register_autoload();<br />&nbsp; ...</code></div></p>

<p>Finally, you can move your class definitions into the proper file-system structure. In provision_civicrm, we defined a new (stub) service to allow saving data from the front-end into a site context (entity/alias). So, we created a file at Provision/Service/civicrm.php that included the class definition:</p>

<p><div class="codeblock"><code>/<strong><br /> * The civicrm service base class.<br /> */<br />class Provision_Service_civicrm extends Provision_Service {<br />&nbsp; public $service = &#039;civicrm&#039;;<br /><br />&nbsp; /</strong><br />&nbsp;&nbsp; * Add the civicrm_version property to the site context.<br />&nbsp;&nbsp; */<br />&nbsp; static function subscribe_site($context) {<br />&nbsp;&nbsp;&nbsp; $context-&gt;setProperty(&#039;civicrm_version&#039;);<br />&nbsp; }<br />}</code></div></p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-211.html?destination=node%2F2825%23comment-form">Login</a> or <a href="../../../../../user/register/index-211.html?destination=node%2F2825%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-211.html?destination=node%2F2825%23comment-form">Login</a> or <a href="../../../../../user/register/index-211.html?destination=node%2F2825%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-879" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../contrib/customizing-platform-templates/index.html">Customizing Platform Templates</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>Non-standard Aegir installs may require adjustments to the default configurations for a platform that are defined by Aegir during the creation of a platform. These templates can be found in /home/aegir/.drush/provision.</p>

<p>Editing the actual templates prevents Aegir from overwriting your customizations when the verify task is run on an live platform.</p>

<p>Below are examples of customizations made to non-standard Aegir installs</p>

<h2>Running an Aegir platform on a unix socket for php-fpm on Nginx</h2>

<p>First let's find out where provision has the default config templates for our platfom.
<div class="codeblock"><code>[root@host]cd /home/aegir/.drush; grep -nir &quot;fastcgi_pass&quot; --exclude=&#42;.svn&#42; *<br />provision/http/nginx/nginx_advanced_include.conf:227:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_advanced_include.conf:360:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_simple_include.conf:213:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_simple_include.conf:346:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000</code></div>
We can see that the config templates for Nginx direct all php requests to port 9000 on the localhost I.P. Let's change that to a unix socket (which avoids the slight delay associated with tcp connections).
After commenting out those lines and adding our custom lines which will use a unix socket instead of a tcp port, we get..
<div class="codeblock"><code>provision/http/nginx/nginx_advanced_include.conf:227:&nbsp;&nbsp;&nbsp; #&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_advanced_include.conf:228:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;<br />provision/http/nginx/nginx_advanced_include.conf:361:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_advanced_include.conf:362:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;<br />provision/http/nginx/nginx_simple_include.conf:213:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm listening on port 9000<br />provision/http/nginx/nginx_simple_include.conf:214: fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;<br />provision/http/nginx/nginx_simple_include.conf:347:#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass&nbsp;&nbsp; 127.0.0.1:9000; ### php-fpm lis#tening on port 9000<br />provision/http/nginx/nginx_simple_include.conf:348:&nbsp;&nbsp;&nbsp;&nbsp; fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;</code></div></p>

<p>Remember to do the same to your platform config files in /home/aegir/config/includes. Next time you verify your platform your customizations will remain after verification.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-212.html?destination=node%2F879%23comment-form">Login</a> or <a href="../../../../../user/register/index-212.html?destination=node%2F879%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-212.html?destination=node%2F879%23comment-form">Login</a> or <a href="../../../../../user/register/index-212.html?destination=node%2F879%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>




<div  id="node-935" class="node node-book clear-block">
  
      <h2 class='node-title'>
            <a href="../../../../../content/contrib/passing-values-site-drushrcphp-file-during-migrations/index.html">Passing values into the site drushrc.php file during migrations</a>
    </h2>
  
      <div class='node-content clear-block prose'>
      <p>It's possible rely to on manipulating the drush context for certain tasks and using hook_post_command to make use of that data. In this case, I wanted to save values to the site's drushrc.php file.</p>

<p>Add the following code to <code>hook_post_provision_verify</code>:</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">if (</span><span style="color: #0000BB">d</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">type </span><span style="color: #007700">== </span><span style="color: #DD0000">'site'</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">$val </span><span style="color: #007700">= </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'my_custom_option'</span><span style="color: #007700">);<br />&nbsp; </span><span style="color: #0000BB">drush_set_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'my_custom_option'</span><span style="color: #007700">, </span><span style="color: #0000BB">$val</span><span style="color: #007700">, </span><span style="color: #DD0000">'site'</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>This makes sure that <code>my_custom_option</code> perpetuates through these potentially destructive operations. Since it is provision-verify that writes the drushrc.php file for the site, drush options set in the site context during <code>hook_post_provision_verify</code> will be saved.</p>

<p>The final step is to make sure the verify hook is run with the appropriate options at the end of my migrate task, so add this to <code>hook_post_provision_migrate</code>.</p>

<p><div class="codeblock"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">if (</span><span style="color: #0000BB">d</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">type </span><span style="color: #007700">== </span><span style="color: #DD0000">'site'</span><span style="color: #007700">) {<br />&nbsp; </span><span style="color: #0000BB">$options </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'my_custom_option' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'my_custom_option'</span><span style="color: #007700">));<br />&nbsp; </span><span style="color: #0000BB">$target </span><span style="color: #007700">= </span><span style="color: #0000BB">drush_get_option</span><span style="color: #007700">(</span><span style="color: #DD0000">'target_name'</span><span style="color: #007700">);<br />&nbsp; </span><span style="color: #0000BB">provision_backend_invoke</span><span style="color: #007700">(</span><span style="color: #0000BB">$target</span><span style="color: #007700">, </span><span style="color: #DD0000">'provision-verify'</span><span style="color: #007700">, array(), </span><span style="color: #0000BB">$options</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span></span></code></div></p>

<p>I got this idea from looking at the <code>drush_provision_drupal_provision_migrate function</code> in <code>platform/migrate.provision.inc</code>.</p>

<p>I used this approach to create a <a href="http://drupal.org/node/1282200#comment-5173768">patch for provision_civicrm</a></p>

<p>This was originally <a href="http://drupal.org/node/955018#comment-5171904">documented in the provision issue queue</a>.</p>    </div>
  
      <div class='node-links clear-block'><ul class="links inline"><li class="comment_forbidden first"><span><a href="../../../../../user/login/index-213.html?destination=node%2F935%23comment-form">Login</a> or <a href="../../../../../user/register/index-213.html?destination=node%2F935%23comment-form">register</a> to post comments</span></li>
<li class="talk_forbidden last"><span><a href="../../../../../user/login/index-213.html?destination=node%2F935%23comment-form">Login</a> or <a href="../../../../../user/register/index-213.html?destination=node%2F935%23comment-form">register</a> to post comments</span></li>
</ul></div>
  </div>



    </div>
      </div>
</body>


<!-- Mirrored from community.aegirproject.org/node/33/revisions/1851/view?print&book_recurse by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 29 Jul 2015 18:20:39 GMT -->
</html>
